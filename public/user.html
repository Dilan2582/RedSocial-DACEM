<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>DACEM – Inicio</title>

  <!-- Fuente -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">

  <!-- Estilos -->
  <link rel="stylesheet" href="css/user.css">
  <link rel="stylesheet" href="css/transformations.css">
  <link rel="stylesheet" href="css/composer-filters.css">

  <!-- Iconos Lucide -->
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>

  <!-- Tema inicial para evitar FOUC -->
  <script>
    (function () {
      var saved = localStorage.getItem('theme');
      if(!saved){ saved = matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light'; }
      document.documentElement.setAttribute('data-theme', saved);
    })();
  </script>

  <!-- Mejora visual solo para el modal Compartir (coincide con tu estética) -->
  <style>
    /* Búsqueda estilo "Mensajes" */
    .share-search{
      width:100%;
      padding:10px 16px;
      border:1px solid var(--line);
      border-radius:999px;
      background:var(--panel);
      color:var(--text);
      outline:none;
      transition:all .15s ease;
    }
    .share-search::placeholder{ color:var(--muted) }
    .share-search:focus{
      border-color:var(--primary);
      box-shadow:0 0 0 3px var(--ring);
      background:var(--panel);
    }
    /* Grid de destinatarios con hover tipo "Personas sugeridas" */
    .share-grid{
      display:grid;
      grid-template-columns:repeat(4,1fr);
      gap:14px;
      max-height:50vh;
      overflow:auto;
      padding:2px;
    }
    .share-pick{
      border:1px solid var(--line);
      background:var(--panel);
      border-radius:12px;
      padding:10px;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:8px;
      cursor:pointer;
      position:relative;
      transition:.15s ease;
      color:var(--text);
    }
    .share-pick:hover{
      background:rgba(124,92,252,.06);
      border-color:rgba(124,92,252,.25);
      box-shadow:0 4px 12px rgba(124,92,252,.1);
    }
    .share-mark{
      position:absolute;right:8px;top:8px;width:18px;height:18px;border-radius:50%;
      border:2px solid var(--line);display:grid;place-items:center;background:transparent;
    }
    .share-mark[data-on="true"]{ background:var(--primary) }
    .share-name{
      font-weight:700;font-size:12px;max-width:120px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap
    }
    .lb-head strong{ font-weight:800 }
  </style>
</head>

<body>
  <!-- Topbar -->
  <header class="topbar">
    <div class="topbar-inner">
      <div class="brand">
        <span class="logo-badge"><img src="img/Dacem.png" alt="DACEM logo"></span>
        <span>DACEM</span>
      </div>
      <div style="margin-left:auto" class="topbar-actions">
        <button id="themeToggle" class="btn ghost small" title="Cambiar tema">
          <i class="nav-ico" data-lucide="moon"></i> <span id="themeTxt">Modo oscuro</span>
        </button>
        <button id="logoutBtnTop" class="btn danger small">
          <i class="nav-ico" data-lucide="log-out"></i> Cerrar sesión
        </button>
      </div>
    </div>
  </header>

  <div class="wrap">
    <div class="layout">
      <!-- Sidebar -->
      <aside class="sidebar card">
        <nav class="nav">
          <a class="nav-item active" href="user.html">
            <i class="nav-ico" data-lucide="home"></i> Inicio
          </a>
          <a class="nav-item" href="notifications.html">
            <i class="nav-ico" data-lucide="heart"></i> Notificaciones
            <span class="unread-badge" id="notificationsBadge" style="display:none"></span>
          </a>
          <a class="nav-item" href="messages.html">
            <i class="nav-ico" data-lucide="message-circle"></i> Mensajes
            <span class="unread-badge" id="unreadBadge" style="display:none"></span>
          </a>
          <a class="nav-item" href="profile.html">
            <i class="nav-ico" data-lucide="user-2"></i> Mi perfil
          </a>
        </nav>
      </aside>

      <!-- Centro -->
      <main class="main">
        <section class="card composer" id="composer">
          <div class="cmp-row">
            <img id="cmpAvatar" class="cmp-avatar" alt="yo">
            <textarea id="cmpText" class="cmp-input" rows="2" placeholder="¿Qué estás pensando? (opcional)"></textarea>
          </div>

          <div id="cmpPreview" class="cmp-preview" style="display:none">
            <img id="cmpPreviewImg" alt="preview">
            <button id="cmpRemoveImg" class="btn ghost small">
              <i class="nav-ico" data-lucide="x"></i> Quitar
            </button>
          </div>

          <div class="cmp-tools">
            <input id="cmpFile" type="file" accept="image/*,video/mp4,video/quicktime,video/x-msvideo" hidden>
            <button id="cmpPick" class="btn ghost small">
              <i class="nav-ico" data-lucide="image"></i> Imagen/Video
            </button>
            <div class="spacer"></div>
            <button id="cmpPost" class="btn primary">
              <i class="nav-ico" data-lucide="send"></i> Publicar
            </button>
          </div>
          <div class="cmp-msg" id="cmpMsg"></div>
        </section>

        <!-- Feed -->
        <section class="feed" id="feed"></section>
        <div class="card" style="text-align:center;padding:20px;margin-top:8px">
          <button id="btnMore" class="btn primary">Cargar más</button>
        </div>
      </main>

      <!-- Aside -->
      <aside class="aside">
        <div class="card" style="padding:18px">
          <h3 style="margin:0 0 16px;font-size:1rem;color:var(--text);font-weight:800">Personas sugeridas</h3>
          <div id="peopleList" class="people-list"></div>
        </div>
      </aside>
    </div>
  </div>

  <!-- Lightbox (ver publicación) -->
  <div class="lightbox" id="lightbox" aria-hidden="true">
    <div class="lb-content" role="dialog" aria-modal="true" aria-label="Publicación">
      <button class="btn ghost small lb-close" id="lbClose">
        <i class="nav-ico" data-lucide="x"></i>
      </button>
      <div class="lb-media"><img id="lbImg" alt=""></div>
      <aside class="lb-side">
        <header class="lb-head">
          <img id="lbAva" class="lb-ava" alt="">
          <div style="flex:1">
            <div id="lbName" style="font-weight:700"></div>
            <div id="lbUser" class="muted" style="font-size:12px"></div>
          </div>
          <!-- botón reconocimiento facial -->
          <button id="lbFaceRecognition" class="btn ghost small" title="Analizar rostro">
            <i data-lucide="smile"></i>
          </button>
          <!-- botón compartir dentro del modal -->
          <button id="lbShare" class="btn ghost small" title="Compartir">
            <i data-lucide="send"></i>
          </button>
        </header>
        <div class="lb-body" id="lbComments"></div>

        <div class="lb-actions">
          <button id="lbLike" class="btn-icon" aria-pressed="false" title="Me gusta">
            <i data-lucide="heart"></i>
          </button>
          <button id="lbComment" class="btn-icon" title="Comentar">
            <i data-lucide="message-circle"></i>
          </button>
          <div class="spacer"></div>
          <div class="post-counts">
            <span id="lbLikes">0</span> · <span id="lbCommentsCount">0</span>
          </div>
        </div>

        <div class="lb-input">
          <input id="lbInp" placeholder="Añade un comentario…">
          <button id="lbSend" class="btn"><i class="nav-ico" data-lucide="send"></i></button>
        </div>
      </aside>
    </div>
  </div>

  <!-- Modal Compartir publicación -->
  <div class="lightbox" id="shareModal" aria-hidden="true">
    <div class="lb-content" role="dialog" aria-modal="true" aria-label="Compartir" style="grid-template-columns: min(90vw,560px); max-width:560px">
      <div class="lb-side" style="display:flex;flex-direction:column">
        <header class="lb-head" style="gap:8px">
          <strong style="font-size:16px">Compartir</strong>
          <div class="spacer"></div>
          <button id="shareClose" class="btn ghost small"><i data-lucide="x"></i></button>
        </header>

        <div style="padding:12px; border-bottom:1px solid var(--line)">
          <!-- misma estética que la búsqueda de mensajes -->
          <input id="shareSearch" class="share-search" placeholder="Buscar conversación o usuario…"/>
        </div>

        <div id="shareList" class="lb-body share-grid"></div>

        <div style="padding:12px; border-top:1px solid var(--line); display:grid; gap:8px">
          <textarea id="shareMsg" rows="2" class="input" placeholder="Escribe un mensaje (opcional)"></textarea>
          <button id="shareSend" class="btn primary" disabled>Enviar</button>
          <div id="shareInfo" class="muted" style="font-size:12px"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- ===== JS ===== -->
  <script>
    /* ===== Tema ===== */
    const themeBtn = document.getElementById('themeToggle');
    const themeTxt = document.getElementById('themeTxt');
    function applyTheme(t){
      document.documentElement.setAttribute('data-theme', t);
      localStorage.setItem('theme', t);
      const icon = themeBtn?.querySelector('[data-lucide]');
      if(icon) icon.setAttribute('data-lucide', t === 'dark' ? 'sun' : 'moon');
      themeTxt.textContent = t === 'dark' ? 'Modo claro' : 'Modo oscuro';
      if (window.lucide) lucide.createIcons();
    }
    themeBtn?.addEventListener('click', ()=>{
      const current = (document.documentElement.getAttribute('data-theme')||'dark');
      applyTheme(current==='dark' ? 'light' : 'dark');
    });
    (function(){ const t=document.documentElement.getAttribute('data-theme'); themeTxt.textContent = t==='dark' ? 'Modo claro' : 'Modo oscuro'; })();

    /* ===== Helpers / API ===== */
    const API = (p)=>`${location.origin}/api${p}`;
    const token = localStorage.getItem('token');
    if(!token){ location.replace('index.html'); }
    const H  = { 'Authorization':`Bearer ${token}` };
    const JH = { ...H, 'Content-Type':'application/json' };
    const $  = s => document.querySelector(s);

    function displayName(u){ return u?.name || `${u?.firstName||''} ${u?.lastName||''}`.trim() || (u?.nickname || 'Usuario'); }
    function abs(url){ return url?.startsWith('http') ? url : `${location.origin}${url?.startsWith('/')?url:'/'+url}`; }
    function resolveAvatar(u){
      if(u?.avatar) return abs(u.avatar);
      const seed = encodeURIComponent(displayName(u) || u?.nickname || 'U');
      return `https://api.dicebear.com/8.x/initials/svg?seed=${seed}&radius=50&scale=110&fontWeight=700`;
    }
    function timeAgo(iso){ try{ const d=new Date(iso); const s=(Date.now()-d)/1000; if(s<60) return 'ahora'; if(s<3600) return Math.floor(s/60)+' min'; if(s<86400) return Math.floor(s/3600)+' h'; return Math.floor(s/86400)+' d'; }catch{ return ''; } }

    /* ===== Sugerencias / follow ===== */
    async function toggleFollow(id, isFollowing){
      try{
        const r = await fetch(API(`/follow/toggle/${id}`), { method:'POST', headers:H });
        if (r.status !== 404){ const d = await r.json(); return !!d.ok; }
      }catch{}
      if (!isFollowing){ const r = await fetch(API(`/follow/${id}`), { method:'POST', headers:H }); const d = await r.json(); return !!d.ok; }
      else { const r = await fetch(API(`/follow/${id}`), { method:'DELETE', headers:H }); const d = await r.json(); return !!d.ok; }
    }

    function personRow(u){
      const el = document.createElement('div');
      el.className = 'person-row';
      el.innerHTML = `
        <div class="p-avatar"><img src="${resolveAvatar(u)}" alt=""></div>
        <div class="p-info">
          <div class="p-name" title="${displayName(u)}">${displayName(u)}</div>
          <div class="p-user" title="@${u.nickname || 'usuario'}">@${u.nickname || 'usuario'}</div>
        </div>
        <div class="p-actions">
          <a class="btn ghost small" href="profile.html?id=${u._id || u.id}" style="text-decoration:none">Ver perfil</a>
          <button class="btn small ${u.isFollowing ? 'ghost' : 'primary'}">
            ${u.isFollowing ? 'Siguiendo' : 'Seguir'}
          </button>
        </div>`;
      const btn = el.querySelector('button');
      btn.onclick = async () => {
        btn.disabled = true;
        const ok = await toggleFollow(u._id || u.id, !!u.isFollowing);
        if (ok){
          u.isFollowing = !u.isFollowing;
          btn.textContent = u.isFollowing ? 'Siguiendo' : 'Seguir';
          btn.className = `btn small ${u.isFollowing ? 'ghost' : 'primary'}`;
        }
        btn.disabled = false;
      };
      return el;
    }

    async function fetchSuggestedUsers(){
      const endpoints = ['/user/others','/users/others','/users/suggested','/user/suggested'];
      for (const ep of endpoints){
        try{
          const r = await fetch(API(ep), { headers:H });
          if (!r.ok) continue;
          const d = await r.json().catch(()=>null);
          const list = d?.users || d?.data || [];
          if (Array.isArray(list) && list.length) return list;
        }catch{}
      }
      return [];
    }

    async function loadOthers(){
      const list = document.getElementById('peopleList');
      if (!list) return;
      list.innerHTML = '<div class="muted">Cargando…</div>';
      const users = await fetchSuggestedUsers();
      if (!users.length){ list.innerHTML = '<div class="muted">No hay sugerencias por ahora.</div>'; return; }
      list.innerHTML = '';
      users.forEach(u => {
        u._id = u._id || u.id;
        u.isFollowing = !!(u.isFollowing || u.following || u.viewerFollows);
        list.appendChild(personRow(u));
      });
    }

    /* ===== Yo / Feed ===== */
    let me = null; const userCache = new Map();
    async function loadMe(){
      const r = await fetch(API('/user/me'), { headers:H });
      const d = await r.json();
      if(!d.ok){ localStorage.clear(); return location.replace('index.html'); }
      me = d.user; userCache.set(me._id, me);
      document.querySelector('#cmpAvatar').src = resolveAvatar(me);
    }

    const cmp = {
      fileEl: $('#cmpFile'), pick: $('#cmpPick'), imgBox: $('#cmpPreview'),
      img: $('#cmpPreviewImg'), rm: $('#cmpRemoveImg'), txt: $('#cmpText'),
      post: $('#cmpPost'), msg: $('#cmpMsg')
    };
    let selectedFile = null;
    cmp.pick.onclick = ()=> cmp.fileEl.click();
    cmp.fileEl.onchange = e=>{
      const f = e.target.files?.[0];
      if(!f){ selectedFile=null; cmp.imgBox.style.display='none'; return; }
      selectedFile = f; cmp.img.src = URL.createObjectURL(f); cmp.imgBox.style.display='flex';
    };
    cmp.rm.onclick = ()=>{ selectedFile=null; cmp.fileEl.value=''; cmp.imgBox.style.display='none'; cmp.img.removeAttribute('src'); };

    async function publish(){
      cmp.post.disabled = true; cmp.msg.textContent = 'Publicando...';
      try{
        const fd = new FormData();
        
        // Usar imagen filtrada si existe, sino usar la seleccionada
        if (selectedFile) {
          // Si hay filtros activados, usar la imagen filtrada
          if (window.composerFilters && window.composerFilters.currentImage) {
            const filteredBlob = await window.composerFilters.getFilteredImageBlob();
            fd.append('image', filteredBlob, 'filtered-image.jpg');
          } else {
            fd.append('image', selectedFile);
          }
        }
        
        if (cmp.txt.value.trim()) fd.append('caption', cmp.txt.value.trim());
        const r = await fetch(API('/posts'), { method:'POST', headers:H, body:fd });
        const d = await r.json();
        if(!d.ok) throw new Error(d.message||'Error');
        prependPost(d.post);
        cmp.msg.textContent = '¡Publicado!'; cmp.txt.value=''; cmp.rm.click();
        setTimeout(()=>cmp.msg.textContent='', 1200);
      }catch{ cmp.msg.textContent = 'No se pudo publicar'; }
      finally{ cmp.post.disabled=false; }
    }
    cmp.post.onclick = publish;

    const feedEl = document.querySelector('#feed');
    const refreshIcons = () => { try { if (window.lucide) window.lucide.createIcons(); } catch(_){} };

    let nextCursor = null, loading = false;

    function ratioClass(w,h){ const r=w/h; if(r<0.95) return 'ratio-portrait'; if(r>1.6) return 'ratio-landscape'; return 'ratio-square'; }

    async function getUserCached(id){
      if (userCache.has(id)) return userCache.get(id);
      const r = await fetch(API(`/user/${id}/public`), { headers:H });
      const d = await r.json(); if (d.ok){ userCache.set(id,d.user); return d.user; }
      return { nickname:'usuario', firstName:'', lastName:'', avatar:null };
    }

    // Función para analizar rostros en la publicación
    async function analyzeFaceInPost(post) {
      const btn = lbFaceRecognitionBtn;
      const originalText = btn.innerHTML;
      
      btn.disabled = true;
      btn.innerHTML = '<i data-lucide="loader"></i>';
      if (window.lucide) lucide.createIcons();

      try {
        const imageUrl = post.media.t1 || post.media.original || post.media.thumb;
        
        const res = await fetch(API('/face-recognition/analyze'), {
          method: 'POST',
          headers: { ...H, 'Content-Type': 'application/json' },
          body: JSON.stringify({ imageUrl })
        });

        const data = await res.json();

        if (!data.ok) {
          alert('Error: ' + data.message);
          btn.disabled = false;
          btn.innerHTML = originalText;
          return;
        }

        if (data.facesDetected === 0) {
          alert('No se detectaron rostros en la imagen');
          btn.disabled = false;
          btn.innerHTML = originalText;
          return;
        }

        // Crear modal con los resultados
        showFaceAnalysisResults(data.faces);

        btn.disabled = false;
        btn.innerHTML = originalText;
        if (window.lucide) lucide.createIcons();

      } catch (error) {
        console.error('Error analizando rostro:', error);
        alert('Error al analizar la imagen: ' + error.message);
        btn.disabled = false;
        btn.innerHTML = originalText;
      }
    }

    // Función para mostrar resultados del análisis facial
    function showFaceAnalysisResults(faces) {
      const modal = document.createElement('div');
      modal.style.cssText = `
        position: fixed; inset: 0; background: rgba(0,0,0,0.8); 
        display: flex; align-items: center; justify-content: center; 
        z-index: 1000; padding: 20px;
      `;

      let html = `
        <div style="background: var(--panel); color: var(--text); border-radius: 12px; 
                    max-width: 600px; width: 100%; max-height: 80vh; overflow-y: auto; padding: 24px;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h2 style="margin: 0; font-size: 24px;">Análisis Facial</h2>
            <button onclick="this.closest('div').parentElement.remove()" 
                    style="background: transparent; border: none; color: var(--text); cursor: pointer; font-size: 24px;">
              ✕
            </button>
          </div>
          
          <p style="color: var(--muted); margin-bottom: 20px;">
            Se detectaron <strong>${faces.length}</strong> rostro(s) en la imagen
          </p>
      `;

      faces.forEach((face, idx) => {
        const mainEmotion = face.emotions.length > 0 ? face.emotions[0] : null;
        
        html += `
          <div style="border: 1px solid var(--line); border-radius: 8px; padding: 16px; margin-bottom: 16px;">
            <h3 style="margin: 0 0 12px 0; color: var(--primary);">Rostro ${idx + 1}</h3>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px;">
              <div>
                <strong>Edad estimada:</strong><br>
                ${face.ageRange ? `${face.ageRange.low} - ${face.ageRange.high} años` : 'No disponible'}
              </div>
              <div>
                <strong>Género:</strong><br>
                ${face.gender ? `${face.gender.value} (${face.gender.confidence}%)` : 'No disponible'}
              </div>
              <div>
                <strong>Confianza:</strong><br>
                ${face.confidence}%
              </div>
              <div>
                <strong>Expresión:</strong><br>
                ${mainEmotion ? `${mainEmotion.type} (${mainEmotion.confidence}%)` : 'No disponible'}
              </div>
            </div>

            <div style="margin-bottom: 12px;">
              <strong>Características detectadas:</strong>
              <ul style="margin: 8px 0; padding-left: 20px;">
                ${face.eyeglasses.present ? `<li>Gafas (${face.eyeglasses.confidence}%)</li>` : ''}
                ${face.sunglasses.present ? `<li>Gafas de sol (${face.sunglasses.confidence}%)</li>` : ''}
                ${face.beard.present ? `<li>Barba (${face.beard.confidence}%)</li>` : ''}
                ${face.mustache.present ? `<li>Bigote (${face.mustache.confidence}%)</li>` : ''}
                ${face.mouthOpen.present ? `<li>Boca abierta (${face.mouthOpen.confidence}%)</li>` : ''}
                ${!face.eyesOpen.present ? `<li>Ojos cerrados (${face.eyesOpen.confidence}%)</li>` : ''}
                ${face.smiling.present ? `<li>Sonriendo (${face.smiling.confidence}%)</li>` : ''}
              </ul>
            </div>

            ${face.emotions.length > 0 ? `
              <div>
                <strong>Emociones detectadas:</strong>
                <div style="margin-top: 8px;">
                  ${face.emotions.map(e => `
                    <div style="display: flex; justify-content: space-between; margin-bottom: 6px;">
                      <span>${e.type}</span>
                      <span style="color: var(--primary); font-weight: 600;">${e.confidence}%</span>
                    </div>
                  `).join('')}
                </div>
              </div>
            ` : ''}
          </div>
        `;
      });

      html += `</div>`;

      modal.innerHTML = html;
      document.body.appendChild(modal);

      modal.onclick = (e) => {
        if (e.target === modal) modal.remove();
      };
    }

    /* ====== Lightbox ====== */
    const lb = document.getElementById('lightbox'), lbClose = document.getElementById('lbClose');
    const lbImg = document.getElementById('lbImg'), lbAva = document.getElementById('lbAva');
    const lbName = document.getElementById('lbName'), lbUser = document.getElementById('lbUser');
    const lbBody = document.getElementById('lbComments'), lbInp = document.getElementById('lbInp'), lbSend = document.getElementById('lbSend');
    const lbLike = document.getElementById('lbLike');
    const lbComment = document.getElementById('lbComment');
    const lbLikes = document.getElementById('lbLikes');
    const lbCommentsCount = document.getElementById('lbCommentsCount');
    const lbShareBtn = document.getElementById('lbShare');
    const lbFaceRecognitionBtn = document.getElementById('lbFaceRecognition');

    let currentPost = null;

    async function listPostComments(postId){
      const r = await fetch(API(`/posts/${postId}/comments?limit=100`), { headers:H });
      const d = await r.json(); return d.ok ? d.comments : [];
    }
    async function addPostComment(postId, text){
      const r = await fetch(API(`/posts/${postId}/comments`), { method:'POST', headers:{...H,'Content-Type':'application/json'}, body:JSON.stringify({ text }) });
      const d = await r.json(); return d.ok ? d.comment : null;
    }
    async function renderComments(list){
      lbBody.innerHTML='';
      for (const c of list) if (!userCache.has(c.userId)) await getUserCached(c.userId);
      list.forEach(c=>{
        const u=userCache.get(c.userId), nm=displayName(u)||'usuario';
        const row=document.createElement('div'); row.className='lb-cmt';
        row.innerHTML=`<span class="nm">${nm}</span>${c.text}<span class="dt">${timeAgo(c.createdAt)}</span>`;
        lbBody.appendChild(row);
      });
      lbBody.scrollTop = lbBody.scrollHeight;
    }
    async function openPostModal(p){
      currentPost = p;

      lbImg.src = p.media.t1 || p.media.original || p.media.thumb;

      const u = await getUserCached(p.userId);
      lbAva.src = resolveAvatar(u);
      lbName.textContent = displayName(u);
      lbUser.textContent = `@${u.nickname || 'usuario'}`;

      lbLike.setAttribute('aria-pressed', p.viewerLiked ? 'true' : 'false');
      lbLikes.textContent = p.counts?.likes || 0;
      lbCommentsCount.textContent = p.counts?.comments || 0;

      const comments = await listPostComments(p.id);
      await renderComments(comments);
      lbCommentsCount.textContent = comments.length;

      lbSend.onclick = async ()=>{
        const t = lbInp.value.trim();
        if(!t) return;
        const c = await addPostComment(p.id, t);
        if(c){
          lbInp.value = '';
          comments.push(c);
          await renderComments(comments);
          lbCommentsCount.textContent = comments.length;
        }
      };

      lbLike.onclick = async ()=>{
        const pressed = lbLike.getAttribute('aria-pressed') === 'true';
        lbLike.setAttribute('aria-pressed', (!pressed) + '');
        lbLikes.textContent = (+lbLikes.textContent + (pressed ? -1 : 1));
        try{
          const r = await fetch(API(`/posts/${p.id}/likes/toggle`), { method:'POST', headers:H });
          const d = await r.json();
          if(!d.ok) throw 0;
        }catch{
          lbLike.setAttribute('aria-pressed', pressed + '');
          lbLikes.textContent = (+lbLikes.textContent + (pressed ? 1 : -1));
        }
      };

      lbComment.onclick = ()=>{ lbInp.focus(); lbBody.scrollTop = lbBody.scrollHeight; };

      // compartir desde el visor
      lbShareBtn.onclick = ()=> openShareModal(p);

      // reconocimiento facial
      lbFaceRecognitionBtn.onclick = async ()=> {
        await analyzeFaceInPost(p);
      };

      lb.setAttribute('aria-hidden','false');
      if (window.lucide) lucide.createIcons();
    }
    function closePostModal(){
      lb.setAttribute('aria-hidden','true');
      lbImg.removeAttribute('src'); lbInp.value=''; lbBody.innerHTML='';
      lbLike.setAttribute('aria-pressed','false');
      lbLikes.textContent = '0'; lbCommentsCount.textContent = '0';
      currentPost = null;
    }
    lbClose.onclick = closePostModal;
    lb.addEventListener('click', (e)=>{ if(e.target===lb) closePostModal(); });
    document.addEventListener('keydown', (e)=>{ if(e.key==='Escape' && lb.getAttribute('aria-hidden')==='false') closePostModal(); });

    /* ====== Tarjeta de post ====== */
    function postCard(p){
      const cls = ratioClass(p.media.width, p.media.height);
      const el = document.createElement('article'); 
      el.className='post-card';
      el.dataset.postId = p.id || p._id;
      const author = userCache.get(p.userId) || {};
      const isMyPost = me && (String(p.userId) === String(me._id || me.id));

      // Detectar si es video o imagen
      const isVideo = p.media?.mime && p.media.mime.startsWith('video/');
      const mediaHtml = isVideo 
        ? `<video class="post-video" src="${p.media.thumb}" controls playsinline></video>`
        : `<img class="post-img" src="${p.media.thumb}" alt="">`;

      el.innerHTML = `
        <header class="post-head">
          <img class="post-ava" src="${resolveAvatar(author)}" alt="">
          <div class="post-user">
            <a class="post-name" href="profile.html?id=${p.userId}">${displayName(author)}</a>
            <div class="post-userid">@${author.nickname || 'usuario'}</div>
          </div>
        </header>
        <div class="post-media ${cls}">${mediaHtml}</div>
        <div class="post-actions">
          <button class="btn-icon btn-like" aria-pressed="${p.viewerLiked?'true':'false'}" title="Me gusta"><i data-lucide="heart"></i></button>
          <button class="btn-icon btn-comment" title="Comentar"><i data-lucide="message-circle"></i></button>
          <button class="btn-icon btn-share" title="Compartir"><i data-lucide="send"></i></button>
          <div class="spacer"></div>
          <div class="post-counts"><span class="likes">${p.counts?.likes||0}</span> · <span class="comments">${p.counts?.comments||0}</span></div>
        </div>
        ${p.caption ? `<div class="post-caption">${p.caption}</div>` : '' }`;

      const likeBtn = el.querySelector('.btn-like'); const likesEl = el.querySelector('.likes');
      likeBtn.onclick = async ()=>{
        const pressed = likeBtn.getAttribute('aria-pressed')==='true';
        likeBtn.setAttribute('aria-pressed',(!pressed)+'' );
        likesEl.textContent=(+likesEl.textContent+(pressed?-1:1));
        try{
          const r=await fetch(API(`/posts/${p.id}/likes/toggle`), {method:'POST', headers:H});
          const d=await r.json(); if(!d.ok) throw 0;
        } catch{
          likeBtn.setAttribute('aria-pressed',pressed+'' );
          likesEl.textContent=(+likesEl.textContent+(pressed?1:-1));
        }
      };

      el.querySelector('.btn-comment').onclick = ()=> openPostModal(p);
      const mediaElement = el.querySelector(isVideo ? '.post-video' : '.post-img');
      if (mediaElement) mediaElement.onclick = ()=> openPostModal(p);
      el.querySelector('.btn-share').onclick  = ()=> openShareModal(p);

      if (window.lucide) lucide.createIcons();
      return el;
    }

    async function renderPost(p){
      if(!userCache.has(p.userId)) await getUserCached(p.userId);
      feedEl.appendChild(postCard(p));
      refreshIcons();
    }

    function prependPost(p){
      if(!userCache.has(p.userId)) userCache.set(p.userId, me);
      feedEl.prepend(postCard(p));
      refreshIcons();
    }

    async function loadFeed(first=false){
      if (loading) return; loading=true;
      try{
        const url = new URL(API('/posts')); url.searchParams.set('limit','10');
        if (nextCursor) url.searchParams.set('cursor', nextCursor);
        const r = await fetch(url.toString(), { headers:H }); const d = await r.json(); if(!d.ok) return;
        for(const p of d.posts||[]) await renderPost(p); nextCursor = d.nextCursor || null;
        document.getElementById('btnMore').style.display = nextCursor ? 'inline-block' : 'none';
      } finally { loading=false; }
    }

    document.getElementById('logoutBtnTop')?.addEventListener('click', ()=>{
      localStorage.removeItem('token'); localStorage.removeItem('user'); location.replace('index.html');
    });

    (async ()=>{ await loadMe(); await loadOthers(); await loadFeed(true); })();

    /* ====== Compartir publicación (modal) ====== */
    const shareModal   = document.getElementById('shareModal');
    const shareClose   = document.getElementById('shareClose');
    const shareSearch  = document.getElementById('shareSearch');
    const shareList    = document.getElementById('shareList');
    const shareMsg     = document.getElementById('shareMsg');
    const shareSendBtn = document.getElementById('shareSend');
    const shareInfo    = document.getElementById('shareInfo');

    let shareTargetPost = null;
    let followingCache = [];
    const selectedRecipients = new Set();

    function openShareModal(post){
      shareTargetPost = post;
      selectedRecipients.clear();
      shareMsg.value = '';
      shareSendBtn.disabled = true;
      shareInfo.textContent = '';
      listFollowing().then(()=> filterShareList(''));
      shareModal.setAttribute('aria-hidden','false');
      if (window.lucide) lucide.createIcons();
    }
    function closeShareModal(){
      shareModal.setAttribute('aria-hidden','true');
      shareList.innerHTML = '';
    }
    shareClose.onclick = closeShareModal;
    shareModal.addEventListener('click', (e)=>{ if(e.target===shareModal) closeShareModal(); });
    document.addEventListener('keydown', (e)=>{ if(e.key==='Escape' && shareModal.getAttribute('aria-hidden')==='false') closeShareModal(); });

    async function listFollowing(){
      if (!me) await loadMe();
      const url = new URL(API(`/follow/${me._id || me.id}/following`));
      url.searchParams.set('limit','200');
      const r = await fetch(url.toString(), { headers:H });
      const d = await r.json();
      followingCache = d?.users || [];
    }

    function renderUserPick(u){
      const el = document.createElement('button');
      el.type = 'button';
      el.className = 'share-pick';
      el.innerHTML = `
        <img src="${resolveAvatar(u)}" alt="" style="width:56px;height:56px;border-radius:50%;object-fit:cover">
        <div class="share-name">${displayName(u)}</div>
      `;
      const mark = document.createElement('div');
      mark.className = 'share-mark';
      el.appendChild(mark);

      const id = u.id || u._id;
      const updateMark = ()=> mark.setAttribute('data-on', selectedRecipients.has(id) ? 'true' : 'false');
      el.onclick = ()=>{
        if (selectedRecipients.has(id)) selectedRecipients.delete(id);
        else selectedRecipients.add(id);
        updateMark();
        shareSendBtn.disabled = selectedRecipients.size===0;
        shareInfo.textContent = selectedRecipients.size ? `Seleccionados: ${selectedRecipients.size}` : '';
      };
      updateMark();
      return el;
    }

    function filterShareList(q){
      const query = (q||'').toLowerCase();
      shareList.innerHTML = '';
      const list = followingCache.filter(u=>{
        const s = `${u.firstName||''} ${u.lastName||''} ${u.nickname||''} ${u.name||''}`.toLowerCase();
        return !query || s.includes(query);
      });
      if (!list.length){
        shareList.innerHTML = '<div class="muted" style="grid-column:1/-1;text-align:center">No se encontraron resultados</div>';
        return;
      }
      list.forEach(u => shareList.appendChild(renderUserPick(u)));
    }
    shareSearch.oninput = e => filterShareList(e.target.value);

    async function ensureConversation(userId){
      const r = await fetch(API(`/messages/conversation/${userId}`), { headers:H });
      const d = await r.json();
      if (!d?.conversation?.id) throw new Error('No se pudo crear conversación');
      return d.conversation.id;
    }

    // ENVÍO COMO TARJETA (no solo link). Enviamos un payload con tipo 'post-card'.
    async function sendShare(){
      if (!shareTargetPost || selectedRecipients.size===0) return;
      shareSendBtn.disabled = true;

      // armamos un payload estructurado para que messages.js pinte la tarjeta
      const payload = {
        type: 'post-card',
        postId: shareTargetPost.id,
        author: displayName(userCache.get(shareTargetPost.userId) || me) || '',
        name: displayName(userCache.get(shareTargetPost.userId) || me) || '',
        nickname: (userCache.get(shareTargetPost.userId) || me)?.nickname || '',
        avatar: resolveAvatar(userCache.get(shareTargetPost.userId) || me),
        mediaThumb: shareTargetPost.media?.thumb || shareTargetPost.media?.original || '',
        caption: shareTargetPost.caption || ''
      };

      // mensaje opcional del usuario
      const extra = shareMsg.value.trim();
      const content = extra ? `${extra}\n${JSON.stringify(payload)}` : JSON.stringify(payload);

      try{
        for (const uid of selectedRecipients){
          const convId = await ensureConversation(uid);
          await fetch(API(`/messages/${convId}`), {
            method:'POST',
            headers:{ ...JH },
            body: JSON.stringify({ content })
          });
        }
        shareInfo.textContent = '¡Enviado!';
        setTimeout(()=>{ closeShareModal(); }, 600);
      }catch(e){
        shareInfo.textContent = 'Error al enviar';
      }finally{
        shareSendBtn.disabled = false;
      }
    }
    shareSendBtn.onclick = sendShare;

    // Abrir modal de compartir por hash (limpieza)
    (function(){
      const m = location.hash.match(/post=([^&]+)/);
      if (m) location.hash = '';
    })();

    // Actualizar badge de notificaciones
    // Actualizar badge de notificaciones
    async function updateNotificationBadge() {
      try {
        const res = await fetch(API('/notifications/unread-count'), { headers: H });
        const data = await res.json();
        const badge = document.getElementById('notificationsBadge');
        if (badge) {
          if (data.ok && data.count > 0) {
            badge.textContent = data.count > 99 ? '99+' : data.count;
            badge.style.display = 'inline-flex';
          } else {
            badge.style.display = 'none';
          }
        }
      } catch (error) {
        console.error('Error actualizando badge de notificaciones:', error);
      }
    }

    // Actualizar badge de mensajes no leídos
    async function updateMessagesBadge() {
      try {
        const res = await fetch(API('/messages/conversations'), { headers: H });
        const data = await res.json();
        if (data.ok) {
          const unreadCount = data.conversations.filter(c => c.hasUnread).length;
          const badge = document.getElementById('unreadBadge');
          if (unreadCount > 0) {
            badge.textContent = unreadCount > 99 ? '99+' : unreadCount;
            badge.style.display = 'inline-flex';
          } else {
            badge.style.display = 'none';
          }
        }
      } catch (error) {
        console.error('Error actualizando badge de mensajes:', error);
      }
    }

    // Actualizar ambos badges cada 30 segundos
    updateNotificationBadge();
    updateMessagesBadge();
    setInterval(() => {
      updateNotificationBadge();
      updateMessagesBadge();
    }, 30000);

    // Manejar notificaciones - abrir post si viene del parámetro postId
    (async function() {
      const params = new URLSearchParams(window.location.search);
      const postId = params.get('postId');
      
      if (postId) {
        console.log('Abriendo post desde notificación:', postId);
        
        try {
          // Obtener los datos del post desde la API
          const res = await fetch(API(`/posts/${postId}`), { headers: H });
          const data = await res.json();
          
          if (data.ok && data.post) {
            console.log('Post obtenido de la API:', data.post);
            // Abrir el modal directamente con los datos del post
            openPostModal(data.post);
          } else {
            console.error('No se pudo obtener el post');
          }
        } catch (error) {
          console.error('Error obteniendo post:', error);
        }
      }
    })();

    // Cargar todo
    window.addEventListener('load', () => { if (window.lucide) lucide.createIcons(); });
  </script>

  <!-- Sistema de Transformaciones de Imágenes -->
  <script src="js/transformations.js"></script>
  <!-- Sistema de Filtros en el Compositor -->
  <script src="js/composer-filters.js"></script>

  <footer style="text-align:center;padding:16px;margin-top:40px;font-size:0.85rem;color:var(--muted);border-top:1px solid var(--line)">
    © 2025 Proyecto Desarrollo Web - Desarrollado por Dilan Escobar y Andrea Chafolla
  </footer>
</body>
</html>
