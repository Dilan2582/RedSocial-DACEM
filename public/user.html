<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>DACEM ‚Äì Inicio</title>
  <link rel="stylesheet" href="css/user.css">
</head>
<body>
  <!-- Topbar -->
  <header class="topbar">
    <div class="topbar-inner">
      <div class="brand">DACEM</div>
      <div class="topbar-actions">
        <button id="logoutBtnTop" class="btn danger small">Cerrar sesi√≥n</button>
      </div>
    </div>
  </header>

  <div class="wrap">
    <div class="layout">
      <!-- Sidebar -->
      <aside class="sidebar">
        <nav class="nav">
          <a class="nav-item active" href="user.html"><span class="nav-ico">üè†</span> Inicio</a>
          <a class="nav-item" href="profile.html"><span class="nav-ico">üë§</span> Mi perfil</a>
        </nav>
      </aside>

      <!-- Centro -->
      <main class="main">
        <!-- Composer -->
        <section class="card composer" id="composer">
          <div class="cmp-row">
            <img id="cmpAvatar" class="cmp-avatar" alt="yo">
            <textarea id="cmpText" class="cmp-input" rows="2" placeholder="¬øQu√© est√°s pensando? (opcional)"></textarea>
          </div>

          <div id="cmpPreview" class="cmp-preview" style="display:none">
            <img id="cmpPreviewImg" alt="preview">
            <button id="cmpRemoveImg" class="btn ghost small">Quitar</button>
          </div>

          <div class="cmp-tools">
            <input id="cmpFile" type="file" accept="image/*" hidden>
            <button id="cmpPick" class="btn ghost small">üì∑ Imagen</button>
            <div class="spacer"></div>
            <button id="cmpPost" class="btn primary">Publicar</button>
          </div>
          <div class="cmp-msg muted" id="cmpMsg"></div>
        </section>

        <!-- Feed -->
        <section class="feed" id="feed"></section>

        <div class="card" style="text-align:center">
          <button id="btnMore" class="btn">Cargar m√°s</button>
        </div>
      </main>

      <!-- Aside: Personas -->
      <aside class="aside">
        <div class="card">
          <h3 style="margin:0 0 12px">Personas</h3>
          <div id="peopleList" class="people-list"></div>
        </div>
      </aside>
    </div>
  </div>

  <!-- Lightbox Post -->
  <div class="lightbox" id="lightbox" aria-hidden="true">
    <div class="lb-content" role="dialog" aria-modal="true" aria-label="Publicaci√≥n">
      <button class="btn ghost small lb-close" id="lbClose">‚úï</button>

      <div class="lb-media"><img id="lbImg" alt=""></div>

      <aside class="lb-side">
        <header class="lb-head">
          <img id="lbAva" class="lb-ava" alt="">
          <div>
            <div id="lbName" style="font-weight:700"></div>
            <div id="lbUser" class="muted" style="font-size:12px"></div>
          </div>
        </header>
        <div class="lb-body" id="lbComments"></div>
        <div class="lb-input">
          <input id="lbInp" placeholder="A√±ade un comentario‚Ä¶">
          <button id="lbSend" class="btn">Publicar</button>
        </div>
      </aside>
    </div>
  </div>

  <script>
    // ===== Helpers / API =====
    const API = (p)=>`${location.origin}/api${p}`;
    const token = localStorage.getItem('token');
    if(!token){ location.replace('index.html'); }

    const H  = { 'Authorization':`Bearer ${token}` };
    const $  = s => document.querySelector(s);

    function displayName(u){ return u?.name || `${u?.firstName||''} ${u?.lastName||''}`.trim() || (u?.nickname || 'Usuario'); }
    function abs(url){ return url?.startsWith('http') ? url : `${location.origin}${url?.startsWith('/')?url:'/'+url}`; }
    function resolveAvatar(u){
      if(u?.avatar) return abs(u.avatar);
      const seed = encodeURIComponent(displayName(u) || u?.nickname || 'U');
      return `https://api.dicebear.com/8.x/initials/svg?seed=${seed}&radius=50&scale=110&fontWeight=700`;
    }
    function timeAgo(iso){
      try{ const d=new Date(iso); const s=(Date.now()-d)/1000;
        if(s<60) return 'ahora'; if(s<3600) return Math.floor(s/60)+' min';
        if(s<86400) return Math.floor(s/3600)+' h'; return Math.floor(s/86400)+' d';
      }catch{ return ''; }
    }

    // ===== Sugerencias =====
    async function toggleFollow(id, isFollowing){
      try{
        const r = await fetch(API(`/follow/toggle/${id}`), { method:'POST', headers:H });
        if (r.status !== 404){ const d = await r.json(); return !!d.ok; }
      }catch{}
      if (!isFollowing){
        const r = await fetch(API(`/follow/${id}`), { method:'POST', headers:H });
        const d = await r.json(); return !!d.ok;
      }else{
        const r = await fetch(API(`/follow/${id}`), { method:'DELETE', headers:H });
        const d = await r.json(); return !!d.ok;
      }
    }
    function personRow(u){
      const el = document.createElement('div');
      el.className = 'person-row';
      el.innerHTML = `
        <div class="p-avatar"><img src="${resolveAvatar(u)}" alt=""></div>
        <div class="p-info">
          <div class="p-name" title="${displayName(u)}">${displayName(u)}</div>
          <div class="p-user" title="@${u.nickname || 'usuario'}">@${u.nickname || 'usuario'}</div>
        </div>
        <div class="p-actions">
          <a class="btn ghost small" href="profile.html?id=${u._id}">Ver perfil</a>
          <button class="btn small">${u.isFollowing?'Dejar de seguir':'Seguir'}</button>
        </div>`;
      const btn = el.querySelector('button');
      btn.onclick = async () => {
        btn.disabled = true;
        const ok = await toggleFollow(u._id, !!u.isFollowing);
        if (ok){ u.isFollowing=!u.isFollowing; btn.textContent = u.isFollowing?'Dejar de seguir':'Seguir'; }
        btn.disabled = false;
      };
      return el;
    }
    async function loadOthers(){
      const list = $('#peopleList'); if (!list) return;
      list.innerHTML = '';
      const r = await fetch(API('/user/others'), { headers:H });
      const d = await r.json();
      if(!d.ok || !d.users?.length){ list.innerHTML = '<div class="muted">No hay sugerencias por ahora.</div>'; return; }
      d.users.forEach(u => list.appendChild(personRow(u)));
    }

    // ===== Composer =====
    let me = null; const userCache = new Map();
    async function loadMe(){
      const r = await fetch(API('/user/me'), { headers:H });
      const d = await r.json(); if(!d.ok){ localStorage.clear(); return location.replace('index.html'); }
      me = d.user; userCache.set(me._id, me);
      $('#cmpAvatar').src = resolveAvatar(me);
    }

    const cmp = {
      fileEl: $('#cmpFile'), pick: $('#cmpPick'), imgBox: $('#cmpPreview'),
      img: $('#cmpPreviewImg'), rm: $('#cmpRemoveImg'), txt: $('#cmpText'),
      post: $('#cmpPost'), msg: $('#cmpMsg')
    };
    let selectedFile = null;

    cmp.pick.onclick = ()=> cmp.fileEl.click();
    cmp.fileEl.onchange = e=>{
      const f = e.target.files?.[0];
      if(!f){ selectedFile=null; cmp.imgBox.style.display='none'; return; }
      selectedFile = f; cmp.img.src = URL.createObjectURL(f); cmp.imgBox.style.display='flex';
    };
    cmp.rm.onclick = ()=>{ selectedFile=null; cmp.fileEl.value=''; cmp.imgBox.style.display='none'; cmp.img.removeAttribute('src'); };

    async function publish(){
      cmp.post.disabled = true; cmp.msg.textContent = 'Publicando...';
      try{
        const fd = new FormData();
        if (selectedFile) fd.append('image', selectedFile);
        if (cmp.txt.value.trim()) fd.append('caption', cmp.txt.value.trim());
        const r = await fetch(API('/posts'), { method:'POST', headers:H, body:fd });
        const d = await r.json();
        if(!d.ok) throw new Error(d.message||'Error');
        prependPost(d.post);
        cmp.msg.textContent = '¬°Publicado!'; cmp.txt.value=''; cmp.rm.click();
        setTimeout(()=>cmp.msg.textContent='', 1200);
      }catch{ cmp.msg.textContent = 'No se pudo publicar'; }
      finally{ cmp.post.disabled=false; }
    }
    cmp.post.onclick = publish;

    // ===== Feed =====
    const feedEl = $('#feed');
    let nextCursor = null, loading = false;

    function iconComment(){ return `<svg aria-hidden="true" width="22" height="22" viewBox="0 0 24 24"><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" d="M12 21a9 9 0 1 0-9-9c0 1.488.36 2.89 1 4.127L3 21l4.873-1c1.236.639 2.64 1 4.127 1m0-11.999v6m-3-3h6"/></svg>`; }
    function iconLike(){ return `<svg aria-hidden="true" width="22" height="22" viewBox="0 0 48 48"><path fill="currentColor" d="M34 9c-4.2 0-7.9 2.1-10 5.4C21.9 11.1 18.2 9 14 9C7.4 9 2 14.4 2 21c0 11.9 22 24 22 24s22-12 22-24c0-6.6-5.4-12-12-12"/></svg>`; }
    function ratioClass(w,h){ const r=w/h; if(r<0.95) return 'ratio-portrait'; if(r>1.6) return 'ratio-landscape'; return 'ratio-square'; }

    async function getUserCached(id){
      if (userCache.has(id)) return userCache.get(id);
      const r = await fetch(API(`/user/${id}/public`), { headers:H });
      const d = await r.json(); if (d.ok){ userCache.set(id,d.user); return d.user; }
      return { nickname:'usuario', firstName:'', lastName:'', avatar:null };
    }

    // Lightbox helpers
    const lb = document.getElementById('lightbox'), lbClose = document.getElementById('lbClose');
    const lbImg = document.getElementById('lbImg'), lbAva = document.getElementById('lbAva');
    const lbName = document.getElementById('lbName'), lbUser = document.getElementById('lbUser');
    const lbBody = document.getElementById('lbComments'), lbInp = document.getElementById('lbInp'), lbSend = document.getElementById('lbSend');

    async function listPostComments(postId){
      const r = await fetch(API(`/posts/${postId}/comments?limit=100`), { headers:H });
      const d = await r.json(); return d.ok ? d.comments : [];
    }
    async function addPostComment(postId, text){
      const r = await fetch(API(`/posts/${postId}/comments`), { method:'POST', headers:{...H,'Content-Type':'application/json'}, body:JSON.stringify({ text }) });
      const d = await r.json(); return d.ok ? d.comment : null;
    }
    async function renderComments(list){
      lbBody.innerHTML=''; for (const c of list) if (!userCache.has(c.userId)) await getUserCached(c.userId);
      list.forEach(c=>{ const u=userCache.get(c.userId), nm=displayName(u)||'usuario';
        const row=document.createElement('div'); row.className='lb-cmt';
        row.innerHTML=`<span class="nm">${nm}</span>${c.text}<span class="dt">${timeAgo(c.createdAt)}</span>`;
        lbBody.appendChild(row);
      }); lbBody.scrollTop = lbBody.scrollHeight;
    }
    async function openPostModal(p){
      lbImg.src = p.media.t1 || p.media.original || p.media.thumb;
      const u = await getUserCached(p.userId);
      lbAva.src = resolveAvatar(u); lbName.textContent = displayName(u); lbUser.textContent = `@${u.nickname || 'usuario'}`;
      const comments = await listPostComments(p.id); await renderComments(comments);
      lbSend.onclick = async ()=>{ const t = lbInp.value.trim(); if(!t) return;
        const c = await addPostComment(p.id, t); if(c){ lbInp.value=''; comments.push(c); await renderComments(comments); } };
      lb.setAttribute('aria-hidden','false');
    }
    function closePostModal(){ lb.setAttribute('aria-hidden','true'); lbImg.removeAttribute('src'); lbInp.value=''; lbBody.innerHTML=''; }
    lbClose.onclick = closePostModal;
    lb.addEventListener('click', (e)=>{ if(e.target===lb) closePostModal(); });
    document.addEventListener('keydown', (e)=>{ if(e.key==='Escape' && lb.getAttribute('aria-hidden')==='false') closePostModal(); });

    function postCard(p){
      const cls = ratioClass(p.media.width, p.media.height);
      const el = document.createElement('article'); el.className='post-card';
      const author = userCache.get(p.userId) || {};
      el.innerHTML = `
        <header class="post-head">
          <img class="post-ava" src="${resolveAvatar(author)}" alt="">
          <div class="post-user">
            <a class="post-name" href="profile.html?id=${p.userId}">${displayName(author)}</a>
            <div class="post-userid">@${author.nickname || 'usuario'}</div>
          </div>
        </header>
        <div class="post-media ${cls}"><img class="post-img" src="${p.media.thumb}" alt=""></div>
        <div class="post-actions">
          <button class="btn-icon btn-like" aria-pressed="${p.viewerLiked?'true':'false'}" title="Me gusta">${iconLike()}</button>
          <button class="btn-icon btn-comment" title="Comentar">${iconComment()}</button>
          <div class="spacer"></div>
          <div class="post-counts"><span class="likes">${p.counts?.likes||0}</span> ¬∑ <span class="comments">${p.counts?.comments||0}</span></div>
        </div>
        ${p.caption ? `<div class="post-caption">${p.caption}</div>` : '' }`;

      const likeBtn = el.querySelector('.btn-like'); const likesEl = el.querySelector('.likes');
      likeBtn.onclick = async ()=>{ const pressed = likeBtn.getAttribute('aria-pressed')==='true';
        likeBtn.setAttribute('aria-pressed',(!pressed)+''); likesEl.textContent=(+likesEl.textContent+(pressed?-1:1));
        try{ const r=await fetch(API(`/posts/${p.id}/likes/toggle`), {method:'POST', headers:H}); const d=await r.json(); if(!d.ok) throw 0; }
        catch{ likeBtn.setAttribute('aria-pressed',pressed+''); likesEl.textContent=(+likesEl.textContent+(pressed?1:-1)); } };

      el.querySelector('.btn-comment').onclick = ()=> openPostModal(p);
      el.querySelector('.post-img').onclick   = ()=> openPostModal(p);
      return el;
    }
    async function renderPost(p){ if(!userCache.has(p.userId)) await getUserCached(p.userId); feedEl.appendChild(postCard(p)); }
    function prependPost(p){ if(!userCache.has(p.userId)) userCache.set(p.userId, me); feedEl.prepend(postCard(p)); }

    async function loadFeed(first=false){
      if (loading) return; loading=true;
      try{
        const url = new URL(API('/posts')); url.searchParams.set('limit','10');
        if (nextCursor) url.searchParams.set('cursor', nextCursor);
        const r = await fetch(url.toString(), { headers:H }); const d = await r.json(); if(!d.ok) return;
        for(const p of d.posts||[]) await renderPost(p); nextCursor = d.nextCursor || null;
        $('#btnMore').style.display = nextCursor ? 'inline-block' : 'none';
      } finally { loading=false; }
    }

    // ===== Init =====
    document.getElementById('logoutBtnTop')?.addEventListener('click', ()=>{ localStorage.removeItem('token'); localStorage.removeItem('user'); location.replace('index.html'); });
    (async ()=>{ await loadMe(); await loadOthers(); await loadFeed(true); })();
    $('#btnMore').onclick = ()=> loadFeed();
  </script>
</body>
</html>
