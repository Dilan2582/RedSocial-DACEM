<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>DACEM ‚Äì Inicio</title>
  <link rel="stylesheet" href="css/user.css">
</head>
<body>
  <!-- Topbar -->
 <header class="topbar">
  <div class="topbar-inner">
    <div class="brand">DACEM</div>
    <div class="topbar-actions">
      <button id="logoutBtnTop" class="btn danger small">Cerrar sesi√≥n</button>
    </div>
  </div>
</header>



  <div class="wrap">
    <!-- Layout 3 columnas -->
    <div class="layout">
      <!-- Izquierda: Sidebar -->
      <aside class="sidebar">
        <nav class="nav">
          <a class="nav-item active" href="user.html">
            <span class="nav-ico">üè†</span> Inicio
          </a>
          <a class="nav-item" href="profile.html">
            <span class="nav-ico">üë§</span> Mi perfil
          </a>
        </nav>
      </aside>

      <!-- Centro: Feed -->
      <main class="main">
        <div class="card">
          <h2 style="margin:0 0 8px">Publicaciones</h2>
        </div>
      </main>

      <!-- Derecha: Personas (sugerencias) -->
      <aside class="aside">
        <div class="card">
          <h3 style="margin:0 0 12px">Personas</h3>
          <div id="peopleList" class="people-list"></div>
        </div>
      </aside>
    </div>
  </div>

  <script>
    // ===== Helpers / API =====
    const API = (p)=>`${location.origin}/api${p}`;
    const token = localStorage.getItem('token');
    if(!token){ location.replace('index.html'); }

    const H  = { 'Authorization':`Bearer ${token}` };
    const $  = s => document.querySelector(s);

    function displayName(u){ return u.name || `${u.firstName||''} ${u.lastName||''}`.trim() || (u.nickname || 'Usuario'); }
    function resolveAvatar(u){
      if(u.avatar){
        const abs = u.avatar.startsWith('http') ? u.avatar : `${location.origin}${u.avatar.startsWith('/')?u.avatar:'/'+u.avatar}`;
        return `${abs}?v=${Date.now()}`;
      }
      const seed = encodeURIComponent(displayName(u) || u.nickname || 'U');
      return `https://api.dicebear.com/8.x/initials/svg?seed=${seed}&radius=50&scale=110&fontWeight=700`;
    }

    async function toggleFollow(id, isFollowing){
      // intenta endpoint toggle
      try{
        const r = await fetch(API(`/follow/toggle/${id}`), { method:'POST', headers:H });
        if (r.status !== 404){ const d = await r.json(); return !!d.ok; }
      }catch{}
      // plan B
      if (!isFollowing){
        const r = await fetch(API(`/follow/${id}`), { method:'POST', headers:H });
        const d = await r.json(); return !!d.ok;
      }else{
        const r = await fetch(API(`/follow/${id}`), { method:'DELETE', headers:H });
        const d = await r.json(); return !!d.ok;
      }
    }

    function personRow(u){
      const el = document.createElement('div');
      el.className = 'person-row';

      const ava = document.createElement('div');
      ava.className = 'p-avatar';
      const img = document.createElement('img');
      img.src = resolveAvatar(u);
      ava.appendChild(img);

      const info = document.createElement('div');
      info.className = 'p-info';
      info.innerHTML = `
        <div class="p-name">${displayName(u)}</div>
        <div class="p-user">@${u.nickname || 'usuario'}</div>
      `;

      const actions = document.createElement('div');
      actions.className = 'p-actions';

      const view = document.createElement('a');
      view.className = 'btn ghost';
      view.textContent = 'Ver perfil';
      view.href = `profile.html?id=${u._id}`;

      const follow = document.createElement('button');
      follow.className = 'btn';
      follow.textContent = u.isFollowing ? 'Dejar de seguir' : 'Seguir';

      follow.onclick = async () => {
        follow.disabled = true;
        const ok = await toggleFollow(u._id, !!u.isFollowing);
        if (ok){ u.isFollowing = !u.isFollowing; follow.textContent = u.isFollowing ? 'Dejar de seguir' : 'Seguir'; }
        follow.disabled = false;
      };

      actions.append(view, follow);
      el.append(ava, info, actions);
      return el;
    }

    async function loadOthers(){
      const list = $('#peopleList'); list.innerHTML = '';
      const r = await fetch(API('/user/others'), { headers:H });
      const d = await r.json();
      if(!d.ok || !d.users?.length){
        list.innerHTML = '<div class="muted">No hay sugerencias por ahora.</div>';
        return;
      }
      d.users.forEach(u => list.appendChild(personRow(u)));
    }

    // Logout topbar
    document.getElementById('logoutBtnTop')?.addEventListener('click', () => {
    localStorage.removeItem('token');
    localStorage.removeItem('user');
    location.replace('index.html');
  });

    // init
    loadOthers();
  </script>
</body>
</html>
