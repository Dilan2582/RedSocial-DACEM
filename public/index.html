<!doctype html>
<html lang="es" data-theme="dark">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>DACEM – Iniciar sesión</title>

  <!-- Estilos integrados alineados al diseño de la app -->
  <style>
    :root,[data-theme="dark"]{
      --bg:#0f172a; --panel:#121a2a; --panel2:#0b1323;
      --text:#e6edf7; --muted:#94a3b8; --line:#1f2a3a;
      --accent:#60a5fa; --ring:rgba(96,165,250,.18);
      --ok:#22c55e; --err:#ef4444;
    }
    [data-theme="light"]{
      --bg:#f3f5fb; --panel:#ffffff; --panel2:#f7f9ff;
      --text:#172033; --muted:#6b778c; --line:#dbe2f0;
      --accent:#3b82f6; --ring:rgba(59,130,246,.18);
      --ok:#16a34a; --err:#dc2626;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; background:var(--bg); color:var(--text);
      font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;
      display:grid; place-items:center; padding:24px 16px;
    }

    /* Contenedor Login */
    .auth-shell{
      width:100%; display:grid; place-items:center;
    }
    .card{
      width:min(420px, 100%); background:var(--panel); border:1px solid var(--line);
      border-radius:16px; padding:24px; box-shadow:0 12px 36px rgba(0,0,0,.35);
      animation:slideUp .45s ease both; position:relative;
    }
    .logo{display:grid; place-items:center; gap:6px; margin-bottom:14px}
    .logo-badge{
      width:56px;height:56px;border-radius:14px;
      background:linear-gradient(135deg,#5aa0ff 0%,#7c6aff 100%);
      display:grid;place-items:center;color:white;font-weight:800;font-size:18px;letter-spacing:.3px;
      box-shadow:0 10px 24px rgba(0,0,0,.35);
      overflow:hidden;
      position:relative;
    }
    .logo-badge--sm{width:28px;height:28px;border-radius:8px}
    .logo-badge img{
      width:100%;height:100%;
      object-fit:cover;
      display:block;
      border-radius:inherit;
    }
    .logo-badge::after{
      content:"";position:absolute;inset:0;border-radius:inherit;
      box-shadow:inset 0 0 0 2px rgba(255,255,255,.06);
      pointer-events:none;
    }
    h2{margin:2px 0 12px}
    p.muted{margin:8px 0 0; color:var(--muted); text-align:center}

    label{display:block; margin:12px 0 6px; color:var(--muted); font-size:.95rem}
    .input-wrap{position:relative}
    .input-wrap svg{position:absolute; left:12px; top:50%; transform:translateY(-50%); opacity:.6}
    input{
      width:100%; padding:12px 12px 12px 40px; border-radius:10px; background:var(--panel2); color:var(--text);
      border:1px solid var(--line); outline:none; transition:border-color .15s, box-shadow .15s, background .15s;
      font-size:.98rem;
    }
    input:focus{ border-color:var(--accent); box-shadow:0 0 0 4px var(--ring) }

    .divider{display:flex; align-items:center; gap:10px; margin:14px 0; color:var(--muted)}
    .divider::before,.divider::after{content:""; height:1px; flex:1; background:var(--line)}

    .msg{margin-top:10px; font-size:.95rem; text-align:center; padding:10px 12px; border-radius:10px; display:none}
    .msg.success{display:block; color:var(--ok); background:color-mix(in srgb, var(--ok) 14%, transparent)}
    .msg.error{display:block; color:var(--err); background:color-mix(in srgb, var(--err) 14%, transparent)}

    .links{display:flex; justify-content:space-between; align-items:center; margin-top:12px}
    .link{color:var(--accent); text-decoration:none}
    .link:hover{text-decoration:underline}

    #recaptcha-login, #recaptcha-register{ display:flex; justify-content:center; margin:8px 0 }

    /* Modal registro */
    .modal-backdrop{
      position:fixed; inset:0; background:#0008; display:none; align-items:center; justify-content:center; z-index:60;
    }
    .modal-backdrop[data-open="true"]{ display:flex }
    .modal{
      width:min(520px, 92vw); background:var(--panel); color:var(--text); border:1px solid var(--line);
      border-radius:16px; padding:24px; box-shadow:0 20px 60px rgba(0,0,0,.4); max-height:92vh; overflow:auto
    }
    .modal-head{display:flex; align-items:center; gap:8px; margin-bottom:10px}
    .modal-head h3{margin:0; font-size:1.2rem}
    .modal-close{margin-left:auto}
    .grid-2{display:grid; gap:10px; grid-template-columns:1fr 1fr}
    @media (max-width:680px){ .grid-2{ grid-template-columns:1fr } }

    @keyframes slideUp{from{opacity:0; transform:translateY(22px)} to{opacity:1; transform:none}}
    @keyframes shakeX {
      0%,100%{transform:translateX(0)}
      10%,30%,50%,70%,90%{transform:translateX(-5px)}
      20%,40%,60%,80%{transform:translateX(5px)}
    }
    .shake{animation:shakeX .45s}
  </style>
</head>
<body>
  <main class="auth-shell">
    <section class="card" id="loginCard">
      <button id="themeToggle" style="position:absolute;top:16px;right:16px;background:transparent;border:1px solid var(--line);color:var(--text);width:36px;height:36px;border-radius:50%;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:.2s ease" title="Cambiar tema">
        <span id="themeIcon" style="display:flex;align-items:center;justify-content:center"></span>
      </button>
      <div class="logo">
        <div class="logo-badge">
          <img src="img/Dacem.png" alt="DACEM logo">
        </div>
        <h2>Bienvenido</h2>
        <p class="muted">Inicia sesión para continuar</p>
      </div>

      <form onsubmit="login(event)">
        <label for="identifier">Apodo o Email</label>
        <div class="input-wrap">
          <!-- user icon -->
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round">
            <path d="M20 21a8 8 0 0 0-16 0"/><circle cx="12" cy="8" r="4"/>
          </svg>
          <input id="identifier" type="text" placeholder="tu apodo o email" required>
        </div>

        <label for="loginPassword">Contraseña</label>
        <div class="input-wrap">
          <!-- lock icon -->
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round">
            <rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/>
          </svg>
          <input id="loginPassword" type="password" placeholder="••••••••" required>
        </div>

        <div id="recaptcha-login"></div>

        <button type="submit" class="btn primary" style="width:100%; margin-top:8px">Entrar</button>
        <div id="loginMsg" class="msg"></div>
      </form>

      <div class="divider"><span>o</span></div>

      <!-- Google GSI -->
      <div id="g_id_onload"
           data-client_id="661877365139-mhu54lv2ng3hngf6b5be3merjiuba4b7.apps.googleusercontent.com"
           data-callback="handleGoogleLogin"
           data-auto_prompt="false"></div>
      <div class="g_id_signin"
           data-type="standard"
           data-size="large"
           data-theme="outline"
           data-text="continue_with"
           data-shape="rectangular"
           data-logo_alignment="left"
           style="display:flex; justify-content:center"></div>

      <div class="links">
        <a class="link" href="#" onclick="openRegisterModal(event)">Crear cuenta</a>
        <a class="link" href="#">¿Olvidaste tu contraseña?</a>
      </div>
    </section>
  </main>

  <!-- Modal Registro -->
  <div class="modal-backdrop" id="register-backdrop">
    <div class="modal">
      <div class="modal-head">
        <h3>Crear cuenta</h3>
        <button class="btn ghost small modal-close" onclick="closeRegisterModal()">✕</button>
      </div>

      <form onsubmit="register(event)">
        <div class="grid-2">
          <div>
            <label for="firstName">Nombre</label>
            <input id="firstName" type="text" placeholder="Tu nombre" required>
          </div>
          <div>
            <label for="lastName">Apellido</label>
            <input id="lastName" type="text" placeholder="Tu apellido" required>
          </div>
        </div>

        <label for="nickname">Apodo</label>
        <input id="nickname" type="text" placeholder="Tu apodo único" required>

        <label for="email">Email</label>
        <div class="input-wrap">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round">
            <path d="M4 4h16v16H4z" fill="none"/><path d="m22 6l-10 7L2 6"/>
          </svg>
          <input id="email" type="email" placeholder="tu@email.com" required>
        </div>

        <label for="password">Contraseña</label>
        <div class="input-wrap">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round">
            <rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/>
          </svg>
          <input id="password" type="password" placeholder="••••••••" required>
        </div>

        <label for="confirmPassword">Confirmar contraseña</label>
        <div class="input-wrap">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round">
            <rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/>
          </svg>
          <input id="confirmPassword" type="password" placeholder="••••••••" required>
        </div>

        <div id="recaptcha-register"></div>

        <button type="submit" class="btn primary" style="width:100%; margin-top:8px">Registrarse</button>
        <div id="registerMsg" class="msg"></div>
      </form>
    </div>
  </div>

  <script>
    // Redirect si ya está logueado
    if (localStorage.getItem('token')) location.href = 'user.html';

    // THEME toggle
    (function(){
      const btn   = document.getElementById('themeToggle');
      const icon  = document.getElementById('themeIcon');
      const prefersDark = matchMedia('(prefers-color-scheme: dark)').matches;
      const saved = localStorage.getItem('theme');
      const start = saved || (prefersDark ? 'dark' : 'light');
      document.documentElement.setAttribute('data-theme', start);
      setBtn(start);

      btn.addEventListener('click', () => {
        const curr = document.documentElement.getAttribute('data-theme') || 'dark';
        const next = curr === 'dark' ? 'light' : 'dark';
        document.documentElement.setAttribute('data-theme', next);
        localStorage.setItem('theme', next);
        setBtn(next);
      });

      function setBtn(mode){
        btn.title = mode === 'dark' ? 'Modo claro' : 'Modo oscuro';
        icon.innerHTML = mode === 'dark'
          ? `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="5"></circle><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/></svg>`
          : `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12.79A9 9 0 1 1 11.21 3A7 7 0 0 0 21 12.79z"/></svg>`;
      }
    })();

    // API
    const API_USER = `${location.origin}/api/user`;
    const API_AUTH = `${location.origin}/api/auth`;
    const RECAPTCHA_SITE_KEY = "6LcMNc8rAAAAADgevHmG75S_cJPmydAOFEfo8lib";

    // reCAPTCHA
    let widgetLogin = null;
    let widgetRegister = null;
    let registerRendered = false;

    function initRecaptcha() {
      try {
        widgetLogin = grecaptcha.render("recaptcha-login", {
          sitekey: RECAPTCHA_SITE_KEY,
          theme: document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'light'
        });
      } catch (e) {
        console.warn("[reCAPTCHA] login aún no disponible:", e);
      }
    }
    function ensureRegisterRecaptcha() {
      if (registerRendered) return;
      if (!window.grecaptcha || !grecaptcha.render) return;
      widgetRegister = grecaptcha.render("recaptcha-register", {
        sitekey: RECAPTCHA_SITE_KEY,
        theme: document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'light'
      });
      registerRendered = true;
    }

    // Modal registro
    function openRegisterModal(e){
      e?.preventDefault?.();
      document.getElementById('register-backdrop').setAttribute('data-open','true');
      document.body.style.overflow='hidden';
      ensureRegisterRecaptcha();
    }
    function closeRegisterModal(){
      document.getElementById('register-backdrop').removeAttribute('data-open');
      document.body.style.overflow='auto';
      const msg = document.getElementById('registerMsg');
      msg.textContent=''; msg.className='msg';
      if (registerRendered && widgetRegister!==null) try{grecaptcha.reset(widgetRegister)}catch{}
    }

    // Mensajes
    function setMsg(el, text, isError=false){
      el.textContent = text;
      el.className = 'msg ' + (isError ? 'error' : 'success');
      if (isError && el.id==='loginMsg'){
        const card = document.getElementById('loginCard');
        card.classList.remove('shake'); void card.offsetWidth; card.classList.add('shake');
      }
    }

    // Registro
    async function register(e){
      e.preventDefault();
      const firstName = document.getElementById("firstName").value.trim();
      const lastName  = document.getElementById("lastName").value.trim();
      const nickname  = document.getElementById("nickname").value.trim();
      const email     = document.getElementById("email").value.trim();
      const password  = document.getElementById("password").value;
      const confirm   = document.getElementById("confirmPassword").value;
      const msg = document.getElementById("registerMsg");

      if (!firstName || !lastName || !nickname || !email || !password || !confirm)
        return setMsg(msg, "Todos los campos son obligatorios", true);
      if (password !== confirm)
        return setMsg(msg, "Las contraseñas no coinciden", true);

      const recaptchaToken = (registerRendered && widgetRegister !== null) ? grecaptcha.getResponse(widgetRegister) : "";
      if (!recaptchaToken) return setMsg(msg, "Por favor marca el reCAPTCHA", true);

      try{
        const res = await fetch(`${API_USER}/register`, {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ firstName, lastName, nickname, email, password, recaptchaToken })
        });
        const data = await res.json().catch(()=>({}));
        if (res.ok && data.ok){
          setMsg(msg, "Usuario registrado ✓");
          setTimeout(closeRegisterModal, 700);
        }else{
          setMsg(msg, data.message || `Error ${res.status}`, true);
        }
      }catch(e){
        console.error("[REGISTER] error:", e);
        setMsg(msg, "Error de conexión", true);
      }finally{
        if (registerRendered && widgetRegister !== null) { try{ grecaptcha.reset(widgetRegister) }catch{} }
      }
    }

    // Login
    async function login(e){
      e.preventDefault();
      const identifier = document.getElementById("identifier").value.trim();
      const password   = document.getElementById("loginPassword").value;
      const msg = document.getElementById("loginMsg");

      if (!identifier || !password)
        return setMsg(msg, "Ingresa apodo/email y contraseña", true);

      const recaptchaToken = widgetLogin !== null ? grecaptcha.getResponse(widgetLogin) : "";
      if (!recaptchaToken) return setMsg(msg, "Por favor marca el reCAPTCHA", true);

      try{
        const res = await fetch(`${API_USER}/login`, {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ identifier, password, recaptchaToken })
        });
        const data = await res.json().catch(()=>({}));
        if (res.ok && data.ok){
          localStorage.setItem('token', data.token);
          localStorage.setItem('user', JSON.stringify(data.user));
          setMsg(msg, "Login exitoso ✓");
          setTimeout(()=> location.href='user.html', 600);
        }else{
          setMsg(msg, data.message || `Error ${res.status}`, true);
        }
      }catch(e){
        console.error("[LOGIN] error:", e);
        setMsg(msg, "Error de conexión", true);
      }finally{
        if (widgetLogin !== null) { try{ grecaptcha.reset(widgetLogin) }catch{} }
      }
    }

    // Google Login
    async function handleGoogleLogin(response){
      const id_token = response?.credential;
      try{
        const res = await fetch(`${API_AUTH}/google`, {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ id_token })
        });
        const data = await res.json().catch(()=>({}));
        if (data.ok){
          localStorage.setItem('token', data.token);
          localStorage.setItem('user', JSON.stringify(data.user));
          location.href = 'user.html';
        }else{
          alert("Error con Google login: " + (data.message || "Desconocido"));
        }
      }catch{ alert("Fallo conexión con backend /api/auth/google"); }
    }
    window.handleGoogleLogin = handleGoogleLogin; // expone callback GSI
  </script>

  <!-- Scripts externos -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <script src="https://www.google.com/recaptcha/api.js?onload=initRecaptcha&render=explicit" async defer></script>
</body>
</html>
