<!doctype html>
<html lang="es" data-theme="dark">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>DACEM – Iniciar sesión</title>

  <!-- Fuente especial para el tagline -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Covered+By+Your+Grace&display=swap" rel="stylesheet">

  <style>
    :root,[data-theme="dark"]{
      --bg:#0b0f1a; --panel:#121a2a; --panel2:#0b1323;
      --text:#e6edf7; --muted:#93a4bc; --line:#1f2a3a;
      --accent:#60a5fa; --ring:rgba(96,165,250,.18);
      --ok:#22c55e; --err:#ef4444;

      /* Opción: GIF de burbujas (coloca img/bubbles.gif) */
      --bubbles-gif:url("img/bubbles.gif");
    }
    [data-theme="light"]{
      --bg:#f3f5fb; --panel:#ffffff; --panel2:#f7f9ff;
      --text:#172033; --muted:#6b778c; --line:#dbe2f0;
      --accent:#3b82f6; --ring:rgba(59,130,246,.18);
      --ok:#16a34a; --err:#dc2626;
      --bubbles-gif:none;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; background:var(--bg); color:var(--text);
      font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;
      display:grid; place-items:center; padding:24px 16px; overflow:hidden;
    }

    /* ================= FONDO CON BURBUJAS ================= */
    .fx-layer{
      position:fixed; inset:0; z-index:0; pointer-events:none;
      background:
        radial-gradient(1200px 800px at 50% 100%, #0a1b35 0%, transparent 70%),
        radial-gradient(800px 600px at 10% 10%,  rgba(124,92,252,.18) 0%, transparent 60%),
        radial-gradient(900px 600px at 90% 20%, rgba(96,165,250,.14) 0%, transparent 60%);
    }
    /* Capa GIF opcional */
    .fx-layer::after{
      content:""; position:absolute; inset:0; opacity:.18; mix-blend-mode:screen;
      background: var(--bubbles-gif) center/cover no-repeat;
    }
    /* Burbujas CSS */
    .fx-bubbles{position:absolute; inset:0; overflow:hidden; filter:blur(.3px)}
    .fx-bubbles span{
      position:absolute; bottom:-80px; width:8px; height:8px; border-radius:999px;
      background:radial-gradient(circle at 30% 30%, #cfe4ff, #7cc7ff 55%, #2a99ff 80%);
      opacity:.9; animation:floatUp linear infinite;
    }
    /* 12 burbujas con variaciones */
    .fx-bubbles span:nth-child(1){left:6%;  animation-duration:9s;  width:7px; height:7px}
    .fx-bubbles span:nth-child(2){left:14%; animation-duration:11s; width:9px; height:9px}
    .fx-bubbles span:nth-child(3){left:22%; animation-duration:10s; width:6px; height:6px}
    .fx-bubbles span:nth-child(4){left:30%; animation-duration:12s; width:8px; height:8px}
    .fx-bubbles span:nth-child(5){left:38%; animation-duration:9.5s; width:10px; height:10px}
    .fx-bubbles span:nth-child(6){left:46%; animation-duration:13s; width:6px; height:6px}
    .fx-bubbles span:nth-child(7){left:54%; animation-duration:10.5s; width:9px; height:9px}
    .fx-bubbles span:nth-child(8){left:62%; animation-duration:12.5s; width:7px; height:7px}
    .fx-bubbles span:nth-child(9){left:70%; animation-duration:11.5s; width:8px; height:8px}
    .fx-bubbles span:nth-child(10){left:78%; animation-duration:9.8s; width:6px; height:6px}
    .fx-bubbles span:nth-child(11){left:86%; animation-duration:12.2s; width:8px; height:8px}
    .fx-bubbles span:nth-child(12){left:94%; animation-duration:10.2s; width:7px; height:7px}

    @keyframes floatUp{
      0%{transform:translateY(0) translateX(0) scale(1); opacity:.0}
      10%{opacity:.9}
      50%{transform:translateY(-45vh) translateX(12px) scale(1.05)}
      100%{transform:translateY(-96vh) translateX(-8px) scale(1.1); opacity:0}
    }

    /* ================= Card de Login ================= */
    .auth-shell{ width:100%; display:grid; place-items:center; position:relative; z-index:1 }
    .card{
      width:min(420px, 100%); background:linear-gradient(180deg, rgba(139,92,246,.10), var(--panel) 28%);
      border:1px solid rgba(132,94,247,.28);
      border-radius:18px; padding:28px 26px;
      box-shadow:
        0 0 0 1px rgba(132,94,247,.06) inset,
        0 18px 60px rgba(12,18,35,.8),
        0 12px 36px rgba(124,92,252,.16);
      animation:slideUp .45s ease both; position:relative;
      backdrop-filter:saturate(120%) blur(6px);
    }
    .logo{display:grid; place-items:center; gap:12px; margin-bottom:14px}
    .logo-badge{
      width:120px;height:120px;border-radius:28px;
      background:linear-gradient(135deg,#5aa0ff 0%,#7c6aff 60%,#a78bfa 100%);
      display:grid;place-items:center; color:white; font-weight:800; font-size:18px;
      box-shadow:0 16px 40px rgba(0,0,0,.45), 0 0 0 10px rgba(124,92,252,.08);
      overflow:hidden; position:relative;
    }
    .logo-badge img{width:100%;height:100%;object-fit:cover;display:block;border-radius:inherit}
    .logo-badge::after{
      content:"";position:absolute;inset:0;border-radius:inherit;
      box-shadow:inset 0 0 0 2px rgba(255,255,255,.06);
    }
    h2{margin:2px 0 8px; font-size:28px}
    .tagline{
      margin:8px 0 0; 
      color:var(--text); 
      text-align:center;
      font-family:'Covered By Your Grace', cursive;
      font-size:1.5rem;
      font-weight:400;
      letter-spacing:0.5px;
      opacity:0.95;
    }
    p.muted{margin:6px 0 0; color:var(--muted); text-align:center}

    label{display:block; margin:14px 0 6px; color:var(--muted); font-size:.95rem}
    .input-wrap{position:relative}
    .input-wrap svg{position:absolute; left:12px; top:50%; transform:translateY(-50%); opacity:.6}
    input{
      width:100%; padding:13px 12px 13px 42px; border-radius:12px; background:var(--panel2); color:var(--text);
      border:1px solid var(--line); outline:none; transition:border-color .15s, box-shadow .15s, background .15s;
      font-size:1rem;
    }
    input:focus{ border-color:var(--accent); box-shadow:0 0 0 4px var(--ring) }

    /* Botón principal “Entrar” */
    .btn{
      appearance:none; border:0; cursor:pointer; width:100%;
      padding:12px 16px; border-radius:999px; font-weight:700; color:#0c1220;
      background:linear-gradient(135deg,#6aa8ff 0%,#7a66ff 50%,#a78bfa 100%);
      box-shadow:0 8px 24px rgba(96,165,250,.20), 0 0 0 1px rgba(255,255,255,.04) inset;
      transition:transform .08s ease, filter .15s ease, box-shadow .15s ease;
      margin-top:10px;
    }
    .btn:hover{ filter:brightness(1.04); box-shadow:0 10px 28px rgba(96,165,250,.28), 0 0 0 1px rgba(255,255,255,.06) inset }
    .btn:active{ transform:translateY(1px) }

    .divider{display:flex; align-items:center; gap:10px; margin:16px 0; color:var(--muted)}
    .divider::before,.divider::after{content:""; height:1px; flex:1; background:var(--line)}

    .links{display:flex; justify-content:space-between; align-items:center; margin-top:12px}
    .link{color:#a9c7ff; text-decoration:none}
    .link:hover{text-decoration:underline}

    #recaptcha-login, #recaptcha-register{ display:flex; justify-content:center; margin:10px 0 }

    /* Modal registro */
    .modal-backdrop{
      position:fixed; inset:0; background:#0008; display:none; align-items:center; justify-content:center; z-index:60;
    }
    .modal-backdrop[data-open="true"]{ display:flex }
    .modal{
      width:min(520px, 92vw); background:var(--panel); color:var(--text); border:1px solid var(--line);
      border-radius:16px; padding:24px; box-shadow:0 20px 60px rgba(0,0,0,.4); max-height:92vh; overflow:auto
    }
    .modal-head{display:flex; align-items:center; gap:8px; margin-bottom:10px}
    .modal-head h3{margin:0; font-size:1.2rem}
    .modal-close{margin-left:auto}
    .grid-2{display:grid; gap:10px; grid-template-columns:1fr 1fr}
    @media (max-width:680px){ .grid-2{ grid-template-columns:1fr } }
    
    /* Responsive para logo y tagline */
    @media (max-width:480px){
      .logo-badge{ width:95px; height:95px; border-radius:22px }
      h2{ font-size:24px }
      .tagline{ font-size:1.3rem }
    }
    @media (max-width:360px){
      .logo-badge{ width:80px; height:80px; border-radius:20px }
      h2{ font-size:22px }
      .tagline{ font-size:1.2rem }
    }

    @keyframes slideUp{from{opacity:0; transform:translateY(22px)} to{opacity:1; transform:none}}
    @keyframes shakeX {
      0%,100%{transform:translateX(0)}
      10%,30%,50%,70%,90%{transform:translateX(-5px)}
      20%,40%,60%,80%{transform:translateX(5px)}
    }
    .shake{animation:shakeX .45s}
  </style>
</head>
<body>
  <!-- FONDO EFECTO BURBUJAS -->
  <div class="fx-layer">
    <div class="fx-bubbles">
      <span></span><span></span><span></span><span></span><span></span><span></span>
      <span></span><span></span><span></span><span></span><span></span><span></span>
    </div>
  </div>

  <main class="auth-shell">
    <section class="card" id="loginCard">
      <!-- Tema -->
      <button id="themeToggle" style="position:absolute;top:16px;right:16px;background:transparent;border:1px solid var(--line);color:var(--text);width:36px;height:36px;border-radius:50%;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:.2s ease" title="Cambiar tema">
        <span id="themeIcon" style="display:flex;align-items:center;justify-content:center"></span>
      </button>

      <!-- Logo -->
      <div class="logo">
        <div class="logo-badge">
          <img src="img/Dacem.png" alt="DACEM logo">
        </div>
        <h2>DACEM</h2>
        <p class="tagline">Conecta. Descubre. Inspira</p>
      </div>

      <!-- Form -->
      <form onsubmit="login(event)">
        <label for="identifier">Apodo o Email</label>
        <div class="input-wrap">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21a8 8 0 0 0-16 0"/><circle cx="12" cy="8" r="4"/></svg>
          <input id="identifier" type="text" placeholder="tu apodo o email" required>
        </div>

        <label for="loginPassword">Contraseña</label>
        <div class="input-wrap">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
          <input id="loginPassword" type="password" placeholder="••••••••" required>
        </div>

        <div id="recaptcha-login"></div>

        <button type="submit" class="btn">Entrar</button>
        <div id="loginMsg" class="msg"></div>
      </form>

      <div class="divider"><span>o</span></div>

      <!-- Google GSI -->
      <div id="g_id_onload"
           data-client_id="661877365139-mhu54lv2ng3hngf6b5be3merjiuba4b7.apps.googleusercontent.com"
           data-callback="handleGoogleLogin"
           data-auto_prompt="false"></div>
      <div class="g_id_signin"
           data-type="standard"
           data-size="large"
           data-theme="outline"
           data-text="continue_with"
           data-shape="rectangular"
           data-logo_alignment="left"
           style="display:flex; justify-content:center"></div>

      <div class="links">
        <a class="link" href="#" onclick="openRegisterModal(event)">Crear cuenta</a>
        <a class="link" href="#">¿Olvidaste tu contraseña?</a>
      </div>
    </section>
  </main>

  <!-- Modal Registro -->
  <div class="modal-backdrop" id="register-backdrop">
    <div class="modal">
      <div class="modal-head">
        <h3>Crear cuenta</h3>
        <button class="modal-close btn small ghost" onclick="closeRegisterModal()">✕</button>
      </div>

      <form onsubmit="register(event)">
        <div class="grid-2">
          <div>
            <label for="firstName">Nombre</label>
            <input id="firstName" type="text" placeholder="Tu nombre" required>
          </div>
          <div>
            <label for="lastName">Apellido</label>
            <input id="lastName" type="text" placeholder="Tu apellido" required>
          </div>
        </div>

        <label for="nickname">Apodo</label>
        <input id="nickname" type="text" placeholder="Tu apodo único" required>

        <label for="email">Email</label>
        <div class="input-wrap">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"><path d="M4 4h16v16H4z" fill="none"/><path d="m22 6l-10 7L2 6"/></svg>
          <input id="email" type="email" placeholder="tu@email.com" required>
        </div>

        <label for="password">Contraseña</label>
        <div class="input-wrap">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
          <input id="password" type="password" placeholder="••••••••" required>
        </div>

        <label for="confirmPassword">Confirmar contraseña</label>
        <div class="input-wrap">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
          <input id="confirmPassword" type="password" placeholder="••••••••" required>
        </div>

        <div id="recaptcha-register"></div>

        <button type="submit" class="btn">Registrarse</button>
        <div id="registerMsg" class="msg"></div>
      </form>
    </div>
  </div>

  <script>
    // Redirect si ya está logueado
    if (localStorage.getItem('token')) location.href = 'user.html';

    // THEME toggle
    (function(){
      const btn   = document.getElementById('themeToggle');
      const icon  = document.getElementById('themeIcon');
      const prefersDark = matchMedia('(prefers-color-scheme: dark)').matches;
      const saved = localStorage.getItem('theme');
      const start = saved || (prefersDark ? 'dark' : 'light');
      document.documentElement.setAttribute('data-theme', start);
      setBtn(start);

      btn.addEventListener('click', () => {
        const curr = document.documentElement.getAttribute('data-theme') || 'dark';
        const next = curr === 'dark' ? 'light' : 'dark';
        document.documentElement.setAttribute('data-theme', next);
        localStorage.setItem('theme', next);
        setBtn(next);
      });

      function setBtn(mode){
        btn.title = mode === 'dark' ? 'Modo claro' : 'Modo oscuro';
        icon.innerHTML = mode === 'dark'
          ? `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="5"></circle><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/></svg>`
          : `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12.79A9 9 0 1 1 11.21 3A7 7 0 0 0 21 12.79z"/></svg>`;
      }
    })();

    // API
    const API_USER = `${location.origin}/api/user`;
    const API_AUTH = `${location.origin}/api/auth`;
    const RECAPTCHA_SITE_KEY = "6LcMNc8rAAAAADgevHmG75S_cJPmydAOFEfo8lib";

    // reCAPTCHA
    let widgetLogin = null;
    let widgetRegister = null;
    let registerRendered = false;

    function initRecaptcha() {
      try {
        widgetLogin = grecaptcha.render("recaptcha-login", {
          sitekey: RECAPTCHA_SITE_KEY,
          theme: document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'light'
        });
      } catch (e) {
        console.warn("[reCAPTCHA] login aún no disponible:", e);
      }
    }
    function ensureRegisterRecaptcha() {
      if (registerRendered) return;
      if (!window.grecaptcha || !grecaptcha.render) return;
      widgetRegister = grecaptcha.render("recaptcha-register", {
        sitekey: RECAPTCHA_SITE_KEY,
        theme: document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'light'
      });
      registerRendered = true;
    }

    // Modales registro
    function openRegisterModal(e){
      e?.preventDefault?.();
      document.getElementById('register-backdrop').setAttribute('data-open','true');
      document.body.style.overflow='hidden';
      ensureRegisterRecaptcha();
    }
    function closeRegisterModal(){
      document.getElementById('register-backdrop').removeAttribute('data-open');
      document.body.style.overflow='auto';
      const msg = document.getElementById('registerMsg');
      msg.textContent=''; msg.className='msg';
      if (registerRendered && widgetRegister!==null) try{grecaptcha.reset(widgetRegister)}catch{}
    }

    // Mensajes
    function setMsg(el, text, isError=false){
      el.textContent = text;
      el.className = 'msg ' + (isError ? 'error' : 'success');
      if (isError && el.id==='loginMsg'){
        const card = document.getElementById('loginCard');
        card.classList.remove('shake'); void card.offsetWidth; card.classList.add('shake');
      }
    }

    // Registro
    async function register(e){
      e.preventDefault();
      const firstName = document.getElementById("firstName").value.trim();
      const lastName  = document.getElementById("lastName").value.trim();
      const nickname  = document.getElementById("nickname").value.trim();
      const email     = document.getElementById("email").value.trim();
      const password  = document.getElementById("password").value;
      const confirm   = document.getElementById("confirmPassword").value;
      const msg = document.getElementById("registerMsg");

      if (!firstName || !lastName || !nickname || !email || !password || !confirm)
        return setMsg(msg, "Todos los campos son obligatorios", true);
      if (password !== confirm)
        return setMsg(msg, "Las contraseñas no coinciden", true);

      const recaptchaToken = (registerRendered && widgetRegister !== null) ? grecaptcha.getResponse(widgetRegister) : "";
      if (!recaptchaToken) return setMsg(msg, "Por favor marca el reCAPTCHA", true);

      try{
        const res = await fetch(`${API_USER}/register`, {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ firstName, lastName, nickname, email, password, recaptchaToken })
        });
        const data = await res.json().catch(()=>({}));
        if (res.ok && data.ok){
          setMsg(msg, "Usuario registrado ✓");
          setTimeout(closeRegisterModal, 700);
        }else{
          setMsg(msg, data.message || `Error ${res.status}`, true);
        }
      }catch(e){
        console.error("[REGISTER] error:", e);
        setMsg(msg, "Error de conexión", true);
      }finally{
        if (registerRendered && widgetRegister !== null) { try{ grecaptcha.reset(widgetRegister) }catch{} }
      }
    }

    // Login
    async function login(e){
      e.preventDefault();
      const identifier = document.getElementById("identifier").value.trim();
      const password   = document.getElementById("loginPassword").value;
      const msg = document.getElementById("loginMsg");

      if (!identifier || !password)
        return setMsg(msg, "Ingresa apodo/email y contraseña", true);

      const recaptchaToken = widgetLogin !== null ? grecaptcha.getResponse(widgetLogin) : "";
      if (!recaptchaToken) return setMsg(msg, "Por favor marca el reCAPTCHA", true);

      try{
        const res = await fetch(`${API_USER}/login`, {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ identifier, password, recaptchaToken })
        });
        const data = await res.json().catch(()=>({}));
        if (res.ok && data.ok){
          localStorage.setItem('token', data.token);
          localStorage.setItem('user', JSON.stringify(data.user));
          setMsg(msg, "Login exitoso ✓");
          setTimeout(()=> location.href='user.html', 600);
        }else{
          setMsg(msg, data.message || `Error ${res.status}`, true);
        }
      }catch(e){
        console.error("[LOGIN] error:", e);
        setMsg(msg, "Error de conexión", true);
      }finally{
        if (widgetLogin !== null) { try{ grecaptcha.reset(widgetLogin) }catch{} }
      }
    }

    // Google Login
    async function handleGoogleLogin(response){
      const id_token = response?.credential;
      try{
        const res = await fetch(`${API_AUTH}/google`, {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ id_token })
        });
        const data = await res.json().catch(()=>({}));
        if (data.ok){
          localStorage.setItem('token', data.token);
          localStorage.setItem('user', JSON.stringify(data.user));
          location.href = 'user.html';
        }else{
          alert("Error con Google login: " + (data.message || "Desconocido"));
        }
      }catch{ alert("Fallo conexión con backend /api/auth/google"); }
    }
    window.handleGoogleLogin = handleGoogleLogin;
  </script>

  <!-- Scripts externos -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <script src="https://www.google.com/recaptcha/api.js?onload=initRecaptcha&render=explicit" async defer></script>
</body>
</html>
