<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DACEM - Iniciar sesión</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html, body {
      height: 100%;
      font-family: 'Segoe UI', system-ui, Roboto, Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .login-container {
      width: 100%;
      max-width: 440px;
      padding: 20px;
    }

    .login-card {
      background: white;
      border-radius: 16px;
      padding: 40px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      animation: slideUp 0.6s ease;
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes shakeX {
      0%, 100% { transform: translateX(0); }
      10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
      20%, 40%, 60%, 80% { transform: translateX(5px); }
    }

    .login-card.shake {
      animation: shakeX 0.5s;
    }

    .logo {
      text-align: center;
      margin-bottom: 32px;
    }

    .logo-icon {
      width: 56px;
      height: 56px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 28px;
      color: white;
      margin: 0 auto 16px;
    }

    .logo h1 {
      font-size: 28px;
      font-weight: 700;
      color: #1a1a1a;
      margin: 0;
    }

    .logo p {
      color: #666;
      font-size: 14px;
      margin-top: 8px;
    }

    .form-group {
      margin-bottom: 20px;
    }

    label {
      display: block;
      font-weight: 600;
      color: #333;
      margin-bottom: 8px;
      font-size: 14px;
    }

    .input-wrapper {
      position: relative;
      display: flex;
      align-items: center;
    }

    .input-wrapper i {
      position: absolute;
      left: 12px;
      color: #999;
      pointer-events: none;
    }

    input[type="text"],
    input[type="email"],
    input[type="password"] {
      width: 100%;
      padding: 12px 12px 12px 40px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 14px;
      transition: all 0.3s ease;
      font-family: inherit;
    }

    input[type="text"]:focus,
    input[type="email"]:focus,
    input[type="password"]:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .btn {
      width: 100%;
      padding: 12px;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      font-size: 15px;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      font-family: inherit;
    }

    .btn.primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .btn.primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
    }

    .msg {
      margin-top: 12px;
      padding: 12px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      text-align: center;
      display: none;
    }

    .msg.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }

    .msg.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }

    .divider {
      display: flex;
      align-items: center;
      gap: 10px;
      margin: 24px 0;
      color: #999;
      font-size: 14px;
    }

    .divider::before,
    .divider::after {
      content: '';
      flex: 1;
      height: 1px;
      background: #ddd;
    }

    .footer-links {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 13px;
      margin-top: 20px;
      color: #666;
    }

    .footer-links a {
      color: #667eea;
      text-decoration: none;
      font-weight: 600;
      cursor: pointer;
      transition: color 0.3s ease;
    }

    .footer-links a:hover {
      color: #764ba2;
    }

    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 60;
    }

    .modal-backdrop[data-open="true"] {
      display: flex;
    }

    .modal {
      background: white;
      border-radius: 16px;
      padding: 32px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      width: min(500px, 90vw);
      max-height: 90vh;
      overflow-y: auto;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
    }

    .modal-header h2 {
      font-size: 24px;
      color: #1a1a1a;
      margin: 0;
    }

    .modal-close {
      background: none;
      border: none;
      font-size: 24px;
      color: #999;
      cursor: pointer;
      transition: color 0.3s ease;
    }

    .modal-close:hover {
      color: #333;
    }

    .modal-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 14px;
    }

    #recaptcha-login,
    #recaptcha-register {
      display: flex;
      justify-content: center;
      margin: 16px 0;
    }

    @media (max-width: 600px) {
      .modal-grid {
        grid-template-columns: 1fr;
      }

      .login-card {
        padding: 24px;
      }

      .logo h1 {
        font-size: 22px;
      }

      .btn {
        padding: 10px;
        font-size: 14px;
      }
    }
  </style>
</head>
<body>
  <div class="login-container">
    <div class="login-card" id="loginCard">
      <div class="logo">
        <div class="logo-icon">
          <i class="fas fa-circle"></i>
        </div>
        <h1>DACEM</h1>
        <p>Tu red social conectada</p>
      </div>

      <form onsubmit="login(event)">
        <div class="form-group">
          <label for="identifier">Apodo o Email</label>
          <div class="input-wrapper">
            <i class="fas fa-user"></i>
            <input id="identifier" type="text" placeholder="tu apodo o email" required>
          </div>
        </div>

        <div class="form-group">
          <label for="loginPassword">Contraseña</label>
          <div class="input-wrapper">
            <i class="fas fa-lock"></i>
            <input id="loginPassword" type="password" placeholder="••••••••" required>
          </div>
        </div>

        <div id="recaptcha-login"></div>

        <button type="submit" class="btn primary">
          <i class="fas fa-sign-in-alt"></i> Entrar
        </button>

        <div id="loginMsg" class="msg"></div>
      </form>

      <div class="divider"><span>o</span></div>

      <div
        id="g_id_onload"
        data-client_id="661877365139-mhu54lv2ng3hngf6b5be3merjiuba4b7.apps.googleusercontent.com"
        data-callback="handleGoogleLogin"
        data-auto_prompt="false">
      </div>
      <div class="g_id_signin"
           data-type="standard"
           data-size="large"
           data-theme="outline"
           data-text="continue_with"
           data-shape="rectangular"
           data-logo_alignment="left"
           style="display: flex; justify-content: center;">
      </div>

      <div class="footer-links">
        <a href="#" onclick="openRegisterModal(event)">Crear cuenta</a>
        <a href="#">¿Olvidaste tu contraseña?</a>
      </div>
    </div>
  </div>

  <div class="modal-backdrop" id="register-backdrop">
    <div class="modal">
      <div class="modal-header">
        <h2>Crear cuenta</h2>
        <button class="modal-close" onclick="closeRegisterModal()">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <form onsubmit="register(event)">
        <div class="modal-grid">
          <div class="form-group">
            <label for="firstName">Nombre</label>
            <input id="firstName" type="text" placeholder="Tu nombre" required>
          </div>
          <div class="form-group">
            <label for="lastName">Apellido</label>
            <input id="lastName" type="text" placeholder="Tu apellido" required>
          </div>
        </div>

        <div class="form-group">
          <label for="nickname">Apodo</label>
          <input id="nickname" type="text" placeholder="Tu apodo único" required>
        </div>

        <div class="form-group">
          <label for="email">Email</label>
          <div class="input-wrapper">
            <i class="fas fa-envelope"></i>
            <input id="email" type="email" placeholder="tu@email.com" required>
          </div>
        </div>

        <div class="form-group">
          <label for="password">Contraseña</label>
          <div class="input-wrapper">
            <i class="fas fa-lock"></i>
            <input id="password" type="password" placeholder="••••••••" required>
          </div>
        </div>

        <div class="form-group">
          <label for="confirmPassword">Confirmar contraseña</label>
          <div class="input-wrapper">
            <i class="fas fa-lock"></i>
            <input id="confirmPassword" type="password" placeholder="••••••••" required>
          </div>
        </div>

        <div id="recaptcha-register"></div>

        <button type="submit" class="btn primary">
          <i class="fas fa-user-plus"></i> Registrarse
        </button>

        <div id="registerMsg" class="msg"></div>
      </form>
    </div>
  </div>

  <script>
    const API_USER = `${location.origin}/api/user`;
    const API_AUTH = `${location.origin}/api/auth`;
    const RECAPTCHA_SITE_KEY = "6LcMNc8rAAAAADgevHmG75S_cJPmydAOFEfo8lib";

    let widgetLogin = null;
    let widgetRegister = null;
    let registerRendered = false;

    function initRecaptcha() {
      try {
        widgetLogin = grecaptcha.render("recaptcha-login", {
          sitekey: RECAPTCHA_SITE_KEY,
          theme: "light"
        });
      } catch (e) {
        console.warn("[reCAPTCHA] login no disponible:", e);
      }
    }

    function ensureRegisterRecaptcha() {
      if (registerRendered) return;
      if (!window.grecaptcha || !grecaptcha.render) return;
      widgetRegister = grecaptcha.render("recaptcha-register", {
        sitekey: RECAPTCHA_SITE_KEY,
        theme: "light"
      });
      registerRendered = true;
    }

    function openRegisterModal(e) {
      e.preventDefault();
      const bd = document.getElementById('register-backdrop');
      bd.setAttribute('data-open', 'true');
      document.body.style.overflow = 'hidden';
      ensureRegisterRecaptcha();
    }

    function closeRegisterModal() {
      const bd = document.getElementById('register-backdrop');
      bd.removeAttribute('data-open');
      document.body.style.overflow = 'auto';

      if (registerRendered && widgetRegister !== null) {
        try { grecaptcha.reset(widgetRegister); } catch {}
      }
      const msg = document.getElementById('registerMsg');
      msg.textContent = '';
      msg.style.display = 'none';
    }

    function setMsg(el, text, isError = false) {
      el.textContent = text;
      el.className = "msg " + (isError ? "error" : "success");
      el.style.display = 'block';

      if (isError && el.id === 'loginMsg') {
        const card = document.getElementById('loginCard');
        card.classList.remove('shake');
        void card.offsetWidth;
        card.classList.add('shake');
      }
    }

    async function register(e) {
      e.preventDefault();

      const firstName = document.getElementById("firstName").value.trim();
      const lastName = document.getElementById("lastName").value.trim();
      const nickname = document.getElementById("nickname").value.trim();
      const email = document.getElementById("email").value.trim();
      const password = document.getElementById("password").value;
      const confirm = document.getElementById("confirmPassword").value;
      const msg = document.getElementById("registerMsg");

      if (!firstName || !lastName || !nickname || !email || !password || !confirm) {
        return setMsg(msg, "Todos los campos son obligatorios", true);
      }
      if (password !== confirm) {
        return setMsg(msg, "Las contraseñas no coinciden", true);
      }

      const recaptchaToken = (registerRendered && widgetRegister !== null)
        ? grecaptcha.getResponse(widgetRegister)
        : "";
      if (!recaptchaToken) return setMsg(msg, "Por favor marca el reCAPTCHA", true);

      try {
        const res = await fetch(`${API_USER}/register`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ firstName, lastName, nickname, email, password, recaptchaToken })
        });
        const data = await res.json().catch(() => ({}));

        if (res.ok && data.ok) {
          setMsg(msg, "Usuario registrado ✓");
          setTimeout(closeRegisterModal, 700);
        } else {
          setMsg(msg, data.message || `Error ${res.status}`, true);
        }
      } catch (e) {
        console.error("[REGISTER] fetch error:", e);
        setMsg(msg, "Error de conexión", true);
      } finally {
        if (registerRendered && widgetRegister !== null) {
          try { grecaptcha.reset(widgetRegister); } catch {}
        }
      }
    }

    async function login(e) {
      e.preventDefault();

      const identifier = document.getElementById("identifier").value.trim();
      const password = document.getElementById("loginPassword").value;
      const msg = document.getElementById("loginMsg");

      if (!identifier || !password) {
        return setMsg(msg, "Ingresa apodo/email y contraseña", true);
      }

      const recaptchaToken = widgetLogin !== null ? grecaptcha.getResponse(widgetLogin) : "";
      if (!recaptchaToken) return setMsg(msg, "Por favor marca el reCAPTCHA", true);

      try {
        const res = await fetch(`${API_USER}/login`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ identifier, password, recaptchaToken })
        });
        const data = await res.json().catch(() => ({}));

        if (res.ok && data.ok) {
          localStorage.setItem("token", data.token);
          localStorage.setItem("user", JSON.stringify(data.user));
          setMsg(msg, "Login exitoso ✓");
          setTimeout(() => (window.location.href = "user.html"), 600);
        } else {
          setMsg(msg, data.message || `Error ${res.status}`, true);
        }
      } catch (e) {
        console.error("[LOGIN] fetch error:", e);
        setMsg(msg, "Error de conexión", true);
      } finally {
        if (widgetLogin !== null) {
          try { grecaptcha.reset(widgetLogin); } catch {}
        }
      }
    }

    async function handleGoogleLogin(response) {
      const id_token = response.credential;
      try {
        const res = await fetch(`${API_AUTH}/google`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ id_token })
        });
        const data = await res.json();
        if (data.ok) {
          localStorage.setItem("token", data.token);
          localStorage.setItem("user", JSON.stringify(data.user));
          window.location.href = "user.html";
        } else {
          alert("Error con Google login: " + (data.message || "Desconocido"));
        }
      } catch {
        alert("Fallo conexión con backend /api/auth/google");
      }
    }
  </script>

  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <script src="https://www.google.com/recaptcha/api.js?onload=initRecaptcha&render=explicit" async defer></script>
</body>
</html>