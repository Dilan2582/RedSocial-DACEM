<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Perfil ‚Äì DACEM</title>
  <link rel="stylesheet" href="css/profile.css">
  <style>
    /* IG grid compacto */
    #profilePosts{ max-width:935px; margin:0 auto }
    .grid-ig{ display:grid; grid-template-columns:repeat(3,1fr); gap:12px }
    .ig-item{ position:relative; aspect-ratio:1/1; overflow:hidden; border-radius:12px; background:var(--panel2) }
    .ig-item img{ width:100%; height:100%; object-fit:cover; display:block }
    @media (max-width:1024px){ #profilePosts{ max-width:90vw } }

    /* Modal tipo Instagram */
    .lightbox{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.6); z-index:60 }
    .lightbox[aria-hidden="false"]{ display:flex }
    .lb-content{ position:relative; width:min(935px,96vw); height:min(90vh,820px); display:flex; background:var(--panel); border-radius:14px; overflow:hidden; box-shadow:0 10px 30px rgba(0,0,0,.35) }
    .lb-media{ flex:1 1 65%; background:#000; display:flex; align-items:center; justify-content:center }
    .lb-media img{ max-width:100%; max-height:100%; object-fit:contain; display:block }
    .lb-side{ flex:1 1 35%; display:flex; flex-direction:column; border-left:1px solid var(--line); background:var(--panel) }
    .lb-head{ display:flex; align-items:center; gap:10px; padding:12px; border-bottom:1px solid var(--line) }
    .lb-ava{ width:36px; height:36px; border-radius:999px; object-fit:cover }
    .lb-body{ flex:1; overflow:auto; padding:12px }
    .lb-cmt{ margin-bottom:10px; line-height:1.35 }
    .lb-cmt .nm{ font-weight:600; margin-right:8px }
    .lb-cmt .dt{ color:var(--muted); font-size:12px; margin-left:8px }
    .lb-input{ display:flex; gap:8px; padding:10px; border-top:1px solid var(--line) }
    .lb-input input{ flex:1; padding:10px 12px; border:1px solid var(--line); background:var(--panel2); color:var(--text); border-radius:10px }
    .lb-close{ position:absolute; top:8px; right:8px }
  </style>
</head>
<body>
  <!-- Topbar -->
  <header class="topbar">
    <div class="topbar-inner">
      <div class="brand">DACEM</div>
      <div class="topbar-actions">
        <button id="logoutBtnTop" class="btn danger small">Cerrar sesi√≥n</button>
      </div>
    </div>
  </header>

  <div class="wrap">
    <div class="layout">
      <aside class="sidebar">
        <nav class="nav">
          <a class="nav-item" href="user.html"><span class="nav-ico">üè†</span> Inicio</a>
          <a class="nav-item active" href="profile.html"><span class="nav-ico">üë§</span> Mi perfil</a>
        </nav>
      </aside>

      <!-- Main -->
      <main class="main">
        <section class="cover"><div id="banner" class="cover-img"></div></section>

        <section class="head">
          <div class="avatar">
            <img id="avatarImg" class="avatar-img" alt="avatar">
            <div id="avatarTxt" class="avatar-txt">U</div>
          </div>

          <div class="who">
            <div class="name-row">
              <span id="nameTxt" class="name">Perfil</span>
              <span id="verified" class="badge" title="Verificado">‚úî</span>
            </div>
            <div class="username">@<span id="usernameTxt">usuario</span></div>
            <div class="counts">
              <button class="link ghost" id="btnOpenFollowing"><b id="followingCnt">0</b> siguiendo</button> ¬∑
              <button class="link ghost" id="btnOpenFollowers"><b id="followersCnt">0</b> seguidores</button>
            </div>
          </div>

          <div class="actions">
            <button id="btnFollow" class="btn" style="display:none">Seguir</button>
            <button id="btnEdit" class="btn secondary" style="display:none">Editar perfil</button>
          </div>
        </section>

        <section class="card"><div class="bio" id="bioTxt">NoBioYet</div></section>
      </main>
    </div>
  </div>

  <!-- Grid de publicaciones -->
  <section class="card" id="profilePosts">
    <h3 style="margin:0 0 12px">Publicaciones</h3>
    <div class="grid-ig" id="gridIg"></div>
  </section>

  <!-- Visor post -->
  <div class="lightbox" id="lightbox" aria-hidden="true">
    <div class="lb-content" role="dialog" aria-modal="true" aria-label="Publicaci√≥n">
      <button class="btn ghost small lb-close" id="lbClose">‚úï</button>
      <div class="lb-media"><img id="lbImg" alt=""></div>
      <aside class="lb-side">
        <header class="lb-head">
          <img id="lbAva" class="lb-ava" alt="">
          <div>
            <div id="lbName" style="font-weight:700"></div>
            <div id="lbUser" class="muted" style="font-size:12px"></div>
          </div>
        </header>
        <div class="lb-body" id="lbComments"></div>
        <div class="lb-input">
          <input id="lbInp" placeholder="A√±ade un comentario‚Ä¶">
          <button id="lbSend" class="btn">Publicar</button>
        </div>
      </aside>
    </div>
  </div>

  <!-- MODAL EDITAR PERFIL -->
  <div id="editModal" class="backdrop">
    <div class="modal">
      <div class="modal-head">
        <h3>Editar perfil</h3>
        <button class="btn ghost" id="closeEdit">Cerrar</button>
      </div>
      <div class="modal-body">
        <div class="banner-edit">
          <div id="bannerPreview" class="banner-preview"></div>
          <input id="bannerFile" type="file" accept="image/*" hidden>
          <button class="btn" id="btnPickBanner">Cambiar banner</button>
        </div>

        <div class="avatar-edit">
          <div class="avatar avatar-xl">
            <img id="avatarPreview" class="avatar-img" alt="">
            <div id="avatarPreviewTxt" class="avatar-txt">U</div>
          </div>
          <input id="avatarFile" type="file" accept="image/*" hidden>
          <button class="btn" id="btnPickAvatar">Cambiar foto</button>
        </div>

        <div class="form">
          <label>Apodo</label>
          <input id="nicknameInp" placeholder="tuapodo">
          <label>Bio (opcional)</label>
          <textarea id="bioInp" rows="3" maxlength="240" placeholder="Algo sobre ti..."></textarea>
        </div>
      </div>

      <div class="modal-foot">
        <span id="saveMsg" class="muted"></span>
        <button class="btn" id="btnSave">Guardar cambios</button>
      </div>
    </div>
  </div>

  <!-- MODAL FOLLOWERS / FOLLOWING -->
  <div id="followModal" class="backdrop">
    <div class="modal" style="max-width:640px">
      <div class="modal-head" style="justify-content:space-between; gap:12px;">
        <div class="tabs" id="followTabs">
          <button class="btn ghost small active" data-tab="followers">Seguidores</button>
          <button class="btn ghost small" data-tab="following">Siguiendo</button>
        </div>
        <button class="btn ghost" id="closeFollow">Cerrar</button>
      </div>

      <div class="modal-body" style="display:flex; flex-direction:column; gap:12px;">
        <input id="followSearch" placeholder="Buscar" class="input" />
        <div id="followList" class="list-users"></div>
        <div style="text-align:center;">
          <button id="followMore" class="btn" style="display:none">Cargar m√°s</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ===== Helpers / API =====
    const API = (p)=>`${location.origin}/api${p}`;
    const token = localStorage.getItem('token');
    if(!token){ location.replace('index.html'); }
    const H  = { 'Authorization':`Bearer ${token}` };
    const JH = { ...H, 'Content-Type':'application/json' };
    const $  = s => document.querySelector(s);
    const qs = new URLSearchParams(location.search);
    const viewId = qs.get('id');

    let me=null, other=null, isFollowing=false;

    const displayName = (u)=> u.name || `${u.firstName||''} ${u.lastName||''}`.trim() || (u.nickname || 'Usuario');
    const initialLetter= (u)=> (u.firstName?.[0] || u.name?.[0] || u.nickname?.[0] || 'U').toUpperCase();
    const abs = (url)=>!url ? '' : (url.startsWith('http') ? url : `${location.origin}${url.startsWith('/')?url:'/'+url}`);
    function setAvatarBox(imgEl, txtEl, u){
      if (u.avatar){ imgEl.src = abs(u.avatar); imgEl.style.display='block'; txtEl.style.display='none'; }
      else { imgEl.removeAttribute('src'); imgEl.style.display='none'; txtEl.textContent = initialLetter(u); txtEl.style.display='flex'; }
    }
    function resolveAvatar(u){
      if (!u) return `https://api.dicebear.com/8.x/initials/svg?seed=U&radius=50&scale=110&fontWeight=700`;
      if (u.avatar) return u.avatar.startsWith('http') ? u.avatar : `${location.origin}${u.avatar.startsWith('/')?u.avatar:'/'+u.avatar}`;
      const seed = encodeURIComponent((u.firstName || u.name || u.nickname || 'U'));
      return `https://api.dicebear.com/8.x/initials/svg?seed=${seed}&radius=50&scale=110&fontWeight=700`;
    }

    // ===== FOLLOW MODAL =====
    const followModal  = document.getElementById('followModal');
    const followTabs   = document.getElementById('followTabs');
    const followList   = document.getElementById('followList');
    const followMore   = document.getElementById('followMore');
    const followSearch = document.getElementById('followSearch');
    document.getElementById('closeFollow').onclick = ()=> followModal.removeAttribute('data-open');

    // Estado relaci√≥n cacheado por id (si YO lo sigo)
    const REL_STATE = new Map(); // id -> boolean

    let FOLLOW_STATE = { tab:'followers', userId:null, cursor:null, cache:[] };

    function openFollowModal(tab, userId){
      FOLLOW_STATE = { tab, userId, cursor:null, cache:[] };
      [...followTabs.querySelectorAll('button')].forEach(b=> b.classList.toggle('active', b.dataset.tab===tab));
      followSearch.value = '';
      followList.innerHTML = '<div class="muted">Cargando...</div>';
      followModal.setAttribute('data-open','true');
      loadFollowPage(true);
    }

    async function loadFollowPage(first=false){
      const limit = 20;
      const url = new URL(API(`/follow/${FOLLOW_STATE.userId}/${FOLLOW_STATE.tab}`));
      url.searchParams.set('limit', String(limit));
      if (FOLLOW_STATE.cursor) url.searchParams.set('cursor', FOLLOW_STATE.cursor);
      const r = await fetch(url.toString(), { headers:H });
      const d = await r.json();
      if (!d.ok){ followList.innerHTML = '<div class="muted">No disponible</div>'; return; }

      if (first) { followList.innerHTML = ''; FOLLOW_STATE.cache = []; }
      (d.users || []).forEach(u => FOLLOW_STATE.cache.push(u));
      FOLLOW_STATE.cursor = d.nextCursor || null;
      followMore.style.display = FOLLOW_STATE.cursor ? 'inline-block' : 'none';
      renderFollowList();
    }

    // Pide /user/:id/public para saber si YA lo sigo (followers tab)
    async function ensureFollowFlag(id){
      if (REL_STATE.has(id)) return REL_STATE.get(id);
      try{
        const rr = await fetch(API(`/user/${id}/public`), { headers:H });
        const dd = await rr.json();
        const val = !!dd.isFollowing;
        REL_STATE.set(id, val);
        return val;
      }catch{ return false; }
    }

    function rowTemplate(u, followingNow){
      const row = document.createElement('div');
      row.className='user-row';
      row.innerHTML = `
        <img src="${resolveAvatar(u)}" alt="">
        <div class="u-info">
          <div class="u-name">${displayName(u)}</div>
          <div class="u-nick">@${u.nickname || 'usuario'}</div>
        </div>
        <div class="u-actions">
          <a class="btn ghost small" href="profile.html?id=${u.id}">Ver</a>
          <button class="btn small follow-toggle">${followingNow ? 'Dejar de seguir' : 'Seguir'}</button>
        </div>`;
      return row;
    }

    async function renderFollowList(){
      const q = followSearch.value.trim().toLowerCase();
      followList.innerHTML = '';
      const rows = FOLLOW_STATE.cache.filter(u => {
        if (!q) return true;
        const s = `${u.firstName||''} ${u.lastName||''} ${u.nickname||''}`.toLowerCase();
        return s.includes(q);
      });
      if (!rows.length){ followList.innerHTML = '<div class="muted">Sin resultados</div>'; return; }

      for (const u of rows){
        let followingNow = FOLLOW_STATE.tab === 'following' ? true : REL_STATE.get(u.id);
        const row = rowTemplate(u, !!followingNow);
        const btn = row.querySelector('.follow-toggle');

        // Si estamos en "Seguidores" y no sabemos el estado, lo resolvemos y actualizamos el bot√≥n
        if (FOLLOW_STATE.tab === 'followers' && followingNow === undefined){
          ensureFollowFlag(u.id).then(val=>{
            const current = REL_STATE.get(u.id);
            btn.textContent = current ? 'Dejar de seguir' : 'Seguir';
          });
        }

        btn.onclick = async ()=>{
          btn.disabled = true;
          try{
            // Usamos toggle; si 404, fallback manual POST/DELETE
            const r = await fetch(API(`/follow/toggle/${u.id}`), { method:'POST', headers:H });
            if (r.status !== 404){
              const d = await r.json();
              if (d.ok){
                const newVal = FOLLOW_STATE.tab==='following' ? false : !(REL_STATE.get(u.id) || false);
                REL_STATE.set(u.id, d.following ?? newVal);
              }
            }else{
              const currently = FOLLOW_STATE.tab==='following' ? true : (REL_STATE.get(u.id) || false);
              const m = currently ? 'DELETE' : 'POST';
              const r2 = await fetch(API(`/follow/${u.id}`), { method:m, headers:H });
              const d2 = await r2.json();
              if (d2.ok) REL_STATE.set(u.id, !currently);
            }
          } finally {
            const now = REL_STATE.get(u.id) || false;
            // Si estamos en "Siguiendo" y ya no sigo => elimino fila y bajo contador
            if (FOLLOW_STATE.tab==='following' && !now){
              row.remove();
              const cntEl = document.getElementById('followingCnt');
              if (cntEl) cntEl.textContent = Math.max(0, (+cntEl.textContent||1) - 1);
            }else{
              btn.textContent = now ? 'Dejar de seguir' : 'Seguir';
            }
            btn.disabled = false;
          }
        };

        followList.appendChild(row);
      }
    }

    followMore.onclick = ()=> loadFollowPage(false);
    followSearch.oninput = ()=> renderFollowList();
    followTabs.addEventListener('click', (e)=>{ const b=e.target.closest('button[data-tab]'); if(!b) return; openFollowModal(b.dataset.tab, FOLLOW_STATE.userId); });

    document.getElementById('btnOpenFollowers').onclick = ()=>{
      const uid = (viewId && viewId!==(me?._id||'')) ? viewId : (me?._id || '');
      openFollowModal('followers', uid);
    };
    document.getElementById('btnOpenFollowing').onclick = ()=>{
      const uid = (viewId && viewId!==(me?._id||'')) ? viewId : (me?._id || '');
      openFollowModal('following', uid);
    };

    // ===== Perfil =====
    function paintProfile(u, counts){
      const hasBanner = !!u.banner;
      $('#banner').style.backgroundImage = hasBanner ? `url(${abs(u.banner)})` : 'none';
      document.querySelector('.main').classList.toggle('has-banner', hasBanner);
      $('#nameTxt').textContent = displayName(u);
      $('#usernameTxt').textContent = u.nickname || 'usuario';
      $('#followersCnt').textContent = counts?.followers ?? 0;
      $('#followingCnt').textContent = counts?.following ?? 0;
      $('#verified').style.display = u.isVerified ? 'inline' : 'none';
      setAvatarBox($('#avatarImg'), $('#avatarTxt'), u);
      $('#bioTxt').textContent = (u.bio && u.bio.trim()) ? u.bio : 'NoBioYet';
    }

    async function loadMe(){
      const r = await fetch(API('/user/me'), { headers:H });
      const d = await r.json();
      if(!d.ok){ localStorage.removeItem('token'); return location.replace('index.html'); }
      me = d.user; return { user:d.user, counts:d.counts };
    }
    async function loadOther(id){
      const r = await fetch(API(`/user/${id}/public`), { headers:H });
      const d = await r.json();
      if(!d.ok) throw new Error(d.message || 'No encontrado');
      other = d.user; isFollowing = !!d.isFollowing;
      return { user:d.user, counts:d.counts };
    }

    async function toggleFollow(){
      $('#btnFollow').disabled = true;
      const tryToggle = await fetch(API(`/follow/toggle/${other._id}`), { method:'POST', headers:H });
      if (tryToggle.status !== 404){
        const d = await tryToggle.json(); if (d.ok) isFollowing = !isFollowing;
      }else{
        const r = await fetch(API(`/follow/${other._id}`), { method: isFollowing ? 'DELETE' : 'POST', headers:H });
        const d = await r.json(); if (d.ok) isFollowing = !isFollowing;
      }
      $('#btnFollow').textContent = isFollowing ? 'Dejar de seguir' : 'Seguir';
      $('#btnFollow').disabled = false;
    }

    // ===== Editar perfil =====
    const modal = $('#editModal');
    const openModal  = ()=> modal.setAttribute('data-open','true');
    const closeModal = ()=> modal.removeAttribute('data-open');
    $('#closeEdit').onclick = closeModal;

    function prefillEdit(){
      $('#bannerPreview').style.backgroundImage = me.banner ? `url(${abs(me.banner)})` : 'none';
      setAvatarBox($('#avatarPreview'), $('#avatarPreviewTxt'), me);
      $('#nicknameInp').value = me.nickname || '';
      $('#bioInp').value = me.bio || '';
      $('#saveMsg').textContent = '';
    }
    $('#btnPickBanner').onclick = ()=> $('#bannerFile').click();
    $('#btnPickAvatar').onclick = ()=> $('#avatarFile').click();

    $('#bannerFile').addEventListener('change', async (e)=>{
      const f = e.target.files?.[0]; if(!f) return;
      const fd = new FormData(); fd.append('banner', f);
      const r = await fetch(API('/user/me/banner'), { method:'PUT', headers:H, body:fd });
      const d = await r.json();
      if (d.ok){
        $('#bannerPreview').style.backgroundImage = `url(${d.banner})`;
        $('#banner').style.backgroundImage = `url(${d.banner})`;
        document.querySelector('.main').classList.add('has-banner');
      }
      e.target.value = '';
    });

    $('#avatarFile').addEventListener('change', async (e)=>{
      const f = e.target.files?.[0]; if(!f) return;
      const fd = new FormData(); fd.append('avatar', f);
      const r = await fetch(API('/user/me/avatar'), { method:'POST', headers:H, body:fd });
      const d = await r.json();
      if (d.ok){ await refreshMe(); }
      e.target.value = '';
    });

    async function refreshMe(){
      const r = await fetch(API('/user/me'), { headers:H });
      const d = await r.json();
      if (d.ok){ me = d.user; paintProfile(me, d.counts); prefillEdit(); }
    }
    $('#btnSave').onclick = async ()=>{
      $('#saveMsg').textContent = 'Guardando...';
      const payload = { nickname: $('#nicknameInp').value.trim(), bio: $('#bioInp').value.trim() };
      const r = await fetch(API('/user/update'), { method:'PUT', headers:JH, body:JSON.stringify(payload) });
      const d = await r.json();
      $('#saveMsg').textContent = d.ok ? 'Guardado' : (d.message || 'Error');
      if (d.ok) await refreshMe();
    };

    // ===== Init =====
    (async ()=>{
      const meData = await loadMe();
      const myId = meData.user._id?.toString?.() || meData.user.id || '';

      if (viewId && viewId !== myId){
        const { user, counts } = await loadOther(viewId);
        paintProfile(user, counts);
        $('#btnEdit').style.display = 'none';
        $('#btnFollow').style.display = 'inline-block';
        $('#btnFollow').textContent = isFollowing ? 'Dejar de seguir' : 'Seguir';
        $('#btnFollow').onclick = toggleFollow;
      }else{
        paintProfile(meData.user, meData.counts);
        $('#btnFollow').style.display = 'none';
        $('#btnEdit').style.display = 'inline-block';
        $('#btnEdit').onclick = ()=>{ prefillEdit(); openModal(); };
      }
    })();

    // Logout
    document.getElementById('logoutBtnTop')?.addEventListener('click', ()=>{
      localStorage.removeItem('token'); localStorage.removeItem('user'); location.replace('index.html');
    });

    // ===== Grid + modal de post =====
    const grid = document.getElementById('gridIg');
    const lb = document.getElementById('lightbox'), lbClose = document.getElementById('lbClose');
    const lbImg = document.getElementById('lbImg'), lbAva = document.getElementById('lbAva');
    const lbName = document.getElementById('lbName'), lbUser = document.getElementById('lbUser');
    const lbBody = document.getElementById('lbComments'), lbInp = document.getElementById('lbInp'), lbSend = document.getElementById('lbSend');

    const userCache = new Map();
    async function getUserPublic(uId){
      if (userCache.has(uId)) return userCache.get(uId);
      if (other && String(other._id) === String(uId)) { userCache.set(uId, other); return other; }
      if (me && String(me._id) === String(uId))       { userCache.set(uId, me);    return me;    }
      const r = await fetch(API(`/user/${uId}/public`), { headers:H });
      const d = await r.json();
      if (d.ok){ userCache.set(uId, d.user); return d.user; }
      return null;
    }

    async function listPostComments(postId){
      const r = await fetch(API(`/posts/${postId}/comments?limit=100`), { headers:H });
      const d = await r.json();
      return d.ok ? d.comments : [];
    }
    async function addPostComment(postId, text){
      const r = await fetch(API(`/posts/${postId}/comments`), { method:'POST', headers:{...H,'Content-Type':'application/json'}, body:JSON.stringify({ text }) });
      const d = await r.json(); return d.ok ? d.comment : null;
    }
    function renderComments(list, authorMap){
      lbBody.innerHTML = '';
      list.forEach(c=>{
        const u = authorMap.get(String(c.userId));
        const nm = u ? (u.name || `${u.firstName||''} ${u.lastName||''}`.trim() || u.nickname) : 'usuario';
        const row = document.createElement('div');
        row.className = 'lb-cmt';
        row.innerHTML = `<span class="nm">${nm}</span>${c.text}<span class="dt">${timeAgo(c.createdAt)}</span>`;
        lbBody.appendChild(row);
      });
      lbBody.scrollTop = lbBody.scrollHeight;
    }
    function timeAgo(iso){ try{ const d=new Date(iso); const s=(Date.now()-d)/1000;
      if(s<60) return 'ahora'; if(s<3600) return Math.floor(s/60)+' min';
      if(s<86400) return Math.floor(s/3600)+' h'; return Math.floor(s/86400)+' d';
    }catch{ return ''; } }

    async function loadProfilePostsIG(uid){
      const url = new URL(API('/posts')); url.searchParams.set('userId', uid); url.searchParams.set('limit', '36');
      const r = await fetch(url, { headers:H }); const d = await r.json(); grid.innerHTML='';
      if (!d.ok || !d.posts?.length){ grid.innerHTML = '<div class="muted">A√∫n no hay publicaciones.</div>'; return; }
      d.posts.forEach(p=>{ const a=document.createElement('a'); a.href='#'; a.className='ig-item';
        a.innerHTML=`<img src="${p.media.thumb}" alt="">`; a.addEventListener('click', ev=>{ ev.preventDefault(); openPostModal(p); }); grid.appendChild(a); });
    }

    async function openPostModal(p){
      lbImg.src = p.media.t1 || p.media.original || p.media.thumb;
      const u = await getUserPublic(p.userId);
      const display = u ? (u.name || `${u.firstName||''} ${u.lastName||''}`.trim() || u.nickname) : 'Usuario';
      lbAva.src  = resolveAvatar(u); lbName.textContent = display; lbUser.textContent = u ? `@${u.nickname || 'usuario'}` : '';
      const comments = await listPostComments(p.id); const authors = new Map(); if (u) authors.set(String(p.userId), u);
      renderComments(comments, authors);
      lbSend.onclick = async ()=>{ const t = lbInp.value.trim(); if (!t) return;
        const c = await addPostComment(p.id, t);
        if (c){ lbInp.value=''; comments.push(c); renderComments(comments, authors); } };
      lb.setAttribute('aria-hidden','false');
    }
    function closePostModal(){ lb.setAttribute('aria-hidden','true'); lbImg.removeAttribute('src'); lbInp.value=''; lbBody.innerHTML=''; }
    lbClose.onclick = closePostModal; lb.addEventListener('click',(e)=>{ if(e.target===lb) closePostModal(); });
    document.addEventListener('keydown',(e)=>{ if(e.key==='Escape' && lb.getAttribute('aria-hidden')==='false') closePostModal(); });

    // Cargar publicaciones del usuario (grid)
    (async ()=>{
      const meResp = await fetch(API('/user/me'), { headers:H });
      const meData = await meResp.json();
      const myId = meData?.user?._id || '';
      const uid  = (viewId && viewId!==myId) ? viewId : myId;
      await loadProfilePostsIG(uid);
    })();
  </script>
</body>
</html>
