<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Perfil – DACEM</title>
  
  <!-- Fuente Plus Jakarta Sans -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
  
  <!-- Iconos Lucide -->
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>
  
  <!-- Pre-aplica el tema para evitar FOUC -->
  <script>
    (function(){
      const saved = localStorage.getItem('theme') || 'dark';
      document.documentElement.setAttribute('data-theme', saved);
    })();
  </script>
  
  <!-- Navegación suave (cargar antes para prevenir FOUC) -->
  <script src="js/smooth-navigation.js"></script>
  
  <link rel="stylesheet" href="css/header.css">
  <link rel="stylesheet" href="css/sidebar.css?v=2">
  <link rel="stylesheet" href="css/profile.css?v=16">
  <link rel="stylesheet" href="css/transformations.css">
</head>
<body class="profile-page">
  <!-- Topbar -->
  <header class="topbar">
    <div class="topbar-inner">
      <div class="brand">
        <span class="logo-badge"><img src="img/Dacem.png" alt="DACEM"></span>
        DACEM
      </div>
      <div class="topbar-actions">
        <button id="themeToggle" class="btn ghost small" title="Cambiar tema">
          <i class="nav-ico" data-lucide="moon"></i>
          <span id="themeTxt">Modo oscuro</span>
        </button>
        <button id="logoutBtnTop" class="btn danger small">Cerrar sesión</button>
      </div>
    </div>
  </header>

  <div class="wrap">
    <div class="layout">
      <!-- Sidebar se generará dinámicamente -->

      <!-- Main -->
      <main class="main">
        <!-- Header moradito con banner -->
        <section class="profile-header">
          <div class="banner" id="banner"></div>

          <div class="profile-info">
            <div class="profile-header-top">
              <img id="avatarImg" class="profile-avatar" alt="Avatar">
              <div>
                <h1 id="nameTxt">Perfil</h1>
                <div class="profile-username">
                  @<span id="usernameTxt">usuario</span>
                  <span id="verified" class="badge" title="Verificado" style="display:none;">✔</span>
                </div>

                <div class="profile-stats">
                  <button class="stat" id="btnOpenFollowing" style="background:none;border:none;cursor:pointer;padding:0;color:inherit;font:inherit">
                    <strong id="followingCnt">0</strong>
                    <span>siguiendo</span>
                  </button>
                  <button class="stat" id="btnOpenFollowers" style="background:none;border:none;cursor:pointer;padding:0;color:inherit;font:inherit">
                    <strong id="followersCnt">0</strong>
                    <span>seguidores</span>
                  </button>
                </div>
              </div>

              <div class="profile-actions">
                <button id="btnFollow" class="btn" style="display:none">Seguir</button>
                <button id="btnSendMessage" class="btn" style="display:none" title="Enviar mensaje">
                  <span style="display:flex; align-items:center; gap:6px;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="flex-shrink:0">
                      <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                    </svg>
                    <span>Mensaje</span>
                  </span>
                </button>
                <button id="btnEdit" class="btn ghost" style="display:none">Editar perfil</button>
                <button id="btnManagePosts" class="btn ghost" style="display:none">Gestionar publicaciones</button>
              </div>
            </div>

            <div class="profile-bio" id="bioTxt">NoBioYet</div>
          </div>
        </section>

        <!-- Publicaciones (moradito sutil) -->
        <section class="posts-section" id="profilePosts">
          <h2>Publicaciones</h2>
          <div class="posts-grid grid-ig" id="gridIg"></div>
        </section>
      </main>
    </div>
  </div>

  <!-- Visor post -->
  <div class="lightbox" id="lightbox" aria-hidden="true">
    <div class="lb-content" role="dialog" aria-modal="true" aria-label="Publicación">
      <!-- Controles superiores -->
      <div class="lb-controls">
        <button class="btn danger small lb-delete" id="lbDelete" style="display:none;" title="Eliminar publicación">
          <svg viewBox="0 0 24 24" width="18" height="18" stroke="currentColor" stroke-width="2" fill="none">
            <polyline points="3 6 5 6 21 6"></polyline>
            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
          </svg>
        </button>
        <button class="btn ghost small lb-close" id="lbClose" title="Cerrar">
          <svg viewBox="0 0 24 24" width="18" height="18" stroke="currentColor" stroke-width="2" fill="none">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>
      
      <div class="lb-media"><img id="lbImg" alt=""></div>
      <aside class="lb-side">
        <header class="lb-head">
          <img id="lbAva" class="lb-ava" alt="" style="cursor:pointer" title="Ver perfil">
          <div style="flex:1">
            <a id="lbName" href="#" style="font-weight:700;color:var(--text);text-decoration:none;display:block"></a>
            <div id="lbUser" class="muted" style="font-size:12px"></div>
          </div>
          <button id="lbFaceRecognition" class="btn ghost small" title="Analizar rostro">
            <i data-lucide="smile"></i>
          </button>
          <button id="lbMessage" class="btn ghost small" style="display:none" title="Enviar mensaje">
            <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
            </svg>
          </button>
        </header>
        <div class="lb-body" id="lbComments"></div>
        
        <div class="lb-actions">
          <button id="lbLike" class="btn-icon" aria-pressed="false" title="Me gusta">
            <i data-lucide="heart"></i>
            <span id="lbLikes">0</span>
          </button>
          <button id="lbComment" class="btn-icon" title="Comentar">
            <i data-lucide="message-circle"></i>
            <span id="lbCommentsCount">0</span>
          </button>
        </div>
        
        <div class="lb-input">
          <input id="lbInp" placeholder="Añade un comentario…">
          <button id="lbSend" class="btn primary">
            <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="22" y1="2" x2="11" y2="13"></line>
              <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
            </svg>
            Publicar
          </button>
        </div>
      </aside>
    </div>
  </div>

  <!-- Modal Editar Perfil -->
  <div id="editModal" class="backdrop">
    <div class="modal">
      <div class="modal-head">
        <h3>Editar perfil</h3>
        <button class="btn ghost" id="closeEdit">Cerrar</button>
      </div>

      <div class="modal-body">
        <div>
          <div id="bannerPreview" class="banner-preview"></div>
          <input id="bannerFile" type="file" accept="image/*" hidden>
          <button class="btn" id="btnPickBanner">Cambiar banner</button>
        </div>

        <div>
          <div class="avatar avatar-xl">
            <img id="avatarPreview" class="avatar-img" alt="">
            <div id="avatarPreviewTxt" class="avatar-txt">U</div>
          </div>
          <input id="avatarFile" type="file" accept="image/*" hidden>
          <button class="btn" id="btnPickAvatar">Cambiar foto</button>
        </div>

        <div class="form">
          <label>Apodo</label>
          <input id="nicknameInp" placeholder="tuapodo">
          <label>Bio (opcional)</label>
          <textarea id="bioInp" rows="3" maxlength="240" placeholder="Algo sobre ti..."></textarea>
        </div>
      </div>

      <div class="modal-foot">
        <span id="saveMsg" class="muted"></span>
        <button class="btn" id="btnSave">Guardar cambios</button>
      </div>
    </div>
  </div>

  <!-- Modal Seguidores / Siguiendo -->
  <div id="followModal" class="backdrop">
    <div class="modal" style="max-width:640px">
      <div class="modal-head" style="justify-content:space-between; gap:12px;">
        <div class="tabs" id="followTabs">
          <button class="btn ghost small active" data-tab="followers">Seguidores</button>
          <button class="btn ghost small" data-tab="following">Siguiendo</button>
        </div>
        <button class="btn ghost" id="closeFollow">Cerrar</button>
      </div>

      <div class="modal-body" style="display:flex; flex-direction:column; gap:12px;">
        <input id="followSearch" placeholder="Buscar" class="input" />
        <div id="followList" class="list-users"></div>
        <div style="text-align:center;">
          <button id="followMore" class="btn" style="display:none">Cargar más</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Gestionar Publicaciones -->
  <div id="managePostsModal" class="backdrop">
    <div class="modal" style="max-width:900px">
      <div class="modal-head">
        <h3>Gestionar Publicaciones</h3>
        <button class="btn ghost" id="closeManagePosts">Cerrar</button>
      </div>

      <div class="modal-body" style="max-height:600px; overflow-y:auto;">
        <div id="managePostsList" style="display:flex; flex-direction:column; gap:16px;"></div>
      </div>
    </div>
  </div>

  <!-- Modal Ver Comentarios de Post -->
  <div id="viewCommentsModal" class="backdrop">
    <div class="modal" style="max-width:600px">
      <div class="modal-head">
        <h3>Comentarios</h3>
        <button class="btn ghost" id="closeViewComments">Cerrar</button>
      </div>

      <div class="modal-body" style="max-height:500px; overflow-y:auto;">
        <div id="commentsList" style="display:flex; flex-direction:column; gap:6px;"></div>
      </div>
    </div>
  </div>

  <!-- Modal Confirmación Eliminar -->
  <div id="confirmDeleteModal" class="backdrop">
    <div class="modal confirm-modal" style="max-width:480px;">
      <div class="confirm-icon">
        <svg viewBox="0 0 24 24" width="48" height="48" stroke="currentColor" stroke-width="2" fill="none">
          <circle cx="12" cy="12" r="10"></circle>
          <line x1="12" y1="8" x2="12" y2="12"></line>
          <line x1="12" y1="16" x2="12.01" y2="16"></line>
        </svg>
      </div>
      
      <h3 id="confirmTitle" style="text-align:center; margin:16px 0 8px;">¿Eliminar publicación?</h3>
      <p id="confirmMessage" style="text-align:center; color:var(--muted); margin-bottom:24px;">
        Esta acción no se puede deshacer. Se eliminarán todos los likes y comentarios asociados.
      </p>
      
      <div style="display:flex; gap:12px; justify-content:center;">
        <button class="btn ghost" id="confirmCancel">Cancelar</button>
        <button class="btn danger" id="confirmDelete">Eliminar</button>
      </div>
    </div>
  </div>

  <!-- JS (idéntico al tuyo, solo funciona con los mismos IDs) -->
  <script>
    // Toggle tema
    const themeBtn = document.getElementById('themeToggle');
    const themeTxt = document.getElementById('themeTxt');

    const labelFor = (t) => (t === 'dark' ? 'Modo claro' : 'Modo oscuro');

    function applyTheme(t){
      document.documentElement.setAttribute('data-theme', t);
      localStorage.setItem('theme', t);

      const icon = themeBtn?.querySelector('[data-lucide]');
      if (icon) icon.setAttribute('data-lucide', t === 'dark' ? 'sun' : 'moon');

      if (themeTxt) themeTxt.textContent = labelFor(t);
      if (window.lucide) lucide.createIcons();
    }

    themeBtn?.addEventListener('click', ()=>{
      const current = document.documentElement.getAttribute('data-theme') || 'dark';
      applyTheme(current === 'dark' ? 'light' : 'dark');
    });

    // Inicializar icono + texto correctos al cargar
    (function(){
      const saved = localStorage.getItem('theme')
        || (matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
      document.documentElement.setAttribute('data-theme', saved);

      const icon = themeBtn?.querySelector('[data-lucide]');
      if (icon) icon.setAttribute('data-lucide', saved === 'dark' ? 'sun' : 'moon');

      if (themeTxt) themeTxt.textContent = labelFor(saved);
      if (window.lucide) lucide.createIcons();
    })();

    const API = (p)=>`${location.origin}/api${p}`;
    const token = localStorage.getItem('token');
    if(!token){ location.replace('index.html'); }
    const H  = { 'Authorization':`Bearer ${token}` };
    const JH = { ...H, 'Content-Type':'application/json' };
    const $  = s => document.querySelector(s);
    const qs = new URLSearchParams(location.search);
    const viewId = qs.get('id');

    /* ====== Helpers para manejo de medios ====== */
    function pickFirst(...vals){
      for (const v of vals) if (v && typeof v === 'string' && v.trim()) return v;
      return null;
    }

    function resolveMediaSrc(m){
      if (!m || typeof m !== 'object') return null;
      return pickFirst(
        m.thumb, m.t1, m['t1_bw'],
        m.original, m.url, m.src,
        m.t2, m.t3, m.t4, m.t5, m.t6, m.t7, m.t8, m.t9, m.t10
      );
    }

    function setSrcWithFallback(img, candidates){
      const list = candidates.filter(Boolean);
      let i = 0;
      const tryNext = ()=>{ if (i < list.length) img.src = list[i++]; };
      img.onerror = tryNext;
      tryNext();
    }

    let me=null, other=null, isFollowing=false;

    const displayName = (u)=> u?.name || `${u?.firstName||''} ${u?.lastName||''}`.trim() || (u?.nickname || 'Usuario');
    const initialLetter= (u)=> (u?.firstName?.[0] || u?.name?.[0] || u?.nickname?.[0] || 'U').toUpperCase();
    const abs = (url)=>!url ? '' : (url.startsWith('http') ? url : `${location.origin}${url.startsWith('/')?url:'/'+url}`);

    function setAvatarBox(imgEl, txtEl, u){
      if (u?.avatar){ imgEl.src = abs(u.avatar); imgEl.style.display='block'; if(txtEl) txtEl.style.display='none'; }
      else { imgEl.removeAttribute('src'); imgEl.style.display='none'; if(txtEl){ txtEl.textContent = initialLetter(u); txtEl.style.display='flex'; } }
    }
    function resolveAvatar(u){
      if (!u) return `https://api.dicebear.com/8.x/initials/svg?seed=U&radius=50&scale=110&fontWeight=700`;
      if (u.avatar) return u.avatar.startsWith('http') ? u.avatar : `${location.origin}${u.avatar.startsWith('/')?u.avatar:'/'+u.avatar}`;
      const seed = encodeURIComponent((u.firstName || u.name || u.nickname || 'U'));
      return `https://api.dicebear.com/8.x/initials/svg?seed=${seed}&radius=50&scale=110&fontWeight=700`;
    }

    /* ---------- Follow modal (idéntico a tu versión) ---------- */
    const followModal  = document.getElementById('followModal');
    const followTabs   = document.getElementById('followTabs');
    const followList   = document.getElementById('followList');
    const followMore   = document.getElementById('followMore');
    const followSearch = document.getElementById('followSearch');
    document.getElementById('closeFollow').onclick = ()=> followModal.removeAttribute('data-open');

    const REL_STATE = new Map();
    let FOLLOW_STATE = { tab:'followers', userId:null, cursor:null, cache:[] };

    function openFollowModal(tab, userId){
      FOLLOW_STATE = { tab, userId, cursor:null, cache:[] };
      [...followTabs.querySelectorAll('button')].forEach(b=> b.classList.toggle('active', b.dataset.tab===tab));
      followSearch.value = '';
      followList.innerHTML = '<div class="muted">Cargando...</div>';
      followModal.setAttribute('data-open','true');
      loadFollowPage(true);
    }

    async function loadFollowPage(first=false){
      const limit = 20;
      const url = new URL(API(`/follow/${FOLLOW_STATE.userId}/${FOLLOW_STATE.tab}`));
      url.searchParams.set('limit', String(limit));
      if (FOLLOW_STATE.cursor) url.searchParams.set('cursor', FOLLOW_STATE.cursor);
      const r = await fetch(url.toString(), { headers:H });
      const d = await r.json();
      if (!d.ok){ followList.innerHTML = '<div class="muted">No disponible</div>'; return; }
      if (first) { followList.innerHTML = ''; FOLLOW_STATE.cache = []; }
      (d.users || []).forEach(u => FOLLOW_STATE.cache.push(u));
      FOLLOW_STATE.cursor = d.nextCursor || null;
      followMore.style.display = FOLLOW_STATE.cursor ? 'inline-block' : 'none';
      renderFollowList();
    }

    async function ensureFollowFlag(id){
      if (REL_STATE.has(id)) return REL_STATE.get(id);
      try{
        const rr = await fetch(API(`/user/${id}/public`), { headers:H });
        const dd = await rr.json();
        const val = !!dd.isFollowing;
        REL_STATE.set(id, val);
        return val;
      }catch{ return false; }
    }

    function rowTemplate(u, followingNow){
      const row = document.createElement('div');
      row.className='user-row';
      row.innerHTML = `
        <img src="${resolveAvatar(u)}" alt="">
        <div class="u-info">
          <div class="u-name">${displayName(u)}</div>
          <div class="u-nick">@${u.nickname || 'usuario'}</div>
        </div>
        <div class="u-actions">
          <a class="btn ghost small" href="profile.html?id=${u.id}">Ver</a>
          <button class="btn small follow-toggle">${followingNow ? 'Dejar de seguir' : 'Seguir'}</button>
          ${FOLLOW_STATE.tab === 'followers' && FOLLOW_STATE.userId === me?._id ? 
            `<button class="btn danger small remove-follower">Eliminar seguidor</button>` : ''
          }
        </div>`;
      return row;
    }

    async function renderFollowList(){
      const q = followSearch.value.trim().toLowerCase();
      followList.innerHTML = '';
      const rows = FOLLOW_STATE.cache.filter(u => {
        if (!q) return true;
        const s = `${u.firstName||''} ${u.lastName||''} ${u.nickname||''}`.toLowerCase();
        return s.includes(q);
      });
      if (!rows.length){ followList.innerHTML = '<div class="muted">Sin resultados</div>'; return; }

      for (const u of rows){
        let followingNow = FOLLOW_STATE.tab === 'following' ? true : REL_STATE.get(u.id);
        const row = rowTemplate(u, !!followingNow);
        const btn = row.querySelector('.follow-toggle');
        if (FOLLOW_STATE.tab === 'followers' && followingNow === undefined){
          ensureFollowFlag(u.id).then(()=>{ btn.textContent = (REL_STATE.get(u.id) ? 'Dejar de seguir' : 'Seguir'); });
        }
        btn.onclick = async ()=>{
          btn.disabled = true;
          try{
            const r = await fetch(API(`/follow/toggle/${u.id}`), { method:'POST', headers:H });
            if (r.status !== 404){
              const d = await r.json(); if (d.ok) REL_STATE.set(u.id, !!d.following);
            }else{
              const currently = FOLLOW_STATE.tab==='following' ? true : (REL_STATE.get(u.id) || false);
              const m = currently ? 'DELETE' : 'POST';
              const r2 = await fetch(API(`/follow/${u.id}`), { method:m, headers:H });
              const d2 = await r2.json(); if (d2.ok) REL_STATE.set(u.id, !currently);
            }
          } finally {
            const now = REL_STATE.get(u.id) || false;
            if (FOLLOW_STATE.tab==='following' && !now){
              row.remove();
              const cntEl = document.getElementById('followingCnt');
              if (cntEl) cntEl.textContent = Math.max(0, (+cntEl.textContent||1) - 1);
            }else{
              btn.textContent = now ? 'Dejar de seguir' : 'Seguir';
            }
            btn.disabled = false;
          }
        };

        // Agregar funcionalidad para eliminar seguidor
        const removeBtn = row.querySelector('.remove-follower');
        if (removeBtn) {
          removeBtn.onclick = async () => {
            if (!confirm('¿Estás seguro de que deseas eliminar a este seguidor?')) return;
            
            removeBtn.disabled = true;
            try {
              const r = await fetch(API(`/follow/${u.id}/remove`), { 
                method: 'POST', 
                headers: H 
              });
              const d = await r.json();
              if (d.ok) {
                row.remove();
                const cntEl = document.getElementById('followersCnt');
                if (cntEl) cntEl.textContent = Math.max(0, (+cntEl.textContent||1) - 1);
              }
            } catch(err) {
              alert('Error al eliminar seguidor');
            } finally {
              removeBtn.disabled = false;
            }
          };
        }
        
        followList.appendChild(row);
      }
    }

    followMore.onclick = ()=> loadFollowPage(false);
    followSearch.oninput = ()=> renderFollowList();
    followTabs.addEventListener('click', (e)=>{
      const b=e.target.closest('button[data-tab]'); if(!b) return;
      openFollowModal(b.dataset.tab, FOLLOW_STATE.userId);
    });

    document.getElementById('btnOpenFollowers')?.addEventListener('click', ()=>{
      const uid = (viewId && viewId!==(me?._id||'')) ? viewId : (me?._id || '');
      openFollowModal('followers', uid);
    });
    document.getElementById('btnOpenFollowing')?.addEventListener('click', ()=>{
      const uid = (viewId && viewId!==(me?._id||'')) ? viewId : (me?._id || '');
      openFollowModal('following', uid);
    });

    /* ---------- Perfil ---------- */
    function paintProfile(u, counts){
      const hasBanner = !!u.banner;
      document.getElementById('banner').style.backgroundImage = hasBanner ? `url(${abs(u.banner)})` : 'none';
      document.querySelector('.main').classList.toggle('has-banner', hasBanner); // inofensivo
      document.getElementById('nameTxt').textContent = displayName(u);
      document.getElementById('usernameTxt').textContent = u.nickname || 'usuario';
      document.getElementById('followersCnt').textContent = counts?.followers ?? 0;
      document.getElementById('followingCnt').textContent = counts?.following ?? 0;
      document.getElementById('verified').style.display = u.isVerified ? 'inline' : 'none';
      setAvatarBox(document.getElementById('avatarImg'), null, u);
      document.getElementById('bioTxt').textContent = (u.bio && u.bio.trim()) ? u.bio : 'NoBioYet';
    }

    async function loadMe(){
      const r = await fetch(API('/user/me'), { headers:H });
      const d = await r.json();
      if(!d.ok){ localStorage.removeItem('token'); return location.replace('index.html'); }
      me = d.user; return { user:d.user, counts:d.counts };
    }
    async function loadOther(id){
      const r = await fetch(API(`/user/${id}/public`), { headers:H });
      const d = await r.json();
      if(!d.ok) throw new Error(d.message || 'No encontrado');
      other = d.user; isFollowing = !!d.isFollowing;
      return { user:d.user, counts:d.counts };
    }

    async function toggleFollow(){
      const btn = document.getElementById('btnFollow');
      btn.disabled = true;
      const tryToggle = await fetch(API(`/follow/toggle/${other._id}`), { method:'POST', headers:H });
      if (tryToggle.status !== 404){
        const d = await tryToggle.json(); if (d.ok) isFollowing = !isFollowing;
      }else{
        const r = await fetch(API(`/follow/${other._id}`), { method: isFollowing ? 'DELETE' : 'POST', headers:H });
        const d = await r.json(); if (d.ok) isFollowing = !isFollowing;
      }
      btn.textContent = isFollowing ? 'Dejar de seguir' : 'Seguir';
      btn.disabled = false;
    }

    /* ---------- Editar perfil ---------- */
    const modal = document.getElementById('editModal');
    const openModal  = ()=> modal.setAttribute('data-open','true');
    const closeModal = ()=> modal.removeAttribute('data-open');
    document.getElementById('closeEdit').onclick = closeModal;

    function prefillEdit(){
      document.getElementById('bannerPreview').style.backgroundImage = me.banner ? `url(${abs(me.banner)})` : 'none';
      setAvatarBox(document.getElementById('avatarPreview'), document.getElementById('avatarPreviewTxt'), me);
      document.getElementById('nicknameInp').value = me.nickname || '';
      document.getElementById('bioInp').value = me.bio || '';
      document.getElementById('saveMsg').textContent = '';
    }
    document.getElementById('btnPickBanner').onclick = ()=> document.getElementById('bannerFile').click();
    document.getElementById('btnPickAvatar').onclick = ()=> document.getElementById('avatarFile').click();

    document.getElementById('bannerFile').addEventListener('change', async (e)=>{
      const f = e.target.files?.[0]; if(!f) return;
      const fd = new FormData(); fd.append('banner', f);
      const r = await fetch(API('/user/me/banner'), { method:'PUT', headers:H, body:fd });
      const d = await r.json();
      if (d.ok){
        document.getElementById('bannerPreview').style.backgroundImage = `url(${d.banner})`;
        document.getElementById('banner').style.backgroundImage = `url(${d.banner})`;
      }
      e.target.value = '';
    });

    document.getElementById('avatarFile').addEventListener('change', async (e)=>{
      const f = e.target.files?.[0]; if(!f) return;
      const fd = new FormData(); fd.append('avatar', f);
      const r = await fetch(API('/user/me/avatar'), { method:'POST', headers:H, body:fd });
      const d = await r.json();
      if (d.ok){ await refreshMe(); }
      e.target.value = '';
    });

    async function refreshMe(){
      const r = await fetch(API('/user/me'), { headers:H });
      const d = await r.json();
      if (d.ok){ me = d.user; paintProfile(me, d.counts); prefillEdit(); }
    }
    document.getElementById('btnSave').onclick = async ()=>{
      document.getElementById('saveMsg').textContent = 'Guardando...';
      const payload = { nickname: document.getElementById('nicknameInp').value.trim(), bio: document.getElementById('bioInp').value.trim() };
      const r = await fetch(API('/user/update'), { method:'PUT', headers:JH, body:JSON.stringify(payload) });
      const d = await r.json();
      document.getElementById('saveMsg').textContent = d.ok ? 'Guardado' : (d.message || 'Error');
      if (d.ok) await refreshMe();
    };

    /* ---------- Init ---------- */
    (async ()=>{
      const meData = await loadMe();
      const myId = meData.user._id?.toString?.() || meData.user.id || '';
      if (viewId && viewId !== myId){
        const { user, counts } = await loadOther(viewId);
        paintProfile(user, counts);
        document.getElementById('btnEdit').style.display = 'none';
        document.getElementById('btnManagePosts').style.display = 'none';
        const bf = document.getElementById('btnFollow');
        bf.style.display = 'inline-block';
        bf.textContent = isFollowing ? 'Dejar de seguir' : 'Seguir';
        bf.onclick = toggleFollow;
        
        // Botón enviar mensaje
        const bm = document.getElementById('btnSendMessage');
        bm.style.display = 'inline-block';
        bm.onclick = ()=> window.location.href = `messages.html?userId=${viewId}`;
      }else{
        paintProfile(meData.user, meData.counts);
        document.getElementById('btnFollow').style.display = 'none';
        document.getElementById('btnSendMessage').style.display = 'none';
        const be = document.getElementById('btnEdit');
        be.style.display = 'inline-block';
        be.onclick = ()=>{ prefillEdit(); openModal(); };
        
        // Botón gestionar publicaciones
        const bm = document.getElementById('btnManagePosts');
        bm.style.display = 'inline-block';
        bm.onclick = openManagePostsModal;
      }
    })();

    // Logout
    document.getElementById('logoutBtnTop')?.addEventListener('click', ()=>{
      localStorage.removeItem('token'); localStorage.removeItem('user'); location.replace('index.html');
    });

    /* ---------- Gestionar Publicaciones ---------- */
    const managePostsModal = document.getElementById('managePostsModal');
    const managePostsList = document.getElementById('managePostsList');
    document.getElementById('closeManagePosts').onclick = ()=> managePostsModal.removeAttribute('data-open');

    const viewCommentsModal = document.getElementById('viewCommentsModal');
    const commentsList = document.getElementById('commentsList');
    document.getElementById('closeViewComments').onclick = ()=> viewCommentsModal.removeAttribute('data-open');

    // Modal de confirmación
    const confirmDeleteModal = document.getElementById('confirmDeleteModal');
    const confirmTitle = document.getElementById('confirmTitle');
    const confirmMessage = document.getElementById('confirmMessage');
    const confirmDeleteBtn = document.getElementById('confirmDelete');
    const confirmCancelBtn = document.getElementById('confirmCancel');
    
    let deleteCallback = null;

    function showConfirmModal(title, message, onConfirm) {
      confirmTitle.textContent = title;
      confirmMessage.textContent = message;
      deleteCallback = onConfirm;
      confirmDeleteModal.setAttribute('data-open', 'true');
    }

    function hideConfirmModal() {
      confirmDeleteModal.removeAttribute('data-open');
      deleteCallback = null;
    }

    confirmCancelBtn.onclick = hideConfirmModal;
    confirmDeleteBtn.onclick = async () => {
      if (deleteCallback) {
        await deleteCallback();
        hideConfirmModal();
      }
    };

    // Cerrar modal al hacer click fuera
    confirmDeleteModal.addEventListener('click', (e) => {
      if (e.target === confirmDeleteModal) hideConfirmModal();
    });

    async function openManagePostsModal(){
      managePostsModal.setAttribute('data-open', 'true');
      managePostsList.innerHTML = '<div class="muted">Cargando publicaciones...</div>';
      
      const myId = me?._id || me?.id || '';
      const url = new URL(API('/posts'));
      url.searchParams.set('userId', myId);
      url.searchParams.set('limit', '50');
      
      const r = await fetch(url, { headers:H });
      const d = await r.json();
      
      if (!d.ok || !d.posts?.length){
        managePostsList.innerHTML = '<div class="muted">No tienes publicaciones aún.</div>';
        return;
      }

      managePostsList.innerHTML = '';
      d.posts.forEach(post => {
        const postCard = document.createElement('div');
        postCard.dataset.postId = post.id || post._id;
        postCard.style.cssText = 'border:1px solid var(--line); border-radius:8px; padding:16px; display:flex; gap:16px;';
        postCard.innerHTML = `
          <img src="${post.media.thumb}" alt="" style="width:120px; height:120px; object-fit:cover; border-radius:8px;">
          <div style="flex:1; display:flex; flex-direction:column; gap:8px;">
            <div style="font-size:14px; color:var(--muted);">
              ${post.caption || 'Sin descripción'}
            </div>
            <div style="font-size:12px; color:var(--muted);">
              ${post.counts?.likes || 0} likes · ${post.counts?.comments || 0} comentarios
            </div>
            <div style="display:flex; gap:8px; margin-top:auto;">
              <button class="btn ghost small view-comments-btn" data-post-id="${post.id}">
                Ver comentarios
              </button>
              <button class="btn danger small delete-post-btn" data-post-id="${post.id}">
                Eliminar publicación
              </button>
            </div>
          </div>
        `;
        
        // Evento ver comentarios
        postCard.querySelector('.view-comments-btn').onclick = ()=> openViewCommentsModal(post.id);
        
        // Evento eliminar post
        postCard.querySelector('.delete-post-btn').onclick = async (e)=>{
          const btn = e.target;
          
          showConfirmModal(
            '¿Eliminar publicación?',
            'Esta acción no se puede deshacer. Se eliminarán todos los likes y comentarios asociados.',
            async () => {
              btn.disabled = true;
              btn.textContent = 'Eliminando...';
              
              const r = await fetch(API(`/posts/${post.id}`), { method:'DELETE', headers:H });
              const d = await r.json();
              
              if (d.ok){
                postCard.remove();
                // Recargar grid
                const myId = me?._id || me?.id || '';
                await loadProfilePostsIG(myId);
              } else {
                alert(d.message || 'Error al eliminar');
                btn.disabled = false;
                btn.textContent = 'Eliminar publicación';
              }
            }
          );
        };
        
        managePostsList.appendChild(postCard);
      });
    }

    async function openViewCommentsModal(postId){
      viewCommentsModal.setAttribute('data-open', 'true');
      commentsList.innerHTML = '<div class="muted">Cargando comentarios...</div>';
      
      const comments = await listPostComments(postId);
      
      if (!comments.length){
        commentsList.innerHTML = '<div class="muted">No hay comentarios en esta publicación.</div>';
        return;
      }

      commentsList.innerHTML = '';
      
      console.log('Renderizando comentarios con enlaces clicables...');
      
      for (const comment of comments){
        const u = await getUserPublic(comment.userId);
        const nickname = u?.nickname || u?.name || `${u?.firstName||''} ${u?.lastName||''}`.trim() || 'Usuario';
        
        console.log('Comentario de usuario:', nickname, 'ID:', comment.userId);
        
        const commentCard = document.createElement('div');
        commentCard.style.cssText = 'border:1px solid var(--line); border-radius:6px; padding:8px 10px; display:flex; justify-content:space-between; align-items:start; gap:8px; font-size:13px;';
        commentCard.innerHTML = `
          <div style="flex:1; line-height:1.3;">
            <div style="font-weight:600; margin-bottom:2px;">
              <a href="profile.html?id=${encodeURIComponent(comment.userId)}" 
                 class="user-name-link nm user-link"
                 style="color:#8b5cf6; text-decoration:none; transition: all 0.2s; cursor: pointer; font-weight:700;"
                 onmouseover="this.style.color='#a855f7'; this.style.textDecoration='underline';"
                 onmouseout="this.style.color='#8b5cf6'; this.style.textDecoration='none';">
                @${nickname}
              </a>
            </div>
            <div style="font-size:13px; color:var(--text);">${comment.text}</div>
            <div style="font-size:11px; color:var(--muted); margin-top:2px;">${timeAgo(comment.createdAt)}</div>
          </div>
          <button class="btn danger small delete-comment-btn" data-comment-id="${comment._id}" data-post-id="${postId}">
            Eliminar
          </button>
        `;
        
        // Evento eliminar comentario
        commentCard.querySelector('.delete-comment-btn').onclick = async (e)=>{
          const btn = e.target;
          
          showConfirmModal(
            '¿Eliminar comentario?',
            'Esta acción no se puede deshacer.',
            async () => {
              btn.disabled = true;
              btn.textContent = 'Eliminando...';
              
              const r = await fetch(API(`/posts/${postId}/comments/${comment._id}`), { method:'DELETE', headers:H });
              const d = await r.json();
              
              if (d.ok){
                commentCard.remove();
                // Si no quedan más comentarios
                if (commentsList.children.length === 0){
                  commentsList.innerHTML = '<div class="muted">No hay más comentarios.</div>';
                }
              } else {
                alert(d.message || 'Error al eliminar');
                btn.disabled = false;
                btn.textContent = 'Eliminar';
              }
            }
          );
        };
        
        commentsList.appendChild(commentCard);
      }
    }

    // Función para analizar rostros en la publicación
    async function analyzeFaceInPost(post) {
      const btn = lbFaceRecognitionBtn;
      const originalText = btn.innerHTML;
      
      btn.disabled = true;
      btn.innerHTML = '<i data-lucide="loader"></i>';
      if (window.lucide) lucide.createIcons();

      try {
        const imageUrl = post.media.t1 || post.media.original || post.media.thumb;
        
        const res = await fetch(API('/face-recognition/analyze'), {
          method: 'POST',
          headers: { ...H, 'Content-Type': 'application/json' },
          body: JSON.stringify({ imageUrl })
        });

        const data = await res.json();

        if (!data.ok) {
          alert('Error: ' + data.message);
          btn.disabled = false;
          btn.innerHTML = originalText;
          return;
        }

        if (data.facesDetected === 0) {
          alert('No se detectaron rostros en la imagen');
          btn.disabled = false;
          btn.innerHTML = originalText;
          return;
        }

        // Crear modal con los resultados
        showFaceAnalysisResults(data.faces);

        btn.disabled = false;
        btn.innerHTML = originalText;
        if (window.lucide) lucide.createIcons();

      } catch (error) {
        console.error('Error analizando rostro:', error);
        alert('Error al analizar la imagen: ' + error.message);
        btn.disabled = false;
        btn.innerHTML = originalText;
      }
    }

    // Función para mostrar resultados del análisis facial
    function showFaceAnalysisResults(faces) {
      const modal = document.createElement('div');
      modal.style.cssText = `
        position: fixed; inset: 0; background: rgba(0,0,0,0.8); 
        display: flex; align-items: center; justify-content: center; 
        z-index: 1000; padding: 20px;
      `;

      let html = `
        <div style="background: var(--panel); color: var(--text); border-radius: 12px; 
                    max-width: 600px; width: 100%; max-height: 80vh; overflow-y: auto; padding: 24px;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h2 style="margin: 0; font-size: 24px;">Análisis Facial</h2>
            <button onclick="this.closest('div').parentElement.remove()" 
                    style="background: transparent; border: none; color: var(--text); cursor: pointer; font-size: 24px;">
              ✕
            </button>
          </div>
          
          <p style="color: var(--muted); margin-bottom: 20px;">
            Se detectaron <strong>${faces.length}</strong> rostro(s) en la imagen
          </p>
      `;

      faces.forEach((face, idx) => {
        const mainEmotion = face.emotions.length > 0 ? face.emotions[0] : null;
        
        html += `
          <div style="border: 1px solid var(--line); border-radius: 8px; padding: 16px; margin-bottom: 16px;">
            <h3 style="margin: 0 0 12px 0; color: var(--primary);">Rostro ${idx + 1}</h3>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px;">
              <div>
                <strong>Edad estimada:</strong><br>
                ${face.ageRange ? `${face.ageRange.low} - ${face.ageRange.high} años` : 'No disponible'}
              </div>
              <div>
                <strong>Género:</strong><br>
                ${face.gender ? `${face.gender.value} (${face.gender.confidence}%)` : 'No disponible'}
              </div>
              <div>
                <strong>Confianza:</strong><br>
                ${face.confidence}%
              </div>
              <div>
                <strong>Expresión:</strong><br>
                ${mainEmotion ? `${mainEmotion.type} (${mainEmotion.confidence}%)` : 'No disponible'}
              </div>
            </div>

            <div style="margin-bottom: 12px;">
              <strong>Características detectadas:</strong>
              <ul style="margin: 8px 0; padding-left: 20px;">
                ${face.eyeglasses.present ? `<li>Gafas (${face.eyeglasses.confidence}%)</li>` : ''}
                ${face.sunglasses.present ? `<li>Gafas de sol (${face.sunglasses.confidence}%)</li>` : ''}
                ${face.beard.present ? `<li>Barba (${face.beard.confidence}%)</li>` : ''}
                ${face.mustache.present ? `<li>Bigote (${face.mustache.confidence}%)</li>` : ''}
                ${face.mouthOpen.present ? `<li>Boca abierta (${face.mouthOpen.confidence}%)</li>` : ''}
                ${!face.eyesOpen.present ? `<li>Ojos cerrados (${face.eyesOpen.confidence}%)</li>` : ''}
                ${face.smiling.present ? `<li>Sonriendo (${face.smiling.confidence}%)</li>` : ''}
              </ul>
            </div>

            ${face.emotions.length > 0 ? `
              <div>
                <strong>Emociones detectadas:</strong>
                <div style="margin-top: 8px;">
                  ${face.emotions.map(e => `
                    <div style="display: flex; justify-content: space-between; margin-bottom: 6px;">
                      <span>${e.type}</span>
                      <span style="color: var(--primary); font-weight: 600;">${e.confidence}%</span>
                    </div>
                  `).join('')}
                </div>
              </div>
            ` : ''}
          </div>
        `;
      });

      html += `</div>`;

      modal.innerHTML = html;
      document.body.appendChild(modal);

      modal.onclick = (e) => {
        if (e.target === modal) modal.remove();
      };
    }

    /* ---------- Grid + modal de post ---------- */
    const grid = document.getElementById('gridIg');
    const lb = document.getElementById('lightbox'), lbClose = document.getElementById('lbClose');
    const lbImg = document.getElementById('lbImg'), lbAva = document.getElementById('lbAva');
    const lbName = document.getElementById('lbName'), lbUser = document.getElementById('lbUser');
    const lbBody = document.getElementById('lbComments'), lbInp = document.getElementById('lbInp'), lbSend = document.getElementById('lbSend');
    const lbFaceRecognitionBtn = document.getElementById('lbFaceRecognition');
    const userCache = new Map();
    async function getUserPublic(uId){
      if (userCache.has(uId)) return userCache.get(uId);
      if (other && String(other._id) === String(uId)) { userCache.set(uId, other); return other; }
      if (me && String(me._id) === String(uId))       { userCache.set(uId, me);    return me;    }
      const r = await fetch(API(`/user/${uId}/public`), { headers:H });
      const d = await r.json();
      if (d.ok){ userCache.set(uId, d.user); return d.user; }
      return null;
    }
    async function getUserCached(id){
      if (userCache.has(id)) return userCache.get(id);
      const r = await fetch(API(`/user/${id}/public`), { headers:H });
      const d = await r.json(); 
      if (d.ok){ userCache.set(id,d.user); return d.user; }
      return { nickname:'usuario', firstName:'', lastName:'', avatar:null };
    }
    async function listPostComments(postId){
      const r = await fetch(API(`/posts/${postId}/comments?limit=100`), { headers:H });
      const d = await r.json();
      return d.ok ? d.comments : [];
    }
    async function addPostComment(postId, text){
      const r = await fetch(API(`/posts/${postId}/comments`), { method:'POST', headers:{...H,'Content-Type':'application/json'}, body:JSON.stringify({ text }) });
      const d = await r.json(); return d.ok ? d.comment : null;
    }
    function renderComments(list, authorMap){
      lbBody.innerHTML = '';
      list.forEach(c=>{
        const u = authorMap.get(String(c.userId));
        const nick = u ? (u.nickname || u.name || `${u.firstName||''} ${u.lastName||''}`.trim() || 'usuario') : 'usuario';
        const row = document.createElement('div');
        row.className = 'lb-cmt';
        row.innerHTML = `<span class="nm-wrap"><a href="profile.html?id=${encodeURIComponent(c.userId)}" class="nm user-link">@${nick}</a></span>${c.text}<span class="dt">${timeAgo(c.createdAt)}</span>`;
        lbBody.appendChild(row);
      });
      lbBody.scrollTop = lbBody.scrollHeight;
    }
    function timeAgo(iso){ try{ const d=new Date(iso); const s=(Date.now()-d)/1000;
      if(s<60) return 'ahora'; if(s<3600) return Math.floor(s/60)+' min';
      if(s<86400) return Math.floor(s/3600)+' h'; return Math.floor(s/86400)+' d';
    }catch{ return ''; } }

    async function loadProfilePostsIG(uid){
      const url = new URL(API('/posts')); url.searchParams.set('userId', uid); url.searchParams.set('limit', '36');
      const r = await fetch(url, { headers:H }); const d = await r.json(); grid.innerHTML='';
      if (!d.ok || !d.posts?.length){ grid.innerHTML = '<div class="muted">Aún no hay publicaciones.</div>'; return; }
      d.posts.forEach(p=>{
        const a = document.createElement('a');
        a.href = '#';
        a.className = 'ig-item';
        
        const img = document.createElement('img');
        setSrcWithFallback(img, [
          p.media?.thumb, p.media?.t1, p.media?.['t1_bw'],
          p.media?.original, p.media?.url, p.media?.src,
          p.media?.t2, p.media?.t3, p.media?.t4, p.media?.t5, p.media?.t6, p.media?.t7, p.media?.t8, p.media?.t9, p.media?.t10
        ]);
        img.alt = '';
        
        a.appendChild(img);
        a.addEventListener('click', ev=>{ ev.preventDefault(); openPostModal(p); });
        grid.appendChild(a);
      });
    }

    async function openPostModal(p){
      lbImg.style.display = 'block';
      setSrcWithFallback(lbImg, [
        resolveMediaSrc(p.media),
        p.media?.t1, p.media?.thumb, p.media?.original, p.media?.url, p.media?.src,
        p.media?.t2, p.media?.t3, p.media?.t4, p.media?.t5, p.media?.t6, p.media?.t7, p.media?.t8, p.media?.t9, p.media?.t10
      ]);
      const u = await getUserPublic(p.userId);
      const display = u ? (u.name || `${u.firstName||''} ${u.lastName||''}`.trim() || u.nickname) : 'Usuario';
      lbAva.src  = resolveAvatar(u); 
      lbName.textContent = display;
      lbName.href = `profile.html?id=${p.userId}`;
      lbName.onmouseenter = () => lbName.style.color = 'var(--primary)';
      lbName.onmouseleave = () => lbName.style.color = 'var(--text)';
      lbAva.onclick = () => location.href = `profile.html?id=${p.userId}`;
      lbUser.textContent = u ? `@${u.nickname || u.email?.split('@')[0] || 'usuario'}` : '';
      
      // Sincronizar likes y comentarios
      const lbLike = document.getElementById('lbLike');
      const lbLikes = document.getElementById('lbLikes');
      const lbCommentsCount = document.getElementById('lbCommentsCount');
      const lbComment = document.getElementById('lbComment');
      
      lbLike.setAttribute('aria-pressed', p.viewerLiked ? 'true' : 'false');
      lbLikes.textContent = p.counts?.likes || 0;
      lbCommentsCount.textContent = p.counts?.comments || 0;
      
      // Funcionalidad de like
      lbLike.onclick = async ()=>{
        const pressed = lbLike.getAttribute('aria-pressed') === 'true';
        lbLike.setAttribute('aria-pressed', (!pressed) + '');
        const newCount = (+lbLikes.textContent + (pressed ? -1 : 1));
        lbLikes.textContent = newCount;        try{
          const r = await fetch(API(`/posts/${p.id}/likes/toggle`), { method:'POST', headers:H });
          const d = await r.json();
          if(!d.ok) throw 0;
        }catch{
          lbLike.setAttribute('aria-pressed', pressed + '');
          const revertCount = (+lbLikes.textContent + (pressed ? 1 : -1));
          lbLikes.textContent = revertCount;
        }
      };
      
      lbComment.onclick = ()=>{ lbInp.focus(); lbBody.scrollTop = lbBody.scrollHeight; };
      
      // Mostrar botón mensaje si no es tu post
      const lbMessageBtn = document.getElementById('lbMessage');
      const isMyPost = me && (String(p.userId) === String(me._id || me.id));
      if (!isMyPost && p.userId) {
        lbMessageBtn.style.display = 'inline-flex';
        lbMessageBtn.onclick = () => {
          window.location.href = `messages.html?userId=${p.userId}`;
        };
      } else {
        lbMessageBtn.style.display = 'none';
      }
      
      // Mostrar botón eliminar solo si es tu publicación
      const lbDeleteBtn = document.getElementById('lbDelete');
      if (isMyPost) {
        lbDeleteBtn.style.display = 'block';
        lbDeleteBtn.onclick = async () => {
          showConfirmModal(
            '¿Eliminar publicación?',
            'Esta acción no se puede deshacer. Se eliminarán todos los likes y comentarios asociados.',
            async () => {
              lbDeleteBtn.disabled = true;
              lbDeleteBtn.innerHTML = '<i data-lucide="loader"></i>';
              if (window.lucide) lucide.createIcons();
              
              const r = await fetch(API(`/posts/${p.id}`), { method:'DELETE', headers:H });
              const d = await r.json();
              
              if (d.ok){
                closePostModal();
                // Recargar grid
                const myId = me?._id || me?.id || '';
                await loadProfilePostsIG(myId);
              } else {
                alert(d.message || 'Error al eliminar');
                lbDeleteBtn.disabled = false;
                lbDeleteBtn.innerHTML = `
                  <svg viewBox="0 0 24 24" width="18" height="18" stroke="currentColor" stroke-width="2" fill="none">
                    <polyline points="3 6 5 6 21 6"></polyline>
                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                  </svg>
                `;
              }
            }
          );
        };
      } else {
        lbDeleteBtn.style.display = 'none';
      }
      
      const comments = await listPostComments(p.id); 
      const authors = new Map(); 
      if (u) authors.set(String(p.userId), u);
      
      // Agregar todos los comentaristas al mapa de autores
      for (const c of comments){
        if (!authors.has(String(c.userId))){
          const cu = await getUserCached(c.userId);
          if (cu) authors.set(String(c.userId), cu);
        }
      }
      
      renderComments(comments, authors);
      lbCommentsCount.textContent = comments.length;
      
      lbSend.onclick = async ()=>{
        const t = lbInp.value.trim(); if (!t) return;
        const c = await addPostComment(p.id, t);
        if (c){ 
          lbInp.value=''; 
          comments.push(c); 
          renderComments(comments, authors); 
          lbCommentsCount.textContent = comments.length;
        }
      };

      // Botón reconocimiento facial
      lbFaceRecognitionBtn.onclick = async ()=> {
        await analyzeFaceInPost(p);
      };

      lb.setAttribute('aria-hidden','false');
      if (window.lucide) lucide.createIcons();
    }
    function closePostModal(){ 
      lb.setAttribute('aria-hidden','true'); 
      lbImg.removeAttribute('src'); 
      lbInp.value=''; 
      lbBody.innerHTML=''; 
      const lbDeleteBtn = document.getElementById('lbDelete');
      lbDeleteBtn.style.display = 'none';
      const lbLike = document.getElementById('lbLike');
      const lbLikes = document.getElementById('lbLikes');
      const lbCommentsCount = document.getElementById('lbCommentsCount');
      lbLike.setAttribute('aria-pressed','false');
      lbLikes.textContent = '0';
      lbCommentsCount.textContent = '0';
    }
    lbClose.onclick = closePostModal;
    lb.addEventListener('click',(e)=>{ if(e.target===lb) closePostModal(); });
    document.addEventListener('keydown',(e)=>{ if(e.key==='Escape' && lb.getAttribute('aria-hidden')==='false') closePostModal(); });

    (async ()=>{
      const meResp = await fetch(API('/user/me'), { headers:H });
      const meData = await meResp.json();
      const myId = meData?.user?._id || '';
      const uid  = (viewId && viewId!==myId) ? viewId : myId;
      await loadProfilePostsIG(uid);
    })();

    // Actualizar badge de notificaciones
    async function updateNotificationBadge() {
      try {
        const res = await fetch(API('/notifications/unread-count'), { headers: H });
        const data = await res.json();
        const badge = document.getElementById('notificationsBadge');
        if (badge) {
          if (data.ok && data.count > 0) {
            badge.textContent = data.count > 99 ? '99+' : data.count;
            badge.style.display = 'inline-flex';
          } else {
            badge.style.display = 'none';
          }
        }
      } catch (error) {
        console.error('Error actualizando badge de notificaciones:', error);
      }
    }

    // Actualizar badge cada 30 segundos
    updateNotificationBadge();
    setInterval(updateNotificationBadge, 30000);

    // Manejar notificaciones - abrir post si viene del parámetro postId
    (async function() {
      const params = new URLSearchParams(window.location.search);
      const postId = params.get('postId');
      
      if (postId) {
        console.log('Abriendo post desde notificación en profile:', postId);
        
        try {
          // Obtener los datos del post desde la API
          const res = await fetch(API(`/posts/${postId}`), { headers: H });
          const data = await res.json();
          
          if (data.ok && data.post) {
            console.log('Post obtenido de la API:', data.post);
            // Abrir el modal directamente con los datos del post
            openPostModal(data.post);
          } else {
            console.error('No se pudo obtener el post');
          }
        } catch (error) {
          console.error('Error obteniendo post:', error);
        }
      }
    })();
  </script>

  <!-- Sistema de Transformaciones de Imágenes -->
  <script src="js/transformations.js"></script>

  <!-- Footer -->
  <footer style="text-align:center;padding:16px;margin-top:40px;font-size:0.85rem;color:var(--muted);border-top:1px solid var(--line)">
    © 2025 Proyecto Desarrollo Web - Desarrollado por Dilan Escobar y Andrea Chafolla
  </footer>

  <!-- Sidebar unificado -->
  <script src="js/sidebar.js"></script>
</body>
</html>
