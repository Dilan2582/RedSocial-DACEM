<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Perfil ‚Äì DACEM</title>
  
  <!-- Fuente Plus Jakarta Sans -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
  
  <!-- Iconos Lucide -->
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>
  
  <!-- Pre-aplica el tema para evitar FOUC -->
  <script>
    (function(){
      const saved = localStorage.getItem('theme') || 'dark';
      document.documentElement.setAttribute('data-theme', saved);
    })();
  </script>
  
  <link rel="stylesheet" href="css/profile.css">
  <link rel="stylesheet" href="css/transformations.css">
</head>
<body class="profile-page">
  <!-- Topbar -->
  <header class="topbar">
    <div class="topbar-inner">
      <div class="brand">
        <span class="logo-badge"><img src="img/Dacem.png" alt="DACEM"></span>
        DACEM
      </div>
      <div class="topbar-actions">
        <button id="themeToggle" class="btn ghost small" title="Cambiar tema">
          <i class="nav-ico" data-lucide="moon"></i>
          <span id="themeTxt">Modo oscuro</span>
        </button>
        <button id="logoutBtnTop" class="btn danger small">Cerrar sesi√≥n</button>
      </div>
    </div>
  </header>

  <div class="wrap">
    <div class="layout">
      <!-- Sidebar -->
      <aside class="sidebar">
        <nav class="nav">
          <a class="nav-item" href="user.html">
            <span class="nav-ico" aria-hidden="true">
              <svg viewBox="0 0 24 24"><path d="M3 10.5 12 3l9 7.5M5 10v10h14V10" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
            </span>
            Inicio
          </a>
          <a class="nav-item" href="messages.html">
            <span class="nav-ico" aria-hidden="true">
              <svg viewBox="0 0 24 24"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
            </span>
            Mensajes
            <span class="unread-badge" id="unreadBadge" style="display:none"></span>
          </a>
          <a class="nav-item active" href="profile.html">
            <span class="nav-ico" aria-hidden="true">
              <svg viewBox="0 0 24 24"><path d="M16 7a4 4 0 1 1-8 0 4 4 0 0 1 8 0ZM4 21a8 8 0 0 1 16 0" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
            </span>
            Mi perfil
          </a>
        </nav>
      </aside>

      <!-- Main -->
      <main class="main">
        <!-- Header moradito con banner -->
        <section class="profile-header">
          <div class="banner" id="banner"></div>

          <div class="profile-info">
            <div class="profile-header-top">
              <img id="avatarImg" class="profile-avatar" alt="Avatar">
              <div>
                <h1 id="nameTxt">Perfil</h1>
                <div class="profile-username">
                  @<span id="usernameTxt">usuario</span>
                  <span id="verified" class="badge" title="Verificado" style="display:none;">‚úî</span>
                </div>

                <div class="profile-stats">
                  <button class="stat" id="btnOpenFollowing" style="background:none;border:none;cursor:pointer;padding:0;color:inherit;font:inherit">
                    <strong id="followingCnt">0</strong>
                    <span>siguiendo</span>
                  </button>
                  <button class="stat" id="btnOpenFollowers" style="background:none;border:none;cursor:pointer;padding:0;color:inherit;font:inherit">
                    <strong id="followersCnt">0</strong>
                    <span>seguidores</span>
                  </button>
                </div>
              </div>

              <div class="profile-actions">
                <button id="btnFollow" class="btn" style="display:none">Seguir</button>
                <button id="btnSendMessage" class="btn" style="display:none" title="Enviar mensaje">
                  <span style="display:flex; align-items:center; gap:6px;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="flex-shrink:0">
                      <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                    </svg>
                    <span>Mensaje</span>
                  </span>
                </button>
                <button id="btnEdit" class="btn ghost" style="display:none">Editar perfil</button>
                <button id="btnManagePosts" class="btn ghost" style="display:none">Gestionar publicaciones</button>
              </div>
            </div>

            <div class="profile-bio" id="bioTxt">NoBioYet</div>
          </div>
        </section>

        <!-- Publicaciones (moradito sutil) -->
        <section class="posts-section" id="profilePosts">
          <h2>Publicaciones</h2>
          <div class="posts-grid grid-ig" id="gridIg"></div>
        </section>
      </main>
    </div>
  </div>

  <!-- Visor post -->
  <div class="lightbox" id="lightbox" aria-hidden="true">
    <div class="lb-content" role="dialog" aria-modal="true" aria-label="Publicaci√≥n">
      <button class="btn ghost small lb-close" id="lbClose">‚úï</button>
      <button class="btn danger small lb-delete" id="lbDelete" style="display:none; position:absolute; top:16px; right:60px; z-index:10;">
        <svg viewBox="0 0 24 24" width="16" height="16" stroke="currentColor" stroke-width="2" fill="none" style="margin-right:4px;">
          <polyline points="3 6 5 6 21 6"></polyline>
          <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
        </svg>
        Eliminar
      </button>
      <div class="lb-media"><img id="lbImg" alt=""></div>
      <aside class="lb-side">
        <header class="lb-head">
          <img id="lbAva" class="lb-ava" alt="">
          <div style="flex:1">
            <div id="lbName" style="font-weight:700"></div>
            <div id="lbUser" class="muted" style="font-size:12px"></div>
          </div>
          <button id="lbFaceAnalysis" class="btn ghost small" style="display:none" title="An√°lisis Facial">
            <span style="font-size:18px;">üòä</span>
          </button>
          <button id="lbMessage" class="btn ghost small" style="display:none" title="Enviar mensaje">
            <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
            </svg>
          </button>
        </header>
        <div class="lb-body" id="lbComments"></div>
        <div class="lb-input">
          <input id="lbInp" placeholder="A√±ade un comentario‚Ä¶">
          <button id="lbSend" class="btn">Publicar</button>
        </div>
      </aside>
    </div>
  </div>

  <!-- Modal Editar Perfil -->
  <div id="editModal" class="backdrop">
    <div class="modal">
      <div class="modal-head">
        <h3>Editar perfil</h3>
        <button class="btn ghost" id="closeEdit">Cerrar</button>
      </div>

      <div class="modal-body">
        <div>
          <div id="bannerPreview" class="banner-preview"></div>
          <input id="bannerFile" type="file" accept="image/*" hidden>
          <button class="btn" id="btnPickBanner">Cambiar banner</button>
        </div>

        <div>
          <div class="avatar avatar-xl">
            <img id="avatarPreview" class="avatar-img" alt="">
            <div id="avatarPreviewTxt" class="avatar-txt">U</div>
          </div>
          <input id="avatarFile" type="file" accept="image/*" hidden>
          <button class="btn" id="btnPickAvatar">Cambiar foto</button>
        </div>

        <div class="form">
          <label>Apodo</label>
          <input id="nicknameInp" placeholder="tuapodo">
          <label>Bio (opcional)</label>
          <textarea id="bioInp" rows="3" maxlength="240" placeholder="Algo sobre ti..."></textarea>
        </div>
      </div>

      <div class="modal-foot">
        <span id="saveMsg" class="muted"></span>
        <button class="btn" id="btnSave">Guardar cambios</button>
      </div>
    </div>
  </div>

  <!-- Modal Seguidores / Siguiendo -->
  <div id="followModal" class="backdrop">
    <div class="modal" style="max-width:640px">
      <div class="modal-head" style="justify-content:space-between; gap:12px;">
        <div class="tabs" id="followTabs">
          <button class="btn ghost small active" data-tab="followers">Seguidores</button>
          <button class="btn ghost small" data-tab="following">Siguiendo</button>
        </div>
        <button class="btn ghost" id="closeFollow">Cerrar</button>
      </div>

      <div class="modal-body" style="display:flex; flex-direction:column; gap:12px;">
        <input id="followSearch" placeholder="Buscar" class="input" />
        <div id="followList" class="list-users"></div>
        <div style="text-align:center;">
          <button id="followMore" class="btn" style="display:none">Cargar m√°s</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Gestionar Publicaciones -->
  <div id="managePostsModal" class="backdrop">
    <div class="modal" style="max-width:900px">
      <div class="modal-head">
        <h3>Gestionar Publicaciones</h3>
        <button class="btn ghost" id="closeManagePosts">Cerrar</button>
      </div>

      <div class="modal-body" style="max-height:600px; overflow-y:auto;">
        <div id="managePostsList" style="display:flex; flex-direction:column; gap:16px;"></div>
      </div>
    </div>
  </div>

  <!-- Modal Ver Comentarios de Post -->
  <div id="viewCommentsModal" class="backdrop">
    <div class="modal" style="max-width:600px">
      <div class="modal-head">
        <h3>Comentarios</h3>
        <button class="btn ghost" id="closeViewComments">Cerrar</button>
      </div>

      <div class="modal-body" style="max-height:500px; overflow-y:auto;">
        <div id="commentsList" style="display:flex; flex-direction:column; gap:12px;"></div>
      </div>
    </div>
  </div>

  <!-- Modal Confirmaci√≥n Eliminar -->
  <div id="confirmDeleteModal" class="backdrop">
    <div class="modal confirm-modal" style="max-width:480px;">
      <div class="confirm-icon">
        <svg viewBox="0 0 24 24" width="48" height="48" stroke="currentColor" stroke-width="2" fill="none">
          <circle cx="12" cy="12" r="10"></circle>
          <line x1="12" y1="8" x2="12" y2="12"></line>
          <line x1="12" y1="16" x2="12.01" y2="16"></line>
        </svg>
      </div>
      
      <h3 id="confirmTitle" style="text-align:center; margin:16px 0 8px;">¬øEliminar publicaci√≥n?</h3>
      <p id="confirmMessage" style="text-align:center; color:var(--muted); margin-bottom:24px;">
        Esta acci√≥n no se puede deshacer. Se eliminar√°n todos los likes y comentarios asociados.
      </p>
      
      <div style="display:flex; gap:12px; justify-content:center;">
        <button class="btn ghost" id="confirmCancel">Cancelar</button>
        <button class="btn danger" id="confirmDelete">Eliminar</button>
      </div>
    </div>
  </div>

  <!-- Modal An√°lisis Facial -->
  <div id="faceAnalysisModal" class="backdrop" style="z-index:10000">
    <div class="modal" style="max-width:600px; max-height:90vh; overflow-y:auto">
      <div class="modal-head" style="background:linear-gradient(135deg, #667eea 0%, #764ba2 100%); color:white; padding:20px">
        <h3 style="margin:0; font-size:20px">üîç An√°lisis Facial</h3>
        <button class="btn ghost small" id="closeFaceAnalysis" style="color:white; border-color:rgba(255,255,255,0.3)">&times;</button>
      </div>
      <div class="modal-body" id="faceAnalysisContent" style="padding:20px">
        <div class="muted" style="text-align:center">Cargando an√°lisis...</div>
      </div>
    </div>
  </div>

  <!-- JS (id√©ntico al tuyo, solo funciona con los mismos IDs) -->
  <script>
    // Toggle tema
    const themeBtn = document.getElementById('themeToggle');
    const themeTxt = document.getElementById('themeTxt');

    const labelFor = (t) => (t === 'dark' ? 'Modo claro' : 'Modo oscuro');

    function applyTheme(t){
      document.documentElement.setAttribute('data-theme', t);
      localStorage.setItem('theme', t);

      const icon = themeBtn?.querySelector('[data-lucide]');
      if (icon) icon.setAttribute('data-lucide', t === 'dark' ? 'sun' : 'moon');

      if (themeTxt) themeTxt.textContent = labelFor(t);
      if (window.lucide) lucide.createIcons();
    }

    themeBtn?.addEventListener('click', ()=>{
      const current = document.documentElement.getAttribute('data-theme') || 'dark';
      applyTheme(current === 'dark' ? 'light' : 'dark');
    });

    // Inicializar icono + texto correctos al cargar
    (function(){
      const saved = localStorage.getItem('theme')
        || (matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
      document.documentElement.setAttribute('data-theme', saved);

      const icon = themeBtn?.querySelector('[data-lucide]');
      if (icon) icon.setAttribute('data-lucide', saved === 'dark' ? 'sun' : 'moon');

      if (themeTxt) themeTxt.textContent = labelFor(saved);
      if (window.lucide) lucide.createIcons();
    })();

    const API = (p)=>`${location.origin}/api${p}`;
    const token = localStorage.getItem('token');
    if(!token){ location.replace('index.html'); }
    const H  = { 'Authorization':`Bearer ${token}` };
    const JH = { ...H, 'Content-Type':'application/json' };
    const $  = s => document.querySelector(s);
    const qs = new URLSearchParams(location.search);
    const viewId = qs.get('id');

    let me=null, other=null, isFollowing=false;

    const displayName = (u)=> u?.name || `${u?.firstName||''} ${u?.lastName||''}`.trim() || (u?.nickname || 'Usuario');
    const initialLetter= (u)=> (u?.firstName?.[0] || u?.name?.[0] || u?.nickname?.[0] || 'U').toUpperCase();
    const abs = (url)=>!url ? '' : (url.startsWith('http') ? url : `${location.origin}${url.startsWith('/')?url:'/'+url}`);

    function setAvatarBox(imgEl, txtEl, u){
      if (u?.avatar){ imgEl.src = abs(u.avatar); imgEl.style.display='block'; if(txtEl) txtEl.style.display='none'; }
      else { imgEl.removeAttribute('src'); imgEl.style.display='none'; if(txtEl){ txtEl.textContent = initialLetter(u); txtEl.style.display='flex'; } }
    }
    function resolveAvatar(u){
      if (!u) return `https://api.dicebear.com/8.x/initials/svg?seed=U&radius=50&scale=110&fontWeight=700`;
      if (u.avatar) return u.avatar.startsWith('http') ? u.avatar : `${location.origin}${u.avatar.startsWith('/')?u.avatar:'/'+u.avatar}`;
      const seed = encodeURIComponent((u.firstName || u.name || u.nickname || 'U'));
      return `https://api.dicebear.com/8.x/initials/svg?seed=${seed}&radius=50&scale=110&fontWeight=700`;
    }

    /* ---------- Follow modal (id√©ntico a tu versi√≥n) ---------- */
    const followModal  = document.getElementById('followModal');
    const followTabs   = document.getElementById('followTabs');
    const followList   = document.getElementById('followList');
    const followMore   = document.getElementById('followMore');
    const followSearch = document.getElementById('followSearch');
    document.getElementById('closeFollow').onclick = ()=> followModal.removeAttribute('data-open');

    const REL_STATE = new Map();
    let FOLLOW_STATE = { tab:'followers', userId:null, cursor:null, cache:[] };

    function openFollowModal(tab, userId){
      FOLLOW_STATE = { tab, userId, cursor:null, cache:[] };
      [...followTabs.querySelectorAll('button')].forEach(b=> b.classList.toggle('active', b.dataset.tab===tab));
      followSearch.value = '';
      followList.innerHTML = '<div class="muted">Cargando...</div>';
      followModal.setAttribute('data-open','true');
      loadFollowPage(true);
    }

    async function loadFollowPage(first=false){
      const limit = 20;
      const url = new URL(API(`/follow/${FOLLOW_STATE.userId}/${FOLLOW_STATE.tab}`));
      url.searchParams.set('limit', String(limit));
      if (FOLLOW_STATE.cursor) url.searchParams.set('cursor', FOLLOW_STATE.cursor);
      const r = await fetch(url.toString(), { headers:H });
      const d = await r.json();
      if (!d.ok){ followList.innerHTML = '<div class="muted">No disponible</div>'; return; }
      if (first) { followList.innerHTML = ''; FOLLOW_STATE.cache = []; }
      (d.users || []).forEach(u => FOLLOW_STATE.cache.push(u));
      FOLLOW_STATE.cursor = d.nextCursor || null;
      followMore.style.display = FOLLOW_STATE.cursor ? 'inline-block' : 'none';
      renderFollowList();
    }

    async function ensureFollowFlag(id){
      if (REL_STATE.has(id)) return REL_STATE.get(id);
      try{
        const rr = await fetch(API(`/user/${id}/public`), { headers:H });
        const dd = await rr.json();
        const val = !!dd.isFollowing;
        REL_STATE.set(id, val);
        return val;
      }catch{ return false; }
    }

    function rowTemplate(u, followingNow){
      const row = document.createElement('div');
      row.className='user-row';
      row.innerHTML = `
        <img src="${resolveAvatar(u)}" alt="">
        <div class="u-info">
          <div class="u-name">${displayName(u)}</div>
          <div class="u-nick">@${u.nickname || 'usuario'}</div>
        </div>
        <div class="u-actions">
          <a class="btn ghost small" href="profile.html?id=${u.id}">Ver</a>
          <button class="btn small follow-toggle">${followingNow ? 'Dejar de seguir' : 'Seguir'}</button>
        </div>`;
      return row;
    }

    async function renderFollowList(){
      const q = followSearch.value.trim().toLowerCase();
      followList.innerHTML = '';
      const rows = FOLLOW_STATE.cache.filter(u => {
        if (!q) return true;
        const s = `${u.firstName||''} ${u.lastName||''} ${u.nickname||''}`.toLowerCase();
        return s.includes(q);
      });
      if (!rows.length){ followList.innerHTML = '<div class="muted">Sin resultados</div>'; return; }

      for (const u of rows){
        let followingNow = FOLLOW_STATE.tab === 'following' ? true : REL_STATE.get(u.id);
        const row = rowTemplate(u, !!followingNow);
        const btn = row.querySelector('.follow-toggle');
        if (FOLLOW_STATE.tab === 'followers' && followingNow === undefined){
          ensureFollowFlag(u.id).then(()=>{ btn.textContent = (REL_STATE.get(u.id) ? 'Dejar de seguir' : 'Seguir'); });
        }
        btn.onclick = async ()=>{
          btn.disabled = true;
          try{
            const r = await fetch(API(`/follow/toggle/${u.id}`), { method:'POST', headers:H });
            if (r.status !== 404){
              const d = await r.json(); if (d.ok) REL_STATE.set(u.id, !!d.following);
            }else{
              const currently = FOLLOW_STATE.tab==='following' ? true : (REL_STATE.get(u.id) || false);
              const m = currently ? 'DELETE' : 'POST';
              const r2 = await fetch(API(`/follow/${u.id}`), { method:m, headers:H });
              const d2 = await r2.json(); if (d2.ok) REL_STATE.set(u.id, !currently);
            }
          } finally {
            const now = REL_STATE.get(u.id) || false;
            if (FOLLOW_STATE.tab==='following' && !now){
              row.remove();
              const cntEl = document.getElementById('followingCnt');
              if (cntEl) cntEl.textContent = Math.max(0, (+cntEl.textContent||1) - 1);
            }else{
              btn.textContent = now ? 'Dejar de seguir' : 'Seguir';
            }
            btn.disabled = false;
          }
        };
        followList.appendChild(row);
      }
    }

    followMore.onclick = ()=> loadFollowPage(false);
    followSearch.oninput = ()=> renderFollowList();
    followTabs.addEventListener('click', (e)=>{
      const b=e.target.closest('button[data-tab]'); if(!b) return;
      openFollowModal(b.dataset.tab, FOLLOW_STATE.userId);
    });

    document.getElementById('btnOpenFollowers')?.addEventListener('click', ()=>{
      const uid = (viewId && viewId!==(me?._id||'')) ? viewId : (me?._id || '');
      openFollowModal('followers', uid);
    });
    document.getElementById('btnOpenFollowing')?.addEventListener('click', ()=>{
      const uid = (viewId && viewId!==(me?._id||'')) ? viewId : (me?._id || '');
      openFollowModal('following', uid);
    });

    /* ---------- Perfil ---------- */
    function paintProfile(u, counts){
      const hasBanner = !!u.banner;
      document.getElementById('banner').style.backgroundImage = hasBanner ? `url(${abs(u.banner)})` : 'none';
      document.querySelector('.main').classList.toggle('has-banner', hasBanner); // inofensivo
      document.getElementById('nameTxt').textContent = displayName(u);
      document.getElementById('usernameTxt').textContent = u.nickname || 'usuario';
      document.getElementById('followersCnt').textContent = counts?.followers ?? 0;
      document.getElementById('followingCnt').textContent = counts?.following ?? 0;
      document.getElementById('verified').style.display = u.isVerified ? 'inline' : 'none';
      setAvatarBox(document.getElementById('avatarImg'), null, u);
      document.getElementById('bioTxt').textContent = (u.bio && u.bio.trim()) ? u.bio : 'NoBioYet';
    }

    async function loadMe(){
      const r = await fetch(API('/user/me'), { headers:H });
      const d = await r.json();
      if(!d.ok){ localStorage.removeItem('token'); return location.replace('index.html'); }
      me = d.user; return { user:d.user, counts:d.counts };
    }
    async function loadOther(id){
      const r = await fetch(API(`/user/${id}/public`), { headers:H });
      const d = await r.json();
      if(!d.ok) throw new Error(d.message || 'No encontrado');
      other = d.user; isFollowing = !!d.isFollowing;
      return { user:d.user, counts:d.counts };
    }

    async function toggleFollow(){
      const btn = document.getElementById('btnFollow');
      btn.disabled = true;
      const tryToggle = await fetch(API(`/follow/toggle/${other._id}`), { method:'POST', headers:H });
      if (tryToggle.status !== 404){
        const d = await tryToggle.json(); if (d.ok) isFollowing = !isFollowing;
      }else{
        const r = await fetch(API(`/follow/${other._id}`), { method: isFollowing ? 'DELETE' : 'POST', headers:H });
        const d = await r.json(); if (d.ok) isFollowing = !isFollowing;
      }
      btn.textContent = isFollowing ? 'Dejar de seguir' : 'Seguir';
      btn.disabled = false;
    }

    /* ---------- Editar perfil ---------- */
    const modal = document.getElementById('editModal');
    const openModal  = ()=> modal.setAttribute('data-open','true');
    const closeModal = ()=> modal.removeAttribute('data-open');
    document.getElementById('closeEdit').onclick = closeModal;

    function prefillEdit(){
      document.getElementById('bannerPreview').style.backgroundImage = me.banner ? `url(${abs(me.banner)})` : 'none';
      setAvatarBox(document.getElementById('avatarPreview'), document.getElementById('avatarPreviewTxt'), me);
      document.getElementById('nicknameInp').value = me.nickname || '';
      document.getElementById('bioInp').value = me.bio || '';
      document.getElementById('saveMsg').textContent = '';
    }
    document.getElementById('btnPickBanner').onclick = ()=> document.getElementById('bannerFile').click();
    document.getElementById('btnPickAvatar').onclick = ()=> document.getElementById('avatarFile').click();

    document.getElementById('bannerFile').addEventListener('change', async (e)=>{
      const f = e.target.files?.[0]; if(!f) return;
      const fd = new FormData(); fd.append('banner', f);
      const r = await fetch(API('/user/me/banner'), { method:'PUT', headers:H, body:fd });
      const d = await r.json();
      if (d.ok){
        document.getElementById('bannerPreview').style.backgroundImage = `url(${d.banner})`;
        document.getElementById('banner').style.backgroundImage = `url(${d.banner})`;
      }
      e.target.value = '';
    });

    document.getElementById('avatarFile').addEventListener('change', async (e)=>{
      const f = e.target.files?.[0]; if(!f) return;
      const fd = new FormData(); fd.append('avatar', f);
      const r = await fetch(API('/user/me/avatar'), { method:'POST', headers:H, body:fd });
      const d = await r.json();
      if (d.ok){ await refreshMe(); }
      e.target.value = '';
    });

    async function refreshMe(){
      const r = await fetch(API('/user/me'), { headers:H });
      const d = await r.json();
      if (d.ok){ me = d.user; paintProfile(me, d.counts); prefillEdit(); }
    }
    document.getElementById('btnSave').onclick = async ()=>{
      document.getElementById('saveMsg').textContent = 'Guardando...';
      const payload = { nickname: document.getElementById('nicknameInp').value.trim(), bio: document.getElementById('bioInp').value.trim() };
      const r = await fetch(API('/user/update'), { method:'PUT', headers:JH, body:JSON.stringify(payload) });
      const d = await r.json();
      document.getElementById('saveMsg').textContent = d.ok ? 'Guardado' : (d.message || 'Error');
      if (d.ok) await refreshMe();
    };

    /* ---------- Init ---------- */
    (async ()=>{
      const meData = await loadMe();
      const myId = meData.user._id?.toString?.() || meData.user.id || '';
      if (viewId && viewId !== myId){
        const { user, counts } = await loadOther(viewId);
        paintProfile(user, counts);
        document.getElementById('btnEdit').style.display = 'none';
        document.getElementById('btnManagePosts').style.display = 'none';
        const bf = document.getElementById('btnFollow');
        bf.style.display = 'inline-block';
        bf.textContent = isFollowing ? 'Dejar de seguir' : 'Seguir';
        bf.onclick = toggleFollow;
        
        // Bot√≥n enviar mensaje
        const bm = document.getElementById('btnSendMessage');
        bm.style.display = 'inline-block';
        bm.onclick = ()=> window.location.href = `messages.html?userId=${viewId}`;
      }else{
        paintProfile(meData.user, meData.counts);
        document.getElementById('btnFollow').style.display = 'none';
        document.getElementById('btnSendMessage').style.display = 'none';
        const be = document.getElementById('btnEdit');
        be.style.display = 'inline-block';
        be.onclick = ()=>{ prefillEdit(); openModal(); };
        
        // Bot√≥n gestionar publicaciones
        const bm = document.getElementById('btnManagePosts');
        bm.style.display = 'inline-block';
        bm.onclick = openManagePostsModal;
      }
    })();

    // Logout
    document.getElementById('logoutBtnTop')?.addEventListener('click', ()=>{
      localStorage.removeItem('token'); localStorage.removeItem('user'); location.replace('index.html');
    });

    /* ---------- Gestionar Publicaciones ---------- */
    const managePostsModal = document.getElementById('managePostsModal');
    const managePostsList = document.getElementById('managePostsList');
    document.getElementById('closeManagePosts').onclick = ()=> managePostsModal.removeAttribute('data-open');

    const viewCommentsModal = document.getElementById('viewCommentsModal');
    const commentsList = document.getElementById('commentsList');
    document.getElementById('closeViewComments').onclick = ()=> viewCommentsModal.removeAttribute('data-open');

    // Modal de confirmaci√≥n
    const confirmDeleteModal = document.getElementById('confirmDeleteModal');
    const confirmTitle = document.getElementById('confirmTitle');
    const confirmMessage = document.getElementById('confirmMessage');
    const confirmDeleteBtn = document.getElementById('confirmDelete');
    const confirmCancelBtn = document.getElementById('confirmCancel');
    
    let deleteCallback = null;

    function showConfirmModal(title, message, onConfirm) {
      confirmTitle.textContent = title;
      confirmMessage.textContent = message;
      deleteCallback = onConfirm;
      confirmDeleteModal.setAttribute('data-open', 'true');
    }

    function hideConfirmModal() {
      confirmDeleteModal.removeAttribute('data-open');
      deleteCallback = null;
    }

    confirmCancelBtn.onclick = hideConfirmModal;
    confirmDeleteBtn.onclick = async () => {
      if (deleteCallback) {
        await deleteCallback();
        hideConfirmModal();
      }
    };

    // Cerrar modal al hacer click fuera
    confirmDeleteModal.addEventListener('click', (e) => {
      if (e.target === confirmDeleteModal) hideConfirmModal();
    });

    async function openManagePostsModal(){
      managePostsModal.setAttribute('data-open', 'true');
      managePostsList.innerHTML = '<div class="muted">Cargando publicaciones...</div>';
      
      const myId = me?._id || me?.id || '';
      const url = new URL(API('/posts'));
      url.searchParams.set('userId', myId);
      url.searchParams.set('limit', '50');
      
      const r = await fetch(url, { headers:H });
      const d = await r.json();
      
      if (!d.ok || !d.posts?.length){
        managePostsList.innerHTML = '<div class="muted">No tienes publicaciones a√∫n.</div>';
        return;
      }

      managePostsList.innerHTML = '';
      d.posts.forEach(post => {
        const postCard = document.createElement('div');
        postCard.style.cssText = 'border:1px solid var(--line); border-radius:8px; padding:16px; display:flex; gap:16px;';
        postCard.innerHTML = `
          <img src="${post.media.thumb}" alt="" style="width:120px; height:120px; object-fit:cover; border-radius:8px;">
          <div style="flex:1; display:flex; flex-direction:column; gap:8px;">
            <div style="font-size:14px; color:var(--muted);">
              ${post.caption || 'Sin descripci√≥n'}
            </div>
            <div style="font-size:12px; color:var(--muted);">
              ${post.counts?.likes || 0} likes ¬∑ ${post.counts?.comments || 0} comentarios
            </div>
            <div style="display:flex; gap:8px; margin-top:auto;">
              <button class="btn ghost small view-comments-btn" data-post-id="${post.id}">
                Ver comentarios
              </button>
              <button class="btn danger small delete-post-btn" data-post-id="${post.id}">
                Eliminar publicaci√≥n
              </button>
            </div>
          </div>
        `;
        
        // Evento ver comentarios
        postCard.querySelector('.view-comments-btn').onclick = ()=> openViewCommentsModal(post.id);
        
        // Evento eliminar post
        postCard.querySelector('.delete-post-btn').onclick = async (e)=>{
          const btn = e.target;
          
          showConfirmModal(
            '¬øEliminar publicaci√≥n?',
            'Esta acci√≥n no se puede deshacer. Se eliminar√°n todos los likes y comentarios asociados.',
            async () => {
              btn.disabled = true;
              btn.textContent = 'Eliminando...';
              
              const r = await fetch(API(`/posts/${post.id}`), { method:'DELETE', headers:H });
              const d = await r.json();
              
              if (d.ok){
                postCard.remove();
                // Recargar grid
                const myId = me?._id || me?.id || '';
                await loadProfilePostsIG(myId);
              } else {
                alert(d.message || 'Error al eliminar');
                btn.disabled = false;
                btn.textContent = 'Eliminar publicaci√≥n';
              }
            }
          );
        };
        
        managePostsList.appendChild(postCard);
      });
    }

    async function openViewCommentsModal(postId){
      viewCommentsModal.setAttribute('data-open', 'true');
      commentsList.innerHTML = '<div class="muted">Cargando comentarios...</div>';
      
      const comments = await listPostComments(postId);
      
      if (!comments.length){
        commentsList.innerHTML = '<div class="muted">No hay comentarios en esta publicaci√≥n.</div>';
        return;
      }

      commentsList.innerHTML = '';
      
      for (const comment of comments){
        const u = await getUserPublic(comment.userId);
        const display = u ? (u.name || `${u.firstName||''} ${u.lastName||''}`.trim() || u.nickname) : 'Usuario';
        
        const commentCard = document.createElement('div');
        commentCard.style.cssText = 'border:1px solid var(--line); border-radius:8px; padding:12px; display:flex; justify-content:space-between; align-items:start; gap:12px;';
        commentCard.innerHTML = `
          <div style="flex:1;">
            <div style="font-weight:600; margin-bottom:4px;">${display}</div>
            <div style="font-size:14px; color:var(--muted);">${comment.text}</div>
            <div style="font-size:12px; color:var(--muted); margin-top:4px;">${timeAgo(comment.createdAt)}</div>
          </div>
          <button class="btn danger small delete-comment-btn" data-comment-id="${comment._id}" data-post-id="${postId}">
            Eliminar
          </button>
        `;
        
        // Evento eliminar comentario
        commentCard.querySelector('.delete-comment-btn').onclick = async (e)=>{
          const btn = e.target;
          
          showConfirmModal(
            '¬øEliminar comentario?',
            'Esta acci√≥n no se puede deshacer.',
            async () => {
              btn.disabled = true;
              btn.textContent = 'Eliminando...';
              
              const r = await fetch(API(`/posts/${postId}/comments/${comment._id}`), { method:'DELETE', headers:H });
              const d = await r.json();
              
              if (d.ok){
                commentCard.remove();
                // Si no quedan m√°s comentarios
                if (commentsList.children.length === 0){
                  commentsList.innerHTML = '<div class="muted">No hay m√°s comentarios.</div>';
                }
              } else {
                alert(d.message || 'Error al eliminar');
                btn.disabled = false;
                btn.textContent = 'Eliminar';
              }
            }
          );
        };
        
        commentsList.appendChild(commentCard);
      }
    }

    /* ---------- Grid + modal de post ---------- */
    const grid = document.getElementById('gridIg');
    const lb = document.getElementById('lightbox'), lbClose = document.getElementById('lbClose');
    const lbImg = document.getElementById('lbImg'), lbAva = document.getElementById('lbAva');
    const lbName = document.getElementById('lbName'), lbUser = document.getElementById('lbUser');
    const lbBody = document.getElementById('lbComments'), lbInp = document.getElementById('lbInp'), lbSend = document.getElementById('lbSend');

    const userCache = new Map();
    async function getUserPublic(uId){
      if (userCache.has(uId)) return userCache.get(uId);
      if (other && String(other._id) === String(uId)) { userCache.set(uId, other); return other; }
      if (me && String(me._id) === String(uId))       { userCache.set(uId, me);    return me;    }
      const r = await fetch(API(`/user/${uId}/public`), { headers:H });
      const d = await r.json();
      if (d.ok){ userCache.set(uId, d.user); return d.user; }
      return null;
    }
    async function listPostComments(postId){
      const r = await fetch(API(`/posts/${postId}/comments?limit=100`), { headers:H });
      const d = await r.json();
      return d.ok ? d.comments : [];
    }
    async function addPostComment(postId, text){
      const r = await fetch(API(`/posts/${postId}/comments`), { method:'POST', headers:{...H,'Content-Type':'application/json'}, body:JSON.stringify({ text }) });
      const d = await r.json(); return d.ok ? d.comment : null;
    }
    function renderComments(list, authorMap){
      lbBody.innerHTML = '';
      list.forEach(c=>{
        const u = authorMap.get(String(c.userId));
        const nm = u ? (u.name || `${u.firstName||''} ${u.lastName||''}`.trim() || u.nickname) : 'usuario';
        const row = document.createElement('div');
        row.className = 'lb-cmt';
        row.innerHTML = `<span class="nm">${nm}</span>${c.text}<span class="dt">${timeAgo(c.createdAt)}</span>`;
        lbBody.appendChild(row);
      });
      lbBody.scrollTop = lbBody.scrollHeight;
    }
    function timeAgo(iso){ try{ const d=new Date(iso); const s=(Date.now()-d)/1000;
      if(s<60) return 'ahora'; if(s<3600) return Math.floor(s/60)+' min';
      if(s<86400) return Math.floor(s/3600)+' h'; return Math.floor(s/86400)+' d';
    }catch{ return ''; } }

    async function loadProfilePostsIG(uid){
      const url = new URL(API('/posts')); url.searchParams.set('userId', uid); url.searchParams.set('limit', '36');
      const r = await fetch(url, { headers:H }); const d = await r.json(); grid.innerHTML='';
      if (!d.ok || !d.posts?.length){ grid.innerHTML = '<div class="muted">A√∫n no hay publicaciones.</div>'; return; }
      d.posts.forEach(p=>{
        const a=document.createElement('a'); a.href='#'; a.className='ig-item';
        a.innerHTML=`<img src="${p.media.thumb}" alt="">`;
        a.addEventListener('click', ev=>{ ev.preventDefault(); openPostModal(p); });
        grid.appendChild(a);
      });
    }

    async function openPostModal(p){
      window.currentPostData = p; // Guardar para sistema de transformaciones
      lbImg.src = p.media.t1 || p.media.original || p.media.thumb;
      const u = await getUserPublic(p.userId);
      const display = u ? (u.name || `${u.firstName||''} ${u.lastName||''}`.trim() || u.nickname) : 'Usuario';
      lbAva.src  = resolveAvatar(u); lbName.textContent = display; lbUser.textContent = u ? `@${u.nickname || 'usuario'}` : '';
      
      // Mostrar bot√≥n de an√°lisis facial si hay datos de Rekognition
      const lbFaceAnalysisBtn = document.getElementById('lbFaceAnalysis');
      if (p.visionRaw && p.visionRaw.faces && p.visionRaw.faces.length > 0) {
        lbFaceAnalysisBtn.style.display = 'inline-flex';
      } else {
        lbFaceAnalysisBtn.style.display = 'none';
      }
      
      // Mostrar bot√≥n mensaje si no es tu post
      const lbMessageBtn = document.getElementById('lbMessage');
      const isMyPost = me && (String(p.userId) === String(me._id || me.id));
      if (!isMyPost && p.userId) {
        lbMessageBtn.style.display = 'inline-flex';
        lbMessageBtn.onclick = () => {
          window.location.href = `messages.html?userId=${p.userId}`;
        };
      } else {
        lbMessageBtn.style.display = 'none';
      }
      
      // Mostrar informaci√≥n de Rekognition si est√° disponible
      const lbRekognition = document.getElementById('lbRekognition');
      const lbFaceCount = document.getElementById('lbFaceCount');
      const lbNsfw = document.getElementById('lbNsfw');
      const lbTagsContainer = document.getElementById('lbTagsContainer');
      
      if (p.tags && p.tags.length > 0 || p.faceCount !== undefined) {
        lbRekognition.style.display = 'block';
        
        // Face count
        lbFaceCount.textContent = p.faceCount || 0;
        
        // NSFW status
        lbNsfw.textContent = p.nsfw ? '‚ö†Ô∏è Sensible' : '‚úÖ Seguro';
        lbNsfw.style.color = p.nsfw ? 'var(--err)' : 'var(--ok)';
        
        // Tags
        lbTagsContainer.innerHTML = '';
        if (p.tags && p.tags.length > 0) {
          p.tags.slice(0, 5).forEach(tag => {
            const tagEl = document.createElement('span');
            tagEl.style.cssText = 'background:var(--primary); color:white; padding:4px 8px; border-radius:12px; font-size:11px; font-weight:600;';
            tagEl.textContent = tag;
            lbTagsContainer.appendChild(tagEl);
          });
        }
      } else {
        lbRekognition.style.display = 'none';
      }
      
      // Mostrar bot√≥n eliminar solo si es tu publicaci√≥n
      const lbDeleteBtn = document.getElementById('lbDelete');
      if (isMyPost) {
        lbDeleteBtn.style.display = 'block';
        lbDeleteBtn.onclick = async () => {
          showConfirmModal(
            '¬øEliminar publicaci√≥n?',
            'Esta acci√≥n no se puede deshacer. Se eliminar√°n todos los likes y comentarios asociados.',
            async () => {
              lbDeleteBtn.disabled = true;
              lbDeleteBtn.textContent = 'Eliminando...';
              
              const r = await fetch(API(`/posts/${p.id}`), { method:'DELETE', headers:H });
              const d = await r.json();
              
              if (d.ok){
                closePostModal();
                // Recargar grid
                const myId = me?._id || me?.id || '';
                await loadProfilePostsIG(myId);
              } else {
                alert(d.message || 'Error al eliminar');
                lbDeleteBtn.disabled = false;
                lbDeleteBtn.innerHTML = `
                  <svg viewBox="0 0 24 24" width="16" height="16" stroke="currentColor" stroke-width="2" fill="none" style="margin-right:4px;">
                    <polyline points="3 6 5 6 21 6"></polyline>
                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                  </svg>
                  Eliminar
                `;
              }
            }
          );
        };
      } else {
        lbDeleteBtn.style.display = 'none';
      }
      
      const comments = await listPostComments(p.id); const authors = new Map(); if (u) authors.set(String(p.userId), u);
      renderComments(comments, authors);
      lbSend.onclick = async ()=>{
        const t = lbInp.value.trim(); if (!t) return;
        const c = await addPostComment(p.id, t);
        if (c){ lbInp.value=''; comments.push(c); renderComments(comments, authors); }
      };
      lb.setAttribute('aria-hidden','false');
    }
    function closePostModal(){ 
      lb.setAttribute('aria-hidden','true'); 
      lbImg.removeAttribute('src'); 
      lbInp.value=''; 
      lbBody.innerHTML=''; 
      const lbDeleteBtn = document.getElementById('lbDelete');
      lbDeleteBtn.style.display = 'none';
    }
    lbClose.onclick = closePostModal;
    lb.addEventListener('click',(e)=>{ if(e.target===lb) closePostModal(); });
    document.addEventListener('keydown',(e)=>{ if(e.key==='Escape' && lb.getAttribute('aria-hidden')==='false') closePostModal(); });

    // Modal de An√°lisis Facial
    const faceAnalysisModal = document.getElementById('faceAnalysisModal');
    const closeFaceAnalysisBtn = document.getElementById('closeFaceAnalysis');
    const faceAnalysisContent = document.getElementById('faceAnalysisContent');
    
    closeFaceAnalysisBtn.onclick = () => faceAnalysisModal.removeAttribute('data-open');
    faceAnalysisModal.addEventListener('click', (e) => {
      if (e.target === faceAnalysisModal) faceAnalysisModal.removeAttribute('data-open');
    });
    
    document.getElementById('lbFaceAnalysis').addEventListener('click', () => {
      if (!window.currentPostData || !window.currentPostData.visionRaw) return;
      
      const faces = window.currentPostData.visionRaw.faces || [];
      if (faces.length === 0) return;
      
      faceAnalysisModal.setAttribute('data-open', 'true');
      
      // Construir HTML del an√°lisis
      let html = `<p style="color:var(--muted); margin-bottom:20px">Se detectaron ${faces.length} rostro(s) en la imagen</p>`;
      
      faces.forEach((face, index) => {
        const ageRange = face.AgeRange ? `${face.AgeRange.Low} - ${face.AgeRange.High} a√±os` : 'N/A';
        const gender = face.Gender ? `${face.Gender.Value} (${Math.round(face.Gender.Confidence)}%)` : 'N/A';
        const smile = face.Smile ? `${face.Smile.Value ? 'S√≠' : 'No'} (${Math.round(face.Smile.Confidence)}%)` : 'N/A';
        
        html += `
          <div style="background:var(--panel2); padding:20px; border-radius:12px; margin-bottom:20px; border-left:4px solid #667eea">
            <h4 style="color:#667eea; margin:0 0 16px; font-size:16px">Rostro ${index + 1}</h4>
            
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:16px; margin-bottom:16px">
              <div>
                <label style="display:block; color:var(--muted); font-size:12px; margin-bottom:4px">Edad estimada:</label>
                <strong style="font-size:14px">${ageRange}</strong>
              </div>
              <div>
                <label style="display:block; color:var(--muted); font-size:12px; margin-bottom:4px">G√©nero:</label>
                <strong style="font-size:14px">${gender}</strong>
              </div>
            </div>
            
            <div style="margin-bottom:16px">
              <label style="display:block; color:var(--muted); font-size:12px; margin-bottom:4px">Confianza:</label>
              <strong style="font-size:14px">${Math.round(face.Confidence || 0)}%</strong>
            </div>
            
            ${face.Emotions && face.Emotions.length > 0 ? `
              <div style="margin-bottom:16px">
                <label style="display:block; color:var(--muted); font-size:12px; margin-bottom:8px">Expresi√≥n:</label>
                <strong style="font-size:14px; color:#667eea">${face.Emotions[0].Type} (${Math.round(face.Emotions[0].Confidence)}%)</strong>
              </div>
              
              <div style="margin-bottom:16px">
                <label style="display:block; color:var(--muted); font-size:12px; margin-bottom:8px">Caracter√≠sticas detectadas:</label>
                <ul style="margin:0; padding-left:20px; font-size:13px">
                  ${face.MouthOpen ? `<li>Boca abierta (${Math.round(face.MouthOpen.Confidence)}%)</li>` : ''}
                  ${face.Smile ? `<li>Sonriendo (${Math.round(face.Smile.Confidence)}%)</li>` : ''}
                  ${face.Eyeglasses ? `<li>Lentes (${Math.round(face.Eyeglasses.Confidence)}%)</li>` : ''}
                  ${face.Sunglasses ? `<li>Lentes de sol (${Math.round(face.Sunglasses.Confidence)}%)</li>` : ''}
                  ${face.Beard ? `<li>Barba (${Math.round(face.Beard.Confidence)}%)</li>` : ''}
                  ${face.Mustache ? `<li>Bigote (${Math.round(face.Mustache.Confidence)}%)</li>` : ''}
                  ${face.EyesOpen ? `<li>Ojos abiertos (${Math.round(face.EyesOpen.Confidence)}%)</li>` : ''}
                </ul>
              </div>
              
              <div>
                <label style="display:block; color:var(--muted); font-size:12px; margin-bottom:8px">Emociones detectadas:</label>
                <div style="display:flex; flex-direction:column; gap:6px">
                  ${face.Emotions.map(emotion => `
                    <div style="display:flex; justify-content:space-between; align-items:center">
                      <span style="font-size:13px">${emotion.Type}</span>
                      <div style="flex:1; margin:0 12px; height:6px; background:var(--line); border-radius:3px; overflow:hidden">
                        <div style="width:${emotion.Confidence}%; height:100%; background:linear-gradient(90deg, #667eea, #764ba2); transition:width 0.3s"></div>
                      </div>
                      <span style="font-size:12px; color:#667eea; font-weight:600">${Math.round(emotion.Confidence)}%</span>
                    </div>
                  `).join('')}
                </div>
              </div>
            ` : ''}
          </div>
        `;
      });
      
      faceAnalysisContent.innerHTML = html;
    });

    (async ()=>{
      const meResp = await fetch(API('/user/me'), { headers:H });
      const meData = await meResp.json();
      const myId = meData?.user?._id || '';
      const uid  = (viewId && viewId!==myId) ? viewId : myId;
      await loadProfilePostsIG(uid);
    })();
  </script>

  <!-- Sistema de Transformaciones -->
  <script src="js/transformations.js"></script>
  <script>
    // Inicializar sistema de transformaciones
    const transformations = new ImageTransformations();
    
    // Conectar el bot√≥n de transformaciones
    document.getElementById('lbTransformations').addEventListener('click', () => {
      if (window.currentPostData) {
        transformations.showTransformations(window.currentPostData);
      }
    });
  </script>

  <!-- Footer -->
  <footer style="text-align:center;padding:16px;margin-top:40px;font-size:0.85rem;color:var(--muted);border-top:1px solid var(--line)">
    ¬© 2025 Proyecto Desarrollo Web - Desarrollado por Dilan Escobar y Andrea Chafolla
  </footer>
</body>
</html>
