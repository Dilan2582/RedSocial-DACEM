<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Perfil ‚Äì DACEM</title>
  <link rel="stylesheet" href="css/profile.css">
</head>
<body>
  <!-- Topbar -->
  <header class="topbar">
  <div class="topbar-inner">
    <div class="brand">DACEM</div>
    <div class="topbar-actions">
      <button id="logoutBtnTop" class="btn danger small">Cerrar sesi√≥n</button>
    </div>
  </div>
</header>


  <div class="wrap">
    <div class="layout">
      <!-- Sidebar -->
      <aside class="sidebar">
        <nav class="nav">
          <a class="nav-item" href="user.html"><span class="nav-ico">üè†</span> Inicio</a>
          <a class="nav-item active" href="profile.html"><span class="nav-ico">üë§</span> Mi perfil</a>
        </nav>
      </aside>

      <!-- Main -->
      <main class="main">
        <!-- Banner -->
        <section class="cover">
          <div id="banner" class="cover-img"></div>
        </section>

        <!-- Header perfil -->
        <section class="head">
          <div class="avatar">
            <img id="avatarImg" class="avatar-img" alt="avatar">
            <div id="avatarTxt" class="avatar-txt">U</div>
          </div>

          <div class="who">
            <div class="name-row">
              <span id="nameTxt" class="name">Perfil</span>
              <span id="verified" class="badge" title="Verificado">‚úî</span>
            </div>
            <div class="username">@<span id="usernameTxt">usuario</span></div>
            <div class="counts">
              <b id="followingCnt">0</b> siguiendo ¬∑
              <b id="followersCnt">0</b> seguidores
            </div>
          </div>

          <div class="actions">
            <button id="btnFollow" class="btn" style="display:none">Seguir</button>
            <button id="btnEdit" class="btn secondary" style="display:none">Editar perfil</button>
          </div>
        </section>

        <!-- Bio -->
        <section class="card">
          <div class="bio" id="bioTxt">NoBioYet</div>
        </section>
      </main>
    </div>
  </div>

  <!-- MODAL EDITAR PERFIL -->
  <div id="editModal" class="backdrop">
    <div class="modal">
      <div class="modal-head">
        <h3>Editar perfil</h3>
        <button class="btn ghost" id="closeEdit">Cerrar</button>
      </div>

      <div class="modal-body">
        <!-- Banner -->
        <div class="banner-edit">
          <div id="bannerPreview" class="banner-preview"></div>
          <input id="bannerFile" type="file" accept="image/*" hidden>
          <button class="btn" id="btnPickBanner">Cambiar banner</button>
        </div>

        <!-- Avatar -->
        <div class="avatar-edit">
          <div class="avatar avatar-xl">
            <img id="avatarPreview" class="avatar-img">
            <div id="avatarPreviewTxt" class="avatar-txt">U</div>
          </div>
          <input id="avatarFile" type="file" accept="image/*" hidden>
          <button class="btn" id="btnPickAvatar">Cambiar foto</button>
        </div>

        <!-- Campos -->
        <div class="form">
          <label>Apodo</label>
          <input id="nicknameInp" placeholder="tuapodo">

          <label>Bio (opcional)</label>
          <textarea id="bioInp" rows="3" maxlength="240" placeholder="Algo sobre ti..."></textarea>
        </div>
      </div>

      <div class="modal-foot">
        <span id="saveMsg" class="muted"></span>
        <button class="btn" id="btnSave">Guardar cambios</button>
      </div>
    </div>
  </div>

  <script>
    // ===== Helpers / API =====
    const API = (p)=>`${location.origin}/api${p}`;
    const token = localStorage.getItem('token');
    if(!token){ location.replace('index.html'); }
    const H  = { 'Authorization':`Bearer ${token}` };
    const JH = { ...H, 'Content-Type':'application/json' };
    const $  = s => document.querySelector(s);
    const qs = new URLSearchParams(location.search);
    const viewId = qs.get('id'); // si existe => perfil p√∫blico

    let me = null; let other = null; let isFollowing = false;

    function displayName(u){ return u.name || `${u.firstName||''} ${u.lastName||''}`.trim() || (u.nickname || 'Usuario'); }
    function initialLetter(u){ return (u.firstName?.[0] || u.name?.[0] || u.nickname?.[0] || 'U').toUpperCase(); }
    function abs(url){ if(!url) return ''; return url.startsWith('http') ? url : `${location.origin}${url.startsWith('/')?url:'/'+url}`; }
    function setAvatarBox(imgEl, txtEl, u){
      if (u.avatar){ imgEl.src = abs(u.avatar); imgEl.style.display='block'; txtEl.style.display='none'; }
      else { imgEl.removeAttribute('src'); imgEl.style.display='none'; txtEl.textContent = initialLetter(u); txtEl.style.display='flex'; }
    }
    function paintProfile(u, counts){
      $('#banner').style.backgroundImage = u.banner ? `url(${abs(u.banner)})` : 'none';
      $('#nameTxt').textContent = displayName(u);
      $('#usernameTxt').textContent = u.nickname || 'usuario';
      $('#followersCnt').textContent = counts?.followers ?? 0;
      $('#followingCnt').textContent = counts?.following ?? 0;
      $('#verified').style.display = u.isVerified ? 'inline' : 'none';
      setAvatarBox($('#avatarImg'), $('#avatarTxt'), u);
      $('#bioTxt').textContent = (u.bio && u.bio.trim()) ? u.bio : 'NoBioYet';

      const main = document.querySelector('.main');
      const hasBanner = !!u.banner;

      if (hasBanner) {
        $('#banner').style.backgroundImage = `url(${abs(u.banner)})`;
        main.classList.add('has-banner');
        main.classList.remove('no-banner');
      } else {
        $('#banner').style.backgroundImage = 'none';
        main.classList.add('no-banner');
        main.classList.remove('has-banner');
  }

    }

    async function loadMe(){
      const r = await fetch(API('/user/me'), { headers:H });
      const d = await r.json();
      if(!d.ok){ localStorage.removeItem('token'); return location.replace('index.html'); }
      me = d.user; return { user:d.user, counts:d.counts };
    }

    async function loadOther(id){
      const r = await fetch(API(`/user/${id}/public`), { headers:H });
      const d = await r.json();
      if(!d.ok) throw new Error(d.message || 'No encontrado');
      other = d.user; isFollowing = !!d.isFollowing;
      return { user:d.user, counts:d.counts };
    }

    // === follow ===
    async function toggleFollow(){
      $('#btnFollow').disabled = true;
      const tryToggle = await fetch(API(`/follow/toggle/${other._id}`), { method:'POST', headers:H });
      if (tryToggle.status !== 404){
        const d = await tryToggle.json(); if (d.ok) isFollowing = !isFollowing;
      }else{
        const r = await fetch(API(`/follow/${other._id}`), { method: isFollowing ? 'DELETE' : 'POST', headers:H });
        const d = await r.json(); if (d.ok) isFollowing = !isFollowing;
      }
      $('#btnFollow').textContent = isFollowing ? 'Dejar de seguir' : 'Seguir';
      $('#btnFollow').disabled = false;
    }

    // === modal edit ===
    const modal = $('#editModal');
    const openModal  = ()=> modal.setAttribute('data-open','true');
    const closeModal = ()=> modal.removeAttribute('data-open');
    $('#closeEdit').onclick = closeModal;

    function prefillEdit(){
      $('#bannerPreview').style.backgroundImage = me.banner ? `url(${abs(me.banner)})` : 'none';
      setAvatarBox($('#avatarPreview'), $('#avatarPreviewTxt'), me);
      $('#nicknameInp').value = me.nickname || '';
      $('#bioInp').value = me.bio || '';
      $('#saveMsg').textContent = '';
    }

    $('#btnPickBanner').onclick = ()=> $('#bannerFile').click();
    $('#btnPickAvatar').onclick = ()=> $('#avatarFile').click();

    $('#bannerFile').addEventListener('change', async (e)=>{
      const f = e.target.files?.[0]; if(!f) return;
      const fd = new FormData(); fd.append('banner', f);
      const r = await fetch(API('/user/me/banner'), { method:'PUT', headers:H, body:fd });
      const d = await r.json();
      if (d.ok){
        $('#bannerPreview').style.backgroundImage = `url(${d.banner})`;
        $('#banner').style.backgroundImage = `url(${d.banner})`;
      }
      e.target.value = '';
    });

    $('#avatarFile').addEventListener('change', async (e)=>{
      const f = e.target.files?.[0]; if(!f) return;
      const fd = new FormData(); fd.append('avatar', f);
      const r = await fetch(API('/user/me/avatar'), { method:'POST', headers:H, body:fd });
      const d = await r.json();
      if (d.ok){ await refreshMe(); }
      e.target.value = '';
    });

    async function refreshMe(){
      const r = await fetch(API('/user/me'), { headers:H });
      const d = await r.json();
      if (d.ok){
        me = d.user;
        paintProfile(me, d.counts);
        prefillEdit();
      }
    }

    $('#btnSave').onclick = async ()=>{
      $('#saveMsg').textContent = 'Guardando...';
      const payload = {
        nickname: $('#nicknameInp').value.trim(),
        bio: $('#bioInp').value.trim()
      };
      const r = await fetch(API('/user/update'), { method:'PUT', headers:JH, body: JSON.stringify(payload) });
      const d = await r.json();
      if (d.ok){
        $('#saveMsg').textContent = 'Guardado';
        await refreshMe();
      } else {
        $('#saveMsg').textContent = d.message || 'Error';
      }
    };

    // === init ===
    (async ()=>{
      const meData = await loadMe();
      const myId = meData.user._id?.toString?.() || meData.user.id || '';

      if (viewId && viewId !== myId){
        // perfil de otro usuario
        const { user, counts } = await loadOther(viewId);
        paintProfile(user, counts);
        $('#btnEdit').style.display = 'none';
        $('#btnFollow').style.display = 'inline-block';
        $('#btnFollow').textContent = isFollowing ? 'Dejar de seguir' : 'Seguir';
        $('#btnFollow').onclick = toggleFollow;
      }else{
        // mi perfil
        paintProfile(meData.user, meData.counts);
        $('#btnFollow').style.display = 'none';
        $('#btnEdit').style.display = 'inline-block';
        $('#btnEdit').onclick = ()=>{ prefillEdit(); openModal(); };
      }
    })();

    // Logout topbar
    document.getElementById('logoutBtnTop')?.addEventListener('click', () => {
    localStorage.removeItem('token');
    localStorage.removeItem('user');
    location.replace('index.html');
  });


  </script>
</body>
</html>
