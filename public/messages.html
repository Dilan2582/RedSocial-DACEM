<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Mensajes – DACEM</title>

  <!-- Fuentes -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">

  <!-- Estilos -->
  <link rel="stylesheet" href="css/profile.css">
  <link rel="stylesheet" href="css/messages.css">

  <!-- Iconos -->
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>

  <!-- Tema inicial (COPIADO de user.html) -->
  <script>
    (function () {
      var saved = localStorage.getItem('theme');
      if(!saved){ saved = matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light'; }
      document.documentElement.setAttribute('data-theme', saved);
    })();
  </script>
</head>
<body>
  <!-- Topbar -->
  <header class="topbar">
    <div class="topbar-inner">
      <div class="brand">
        <span class="logo-badge"><img src="img/Dacem.png" alt="DACEM logo"></span>
        <span>DACEM</span>
      </div>
      <div style="margin-left:auto" class="topbar-actions">
        <!-- MISMO botón que en user.html -->
        <button id="themeToggle" class="btn ghost small" title="Cambiar tema">
          <i class="nav-ico" data-lucide="moon"></i> <span id="themeTxt">Modo oscuro</span>
        </button>
        <button id="logoutBtnTop" class="btn danger small">
          <i class="nav-ico" data-lucide="log-out"></i> Cerrar sesión
        </button>
      </div>
    </div>
  </header>

  <!-- Layout -->
  <div class="wrap">
    <div class="layout">
      <!-- Sidebar -->
      <aside class="sidebar card">
        <nav class="nav">
          <a class="nav-item" href="user.html">
            <i class="nav-ico" data-lucide="home"></i> Inicio
          </a>
          <a class="nav-item active" href="messages.html">
            <i class="nav-ico" data-lucide="message-circle"></i> Mensajes
          </a>
          <a class="nav-item" href="profile.html">
            <i class="nav-ico" data-lucide="user-2"></i> Mi perfil
          </a>
        </nav>
      </aside>

      <!-- Main -->
      <main class="main">
        <div class="messages-container card" style="box-shadow:var(--shadow);">
          <!-- Lista de conversaciones -->
          <aside class="conversations-list" id="conversationsList">
            <div class="conversations-header">
              <div class="conv-head-row">
                <h1>Mensajes</h1>

                <!-- Botón de 3 puntos, a la derecha del título "Mensajes" -->
                <button id="msgOptionsBtn" class="btn ghost small" aria-haspopup="dialog" title="Opciones">
                  …
                </button>
                <!-- Menú contextual -->
                <div id="convMenu" class="menu" hidden>
                  <button id="menuDelete" type="button">Borrar conversaciones</button>
                </div>
              </div>
              <input type="text" class="search-box" id="searchBox" placeholder="Buscar conversación...">
            </div>
            <div class="conversations-body" id="conversationsBody">
              <div class="empty-state">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                  <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                </svg>
                <p>No tienes conversaciones aún</p>
              </div>
            </div>
          </aside>

          <!-- Vista de chat -->
          <section class="chat-view" id="chatView">
            <!-- Encabezado del chat -->
            <div class="chat-header" id="chatHead" style="display:none"></div>

            <!-- Mensajes -->
            <div class="chat-body" id="chatBody">
              <div class="no-chat-selected">
                <section class="empty-state" id="emptyMessages">
                  <img src="/img/mainmes.svg" alt="" class="empty-illustration" aria-hidden="true">
                  <h2 class="empty-title">Tus mensajes</h2>
                  <p class="empty-sub">Selecciona una conversación para empezar a chatear</p>
                </section>
              </div>
            </div>

            <!-- Composer -->
            <footer class="chat-composer" id="chatComposer" style="display:none">
              <textarea id="messageInput" rows="1" class="composer-input" placeholder="Escribe un mensaje..."></textarea>
              <button class="btn-icon ghost glow" id="sendBtn" title="Enviar" type="button">
                <i data-lucide="send"></i>
              </button>
            </footer>
          </section>
        </div>
      </main>
    </div>
  </div>

  <!-- Lightbox -->
  <div class="lightbox" id="lightbox" aria-hidden="true">
    <div class="lb-content" role="dialog" aria-modal="true" aria-label="Publicación">
      <button class="btn ghost small lb-close" id="lbClose"><i class="nav-ico" data-lucide="x"></i></button>
      <div class="lb-media"><img id="lbImg" alt=""></div>
      <aside class="lb-side">
        <header class="lb-head">
          <img id="lbAva" class="lb-ava" alt="">
          <div style="flex:1">
            <div id="lbName" style="font-weight:700"></div>
            <div id="lbUser" class="muted" style="font-size:12px"></div>
          </div>
        </header>
        <div class="lb-body" id="lbComments"></div>
        <div class="lb-actions">
          <button id="lbLike" class="btn-icon" aria-pressed="false" title="Me gusta"><i data-lucide="heart"></i></button>
          <span id="lbLikes" class="act-count">0</span>
          <button id="lbComment" class="btn-icon" title="Comentar"><i data-lucide="message-circle"></i></button>
          <span id="lbCommentsCount" class="act-count">0</span>
          <div class="spacer"></div>
        </div>
        <div class="lb-input">
          <input id="lbInp" placeholder="Añade un comentario…">
          <button id="lbSend" class="btn"><i class="nav-ico" data-lucide="send"></i></button>
        </div>
      </aside>
    </div>
  </div>

  <!-- Modal adjuntar imagen -->
  <div class="lightbox" id="mediaModal" aria-hidden="true">
    <div class="lb-content" role="dialog" aria-modal="true" aria-label="Adjuntar imagen"
         style="grid-template-columns:min(90vw,560px);max-width:560px">
      <div class="lb-side" style="display:flex;flex-direction:column">
        <header class="lb-head" style="gap:8px">
          <strong style="font-size:16px">Adjuntar imagen</strong>
          <div class="spacer"></div>
          <button id="mediaClose" class="btn ghost small"><i data-lucide="x"></i></button>
        </header>

        <div style="padding:12px;border-bottom:1px solid var(--line);display:flex;align-items:center;gap:12px">
          <input id="mediaFile" type="file" accept="image/*" hidden>
          <button id="mediaPick" class="btn ghost small"><i data-lucide="image"></i> Elegir archivo</button>
          <div id="mediaName" class="muted" style="font-size:12px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">Ningún archivo seleccionado</div>
        </div>

        <div id="mediaPreviewWrap" class="lb-body" style="display:none;place-items:center">
          <img id="mediaPreview" alt="" style="max-width:100%;border-radius:12px;">
        </div>

        <div style="padding:12px;border-top:1px solid var(--line);display:grid;gap:8px">
          <textarea id="mediaCaption" rows="2" class="input" placeholder="Escribe un mensaje (opcional)"></textarea>
          <button id="mediaSend" class="btn primary" disabled>Enviar</button>
          <div id="mediaInfo" class="muted" style="font-size:12px"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal borrar conversaciones -->
<div class="lightbox" id="delModal" aria-hidden="true">
  <div class="lb-content" role="dialog" aria-modal="true" aria-label="Borrar conversaciones"
       style="grid-template-columns:min(92vw,560px);max-width:560px">
    <div class="lb-side" style="display:flex;flex-direction:column">
      <header class="lb-head" style="gap:8px">
        <strong style="font-size:16px">Borrar conversaciones</strong>
        <div class="spacer"></div>
        <button id="delCancel" class="btn ghost small">Cancelar</button>
        <button id="delConfirm" class="btn danger small" disabled>Eliminar (<span id="delCount">0</span>)</button>
      </header>

      <div id="delList" class="lb-body" style="padding:12px"></div>
    </div>
  </div>
</div>


  <!-- ===== JS ===== -->
  <script>
    /* ===== Tema (COPIADO tal cual de user.html) ===== */
    const themeBtn = document.getElementById('themeToggle');
    const themeTxt = document.getElementById('themeTxt');
    function applyTheme(t){
      document.documentElement.setAttribute('data-theme', t);
      localStorage.setItem('theme', t);
      const icon = themeBtn?.querySelector('[data-lucide]');
      if(icon) icon.setAttribute('data-lucide', t === 'dark' ? 'sun' : 'moon');
      themeTxt.textContent = t === 'dark' ? 'Modo claro' : 'Modo oscuro';
      if (window.lucide) lucide.createIcons();
    }
    themeBtn?.addEventListener('click', ()=>{
      const current = (document.documentElement.getAttribute('data-theme')||'dark');
      applyTheme(current==='dark' ? 'light' : 'dark');
    });
    (function(){
      const t=document.documentElement.getAttribute('data-theme');
      themeTxt.textContent = t==='dark' ? 'Modo claro' : 'Modo oscuro';
      const icon = themeBtn?.querySelector('[data-lucide]');
      if(icon) icon.setAttribute('data-lucide', t === 'dark' ? 'sun' : 'moon');
    })();

    // Lucide y logout
    window.addEventListener('load', ()=>{ if (window.lucide) lucide.createIcons(); });
    document.getElementById('logoutBtnTop')?.addEventListener('click', ()=>{
      localStorage.removeItem('token'); localStorage.removeItem('user'); location.replace('index.html');
    });
  </script>

  <script src="js/messages.js"></script>
</body>
</html>
